<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Noticias - Etnya</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    /* ====== Layout y estilo igual al resto ====== */
    body { margin:0; font-family:'Inter', sans-serif; background:#cce1d6; color:#444; }
    /* Sidebar */
    .sidebar{
      position:fixed; top:0; left:0; width:200px; height:100vh;
      background:#91586d; padding-top:60px; box-shadow:2px 0 5px rgba(0,0,0,.1); z-index:1000;
    }
    .sidebar a{
      display:block; padding:10px 16px; color:#fff; text-decoration:none; font-weight:bold;
      border-bottom:1px solid rgba(255,255,255,.1); font-size:13px;
    }
    .sidebar a:hover{ background:#6d3e4e; }
    .sidebar a.active{ background:#6d3e4e; }

    /* Header con logo y t√≠tulo centrado (igual patr√≥n) */
    .header-wrap{
      margin-left:200px;
      display:flex; align-items:center; justify-content:center;
      padding:20px 0; transform:translateX(-10px);
    }
    .header-wrap img{ height:60px; margin-right:16px; }
    .header-title{ margin:0; font-size:28px; color:#91586d; }

    /* Contenido principal */
    main{ margin-left:200px; padding:20px; }
    #menuToggle{
      display:none; position:fixed; top:10px; left:10px; z-index:1100;
      background:#91586d; color:#fff; border:none; border-radius:6px; padding:8px 12px; font-size:18px; cursor:pointer;
    }
    @media (max-width:768px){
      #menuToggle{ display:block; }
      .sidebar{ display:none; width:100%; height:auto; position:absolute; top:50px; left:0; }
      .sidebar.mostrar{ display:block; }
      .header-wrap{ margin-left:0; transform:none; }
      main{ margin-left:0; }
    }

    /* Tarjetas/Formulario/Listado (misma est√©tica que gastos/index) */
    .card{
      background:#fff; border-radius:12px; box-shadow:0 1px 6px rgba(0,0,0,.1);
      border:1px solid #eee; padding:16px;
    }
    h2{ margin:0 0 10px; color:#91586d; }
    .muted{ color:#777; font-size:13px; }

    .grid{
      display:grid; grid-template-columns: 1fr 1fr; gap:20px;
    }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }

    label{ display:block; font-weight:600; margin:12px 0 6px; }
    input[type="text"], textarea, select{
      width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:14px; background:#fff;
    }
    textarea{ min-height:120px; resize:vertical; }

    .row2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:560px){ .row2{ grid-template-columns:1fr; } }

    .actions{ display:flex; gap:10px; margin-top:14px; }
    .btn{
      border:none; border-radius:6px; padding:8px 14px; font-size:14px; cursor:pointer; font-weight:600;
      background:#91586d; color:#fff;
    }
    .btn.secondary{ background:#b48a99; }
    .btn.ok{ background:#2ecc71; }
    .btn.danger{ background:#c0392b; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    table{
      width:100%; background:#fff; border-collapse:collapse; border-radius:8px; overflow:hidden;
      box-shadow:0 1px 6px rgba(0,0,0,.08); font-size:14px;
    }
    th, td{ padding:10px; border-bottom:1px solid #eee; text-align:left; vertical-align:top; }
    th{ background:#b48a99; color:#fff; }
    .thumb{ width:52px; height:52px; object-fit:cover; border-radius:6px; border:1px solid #eee; background:#f7f7f7; }
    .pill{ display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; background:#f0f0f0; border:1px solid #e3e3e3; color:#555; }

    /* Modal */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; padding:16px; }
    .modal.active{ display:flex; }
    .modal .card{ width:min(720px,96vw); }

    /* Encabezado Acciones centrado como en otras tablas */
    thead th:last-child{ text-align:center; width:130px; }
    td.acciones{ display:flex; gap:6px; justify-content:center; align-items:center; white-space:nowrap; }
  </style>
</head>
<body>

  <!-- Bot√≥n hamburguesa mobile -->
  <button id="menuToggle" onclick="toggleMenu()">‚ò∞</button>

  <!-- Sidebar -->
  <div class="sidebar">
    <a href="index.html">üìã Alumnas/os</a>
    <a href="pagos.html">üí≥ Pagos</a>
    <a href="gastos.html">üßæ Gastos</a>
    <a href="agenda.html">üìÖ Agenda</a>
    <a href="configuracion.html">‚öôÔ∏è Configuraci√≥n</a>
    <a href="reportes.html" class="menu-reportes">üìà Reportes</a>
    <a href="noticias.html" class="active">üì∞ Noticias</a>
    <button onclick="cerrarSesion()" style="width:100%; text-align:left; padding:10px 16px; background:transparent; border:none; color:#fff; font-weight:bold; font-size:13px; cursor:pointer; border-top:1px solid rgba(255,255,255,.1);">üö™ Cerrar sesi√≥n</button>
  </div>

  <!-- Header -->
  <div class="header-wrap">
    <img src="logo.jpeg" alt="Logo">
    <h1 class="header-title">Noticias</h1>
  </div>

  <!-- Contenido -->
  <main>
    <div class="grid">
      <!-- Formulario -->
      <section class="card">
        <h2>Nueva noticia</h2>
        <div class="muted">Public√° un aviso con t√≠tulo, texto e imagen opcional. Eleg√≠ ‚ÄúTodos‚Äù o sedes espec√≠ficas.</div>

        <label for="titulo">T√≠tulo</label>
        <input id="titulo" type="text" placeholder="Ej: Feriado ‚Äì No hay clases el lunes"/>

        <label for="texto">Texto</label>
        <textarea id="texto" placeholder="Detalle de la noticia..."></textarea>

        <div class="row2">
          <div>
            <label for="destino">Destino</label>
            <select id="destino">
              <option value="todos">Todos</option>
              <option value="sede">Por sede</option>
            </select>
          </div>
          <div>
            <label for="imagen">Imagen (opcional)</label>
            <input id="imagen" type="file" accept="image/*"/>
          </div>
        </div>

        <div id="sedesBox" style="display:none">
          <label for="sedes">Sedes (m√∫ltiple)</label>
          <select id="sedes" multiple>
            <option>Craig Reformer</option>
            <option>Craig Circuito</option>
            <option>Goyena</option>
          </select>
          <div class="muted">Us√° Ctrl/Cmd + clic para seleccionar varias.</div>
        </div>

        <div class="actions">
          <button id="btnCrear" class="btn">Publicar</button>
          <button id="btnLimpiar" class="btn secondary" type="button">Limpiar</button>
        </div>
        <div id="msgForm" class="muted" style="margin-top:8px"></div>
      </section>

      <!-- Listado -->
      <section class="card">
        <div style="display:flex; justify-content:space-between; align-items:center">
          <h2>Publicadas</h2>
          <button id="btnRefrescar" class="btn secondary" type="button">Refrescar</button>
        </div>
        <table id="tabla">
          <thead>
            <tr>
              <th>Imagen</th>
              <th>T√≠tulo</th>
              <th>Texto</th>
              <th>Destino</th>
              <th>Fecha</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="muted" style="margin-top:8px">Se muestran en orden de m√°s recientes.</div>
      </section>
    </div>
  </main>

  <!-- Modal edici√≥n -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="card">
      <h2>Editar noticia</h2>
      <input type="hidden" id="edit_id" />

      <label for="edit_titulo">T√≠tulo</label>
      <input id="edit_titulo" type="text"/>

      <label for="edit_texto">Texto</label>
      <textarea id="edit_texto"></textarea>

      <div class="row2">
        <div>
          <label for="edit_destino">Destino</label>
          <select id="edit_destino">
            <option value="todos">Todos</option>
            <option value="sede">Por sede</option>
          </select>
        </div>
        <div>
          <label for="edit_imagen">Reemplazar imagen (opcional)</label>
          <input id="edit_imagen" type="file" accept="image/*"/>
        </div>
      </div>

      <div id="edit_sedesBox" style="display:none">
        <label for="edit_sedes">Sedes (m√∫ltiple)</label>
        <select id="edit_sedes" multiple>
          <option>Craig Reformer</option>
          <option>Craig Circuito</option>
          <option>Goyena</option>
        </select>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px">
        <button class="btn secondary" type="button" id="btnCerrar">Cancelar</button>
        <button class="btn ok" id="btnGuardar">Guardar</button>
      </div>
      <div id="msgEdit" class="muted" style="margin-top:8px"></div>
    </div>
  </div>

  <script>
    // ===== Seguridad: login/rol como en el resto =====
    (function () {
      if (localStorage.getItem('etnya_login') !== 'ok') { location = 'login.html'; return; }
      const rol = localStorage.getItem('etnya_role') || '';
      // Noticias accesible para admin y operador; si quisieras limitar, ac√°.
      if (rol !== 'admin') {
        // Ocultar secciones solo-admin
        document.querySelectorAll('.menu-reportes').forEach(el => el.style.display='none');
      }
    })();

    function cerrarSesion(){
      localStorage.removeItem('etnya_login');
      localStorage.removeItem('etnya_token');
      localStorage.removeItem('etnya_role');
      location = 'login.html';
    }
    function toggleMenu(){ document.querySelector('.sidebar').classList.toggle('mostrar'); }

    // ===== fetch con token unificado =====
    const nativeFetch = window.fetch.bind(window);
    function fetchConToken(url, opts = {}){
      const token = localStorage.getItem('etnya_token') || '';
      const headers = { ...(opts.headers||{}), Authorization: \`Bearer \${token}\` };
      return nativeFetch(url, { ...opts, headers });
    }
    function ensureJson(res){
      const ct = (res.headers.get('content-type')||'').toLowerCase();
      return ct.includes('application/json');
    }
    async function jsonSeguro(res){
      if (res.status === 401){
        try{ console.warn('401:', await res.text()); }catch(e){}
        alert('Tu sesi√≥n expir√≥. Inici√° sesi√≥n nuevamente.');
        localStorage.removeItem('etnya_login');
        localStorage.removeItem('etnya_token');
        localStorage.removeItem('etnya_role');
        location = 'login.html';
        return null;
      }
      if (ensureJson(res)) return res.json();
      const txt = await res.text();
      if (res.ok) return txt;
      throw new Error(txt || 'Respuesta no JSON del servidor');
    }

    // ===== API =====
    const API = {
      listar:   () => fetchConToken('/noticias'),
      crear:    (fd) => fetchConToken('/noticias', { method:'POST', body: fd }),
      editar:   (id, fd) => fetchConToken('/noticias/'+id, { method:'PUT', body: fd }),
      eliminar: (id) => fetchConToken('/noticias/'+id, { method:'DELETE' })
    };

    // ===== UI refs =====
    const destino = document.getElementById('destino');
    const sedesBox = document.getElementById('sedesBox');
    const sedesSel = document.getElementById('sedes');
    const btnCrear = document.getElementById('btnCrear');
    const btnLimpiar = document.getElementById('btnLimpiar');
    const tablaBody = document.querySelector('#tabla tbody');
    const msgForm = document.getElementById('msgForm');
    const btnRefrescar = document.getElementById('btnRefrescar');

    const modal = document.getElementById('modal');
    const btnCerrar = document.getElementById('btnCerrar');
    const btnGuardar = document.getElementById('btnGuardar');
    const msgEdit = document.getElementById('msgEdit');
    const edit_id = document.getElementById('edit_id');
    const edit_titulo = document.getElementById('edit_titulo');
    const edit_texto = document.getElementById('edit_texto');
    const edit_destino = document.getElementById('edit_destino');
    const edit_sedesBox = document.getElementById('edit_sedesBox');
    const edit_sedes = document.getElementById('edit_sedes');
    const edit_imagen = document.getElementById('edit_imagen');

    function toggleSedes(selectEl, boxEl){
      const val = selectEl.value;
      boxEl.style.display = (val === 'sede') ? 'block' : 'none';
    }
    destino.addEventListener('change', ()=> toggleSedes(destino, sedesBox));
    edit_destino.addEventListener('change', ()=> toggleSedes(edit_destino, edit_sedesBox));

    function getMultiSelectValues(sel){
      return Array.from(sel.selectedOptions).map(o => o.value);
    }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function formatFecha(iso){
      try{ const d=new Date(iso); return d.toLocaleString('es-AR',{timeZone:'America/Argentina/Buenos_Aires'}); }catch(_){ return iso||''; }
    }

    function renderTabla(items){
      tablaBody.innerHTML='';
      if (!items || !items.length){
        tablaBody.innerHTML = '<tr><td colspan="6" class="muted">No hay noticias cargadas.</td></tr>';
        return;
      }
      items.forEach(n=>{
        const tr=document.createElement('tr');
        const sedesTxt = (n.destino==='todos') ? '<span class="pill">Todos</span>' :
          (Array.isArray(n.sedes)&&n.sedes.length ? n.sedes.join(', ') : '‚Äî');
        tr.innerHTML = `
          <td>${n.imagen_url ? `<img class="thumb" src="${n.imagen_url}" alt=""/>` : ''}</td>
          <td><strong>${escapeHtml(n.titulo)}</strong></td>
          <td>${escapeHtml(n.texto)}</td>
          <td>${sedesTxt}</td>
          <td>${formatFecha(n.fecha)}</td>
          <td class="acciones">
            <button class="btn secondary" data-editar="${n.id}">Editar</button>
            <button class="btn danger" data-borrar="${n.id}">Borrar</button>
          </td>`;
        tablaBody.appendChild(tr);
      });
    }

    async function cargar(){
      msgForm.textContent='';
      const r = await API.listar();
      if (!r.ok){ renderTabla([]); msgForm.textContent='No se pudo cargar la lista (¬øtoken vencido?)'; return; }
      const data = await r.json();
      cacheListado = data;
      renderTabla(data);
    }

    btnCrear.addEventListener('click', async ()=>{
      const titulo = document.getElementById('titulo').value.trim();
      const texto  = document.getElementById('texto').value.trim();
      const dest   = destino.value;
      const img    = document.getElementById('imagen').files[0] || null;
      const sedes  = (dest === 'sede') ? getMultiSelectValues(sedesSel) : null;

      if (!titulo || !texto){ msgForm.textContent='Complet√° t√≠tulo y texto.'; return; }
      if (dest==='sede' && (!sedes || sedes.length===0)){ msgForm.textContent='Seleccion√° al menos una sede.'; return; }

      const fd = new FormData();
      fd.append('titulo', titulo);
      fd.append('texto', texto);
      fd.append('destino', dest);
      if (sedes) fd.append('sedes', JSON.stringify(sedes));
      if (img) fd.append('imagen', img);

      btnCrear.disabled=true;
      const r = await API.crear(fd);
      btnCrear.disabled=false;

      if (!r.ok){ const e = await safeErr(r); msgForm.textContent='Error: '+e; return; }
      msgForm.textContent='Publicado ‚úîÔ∏è';
      limpiarForm();
      cargar();
    });

    function limpiarForm(){
      document.getElementById('titulo').value='';
      document.getElementById('texto').value='';
      destino.value='todos';
      document.getElementById('imagen').value='';
      Array.from(sedesSel.options).forEach(o=>o.selected=false);
      toggleSedes(destino, sedesBox);
    }
    document.getElementById('btnLimpiar').addEventListener('click', limpiarForm);

    // Delegaci√≥n acciones tabla
    tablaBody.addEventListener('click', async (ev)=>{
      const editId = ev.target.getAttribute('data-editar');
      const delId  = ev.target.getAttribute('data-borrar');
      if (editId) abrirModalEdicion(editId);
      if (delId){
        if (!confirm('¬øEliminar la noticia?')) return;
        const r = await API.eliminar(delId);
        await jsonSeguro(r);
        if (r.ok) cargar(); else alert('Error al eliminar');
      }
    });

    let cacheListado = [];
    async function abrirModalEdicion(id){
      if (!cacheListado.length){ const r = await API.listar(); cacheListado = r.ok ? await r.json() : []; }
      const n = cacheListado.find(x=>String(x.id)===String(id));
      if (!n){ alert('No se encontr√≥ la noticia'); return; }

      edit_id.value = n.id;
      edit_titulo.value = n.titulo||'';
      edit_texto.value  = n.texto||'';
      edit_destino.value= n.destino||'todos';
      toggleSedes(edit_destino, edit_sedesBox);
      Array.from(edit_sedes.options).forEach(o=> o.selected=(n.sedes||[]).map(s=>s.toLowerCase()).includes(o.value.toLowerCase()));
      edit_imagen.value='';
      msgEdit.textContent='';
      modal.classList.add('active'); modal.setAttribute('aria-hidden','false');
    }
    function cerrarModal(){ modal.classList.remove('active'); modal.setAttribute('aria-hidden','true'); }
    document.getElementById('btnCerrar').addEventListener('click', cerrarModal);

    document.getElementById('btnGuardar').addEventListener('click', async ()=>{
      const id=edit_id.value, tit=edit_titulo.value.trim(), txt=edit_texto.value.trim();
      const dest=edit_destino.value; const img=edit_imagen.files[0]||null;
      const sed=(dest==='sede')? getMultiSelectValues(edit_sedes) : null;

      if (!tit || !txt){ msgEdit.textContent='Complet√° t√≠tulo y texto.'; return; }
      if (dest==='sede' && (!sed || sed.length===0)){ msgEdit.textContent='Seleccion√° al menos una sede.'; return; }

      const fd = new FormData();
      fd.append('titulo', tit); fd.append('texto', txt); fd.append('destino', dest);
      if (sed) fd.append('sedes', JSON.stringify(sed));
      if (img) fd.append('imagen', img);

      btnGuardar.disabled=true;
      const r = await API.editar(id, fd);
      btnGuardar.disabled=false;

      if (!r.ok){ const e = await safeErr(r); msgEdit.textContent='Error: '+e; return; }
      cerrarModal(); cacheListado=[]; cargar();
    });

    async function safeErr(res){ try{ const j=await res.json(); return j.error || JSON.stringify(j); }catch{ return res.status+' '+res.statusText; } }

    // init
    (async function init(){
      toggleSedes(destino, sedesBox);
      await cargar();
      btnRefrescar.addEventListener('click', async ()=>{ cacheListado=[]; await cargar(); });
    })();
  </script>
</body>
</html>
