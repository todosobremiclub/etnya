<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Agenda</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* ====== Base ====== */
    body{margin:0;font-family:'Inter',sans-serif;background:#cce1d6;color:#6d6d6d}
    .sidebar{position:fixed;top:0;left:0;width:200px;height:100vh;background:#91586d;padding-top:60px;box-shadow:2px 0 5px rgba(0,0,0,.1);z-index:1000}
    .sidebar a{display:block;padding:10px 16px;color:#fff;text-decoration:none;font-weight:bold;border-bottom:1px solid rgba(255,255,255,.1);font-size:13px}
    .sidebar a:hover{background:#6d3e4e}
    main{margin-left:200px;padding:16px}
    .header{display:flex;align-items:center;gap:10px;justify-content:center;margin-bottom:16px}
    .header img{height:40px}
    h1{color:#91586d;margin:0 0 12px;text-align:center;font-size:20px}
    #menuToggle{display:none;position:fixed;top:10px;left:10px;z-index:1100;background:#91586d;color:#fff;border:none;border-radius:6px;padding:8px 12px;font-size:18px;cursor:pointer}
    @media (max-width:768px){#menuToggle{display:block}.sidebar{display:none;width:100%;height:auto;position:absolute;top:50px;left:0}.sidebar.mostrar{display:block}main{margin-left:0;padding:10px}.header{flex-direction:column}h1{font-size:18px}}

    /* ====== Controles ====== */
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .sede-tabs{display:flex;gap:6px;flex-wrap:wrap}
    .sede-tabs button,.week-nav button,.actions button{background:#b48a99;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:13px}
    .sede-tabs button.active{background:#91586d}
    .week-nav{display:flex;align-items:center;gap:8px}
    .week-label{font-weight:600;color:#91586d;min-width:160px;text-align:center}
    .legend{margin:8px 0;font-size:12px;color:#6d6d6d;display:flex;gap:12px;justify-content:flex-end}
    .legend i{width:12px;height:12px;border-radius:3px;display:inline-block}
    .i-free{background:#cce1d6;border:1px solid #94b8a3}
    .i-full{background:#ffd5d5;border:1px solid #ff9b9b}

    /* ====== Grilla ====== */
    .agenda-wrap{background:#fff;border-radius:10px;box-shadow:0 1px 6px rgba(0,0,0,.05);overflow:hidden}
    table.agenda{width:100%;border-collapse:collapse;table-layout:fixed}
    .agenda th,.agenda td{border-bottom:1px solid #e0e0e0;border-right:1px solid #e0e0e0;vertical-align:top}
    .agenda th:last-child,.agenda td:last-child{border-right:none}
    .agenda th{background:#b48a99;color:#fff;font-size:13px;position:sticky;top:0;z-index:2;padding:6px}
    .col-hora{width:70px;background:#f7f7f7;font-weight:600;text-align:center;position:sticky;left:0;z-index:1;padding:6px}

    /* ====== Slot √∫nico por hora/d√≠a dividido en dos ====== */
    td.slot{padding:0}
    .slot-inner{
      min-height:110px;
      display:grid;
      grid-template-columns:1fr 1fr;
    }
    .half{
  gap: 8px;
  padding: 6px;
  box-sizing: border-box;
  min-width: 0;          /* clave en grid para que el contenido no desborde */
}
    .half.left{border-right:1px solid #e0e0e0}
  .tag{
  display:block;
  width:100%;
  max-width:100%;
  box-sizing:border-box;
  padding:6px 8px;              /* un poco menos de padding */
  border-radius:10px;
  background:#f3fbf7;
  border:1px solid #94b8a3;
  box-shadow:0 1px 0 rgba(0,0,0,.03);

  /* ‚Äî cambios clave ‚Äî */
  font-size:11px;               /* m√°s chico */
  line-height:1.2;
  white-space:normal;           /* permite salto de l√≠nea */
  overflow:visible;             /* sin recorte */
  text-overflow:clip;           /* sin '...' */
  word-break:break-word;        /* por si un nombre es muy largo */
}

.tag.full{
  background:#ffdede;
  border-color:#ff9b9b;
  text-align:center;
  font-weight:600;
}

/* Estados de asistencia (colores fuertes) */
.tag.estado-asistio     { background:#fff6bf; border-color:#e6d98a; color:#5a5200; } /* amarillo clarito */
.tag.estado-sin-aviso { background:#ffe066; border-color:#e6b800; color:#5a4b00; }
.tag.estado-con-aviso { background:#ffc2d1; border-color:#ff8fa3; color:#6d3e4e; }
.tag.estado-sobre-hora{ background:#b2f2bb; border-color:#63d471; color:#245b2a; }
.tag.is-clickable { cursor: pointer; }
.tag.is-clickable { cursor: pointer; user-select: none; }



    /* ====== Modal ====== */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:1200}
    .modal{width:min(900px,95vw);background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);padding:16px;max-height:90vh;overflow:auto}
    .modal h3{margin:0 0 10px;color:#91586d;text-align:center}
    .modal .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .modal label{font-size:13px;font-weight:600;color:#6d6d6d}
    .modal input[type="text"],.modal input[type="date"],.modal select,.modal textarea{width:100%;padding:8px;border:1px solid #94b8a3;border-radius:6px;background:#f9f9f9;font-size:13px}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{padding:6px 10px;background:#cce1d6;border:1px solid #94b8a3;border-radius:999px;cursor:pointer;font-size:12px;user-select:none}
    .chip.selected{background:#b48a99;border-color:#91586d;color:#fff}
    .modal .footer{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
    .modal .footer button{background:#b48a99;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:13px}
    .switches{display:flex;gap:16px;align-items:center;justify-content:center;margin-bottom:8px}
    @media (max-width:768px){.modal .row{grid-template-columns:1fr}}
  </style>
</head>
<body>
<button id="menuToggle" onclick="document.querySelector('.sidebar').classList.toggle('mostrar')">‚ò∞</button>

<div class="sidebar">
  <a href="index.html">üìã Alumnas/os</a>
  <a href="pagos.html">üí≥ Pagos</a>
  <a href="gastos.html">üßæ Gastos</a>
  <a href="agenda.html">üìÖ Agenda</a>
  <a href="configuracion.html">‚öôÔ∏è Configuraci√≥n</a>
  <a href="reportes.html">üìà Reportes</a>
  <button onclick="localStorage.removeItem('etnya_login');location='login.html'" style="width:100%;text-align:left;padding:10px 16px;background:transparent;border:none;color:#fff;font-weight:bold;font-size:13px;border-top:1px solid rgba(255,255,255,.1);cursor:pointer">üö™ Cerrar sesi√≥n</button>
</div>

<main>
  <div class="header">
    <img src="logo.jpeg" alt="Logo">
    <h1>Agenda de Clases</h1>
  </div>

  <div class="topbar">
    <div class="sede-tabs">
      <button id="tabReformer" class="active" onclick="cambiarSede('Craig Reformer')">Craig Reformer</button>
      <button id="tabCircuito" onclick="cambiarSede('Craig Circuito')">Craig Circuito</button>
      <button id="tabGoyena" onclick="cambiarSede('Pedro Goyena')">Pedro Goyena</button>
    </div>
    <div class="week-nav">
      <button onclick="moverSemana(-1)">‚óÄ</button>
      <div class="week-label" id="labelMes"></div>
      <button onclick="moverSemana(1)">‚ñ∂</button>
    </div>
    <div class="actions">
      <button onclick="abrirModal()">+ Registrar clase</button>
    </div>
  </div>

  

  <div class="agenda-wrap">
    <table class="agenda" id="tablaAgenda"></table>
  </div>
</main>

<!-- ====== Modal Registrar ====== -->
<div class="overlay" id="overlay">
  <div class="modal">
    <h3>Registrar clase</h3>
    <div class="switches">
      <label><input type="checkbox" id="chkUnica" onchange="toggleModo('unica')"> Clase por √∫nica vez</label>
      <label><input type="checkbox" id="chkPrueba" onchange="toggleModo('prueba')"> Clase de prueba</label>
    </div>

    <div class="row">
      <div>
        <label>Buscar alumna/o</label>
        <input type="text" id="buscadorAlumno" placeholder="Ingres√° nombre o n√∫mero" oninput="filtrarAlumnos()">
        <select id="selectAlumno" size="6" style="margin-top:6px;"></select>
      </div>
      <div>
        <label>Sede principal</label>
        <select id="selectSede" onchange="onSedeChange()">
          <option value="">Seleccionar sede...</option>
          <option>Craig Reformer</option>
          <option>Craig Circuito</option>
          <option>Pedro Goyena</option>
        </select>

        <!-- Recurrente -->
        <div id="boxRecurrente" style="margin-top:10px;">
          <label>D√≠as (seg√∫n sede)</label>
          <div class="chips" id="chipsDias"></div>
          <div style="margin-top:10px;">
            <label>Hora para todos los d√≠as</label>
            <select id="selectHoraGeneral"><option value="">Seleccionar hora...</option></select>
          </div>
          <div id="perDia" style="margin-top:10px;"></div>
          <small>Se generar√°n las clases seleccionadas desde la semana visible hasta fin de a√±o.</small>
        </div>

        <!-- Situaci√≥n actual -->
<div id="boxSituacion" style="margin-top:10px;border-top:1px dashed #e0e0e0;padding-top:8px;">
  <label>Situaci√≥n actual (desde la semana visible)</label>
  <div id="situacionActual" class="chips"></div>

<div style="margin-top:8px; display:flex; justify-content:flex-end;">
  <button id="btnEliminarClases"
          style="background:#e57373;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">
    Eliminar todas (desde esta semana)
  </button>
</div>
</div>


        <!-- √önica -->
        <div id="boxUnica" style="display:none;margin-top:10px;">
          <label>Fecha √∫nica</label>
          <input type="date" id="fechaUnica">
          <div style="margin-top:10px;">
            <label>Hora</label>
            <select id="horaUnica"><option value="">Seleccionar hora...</option></select>
          </div>
        </div>

        <!-- Prueba -->
        <div id="boxPrueba" style="display:none;margin-top:10px;">
<div style="margin-top:10px;">
  <label>Nombre (prueba)</label>
  <input type="text" id="nombrePrueba" placeholder="Ingres√° nombre">
</div>
          <label>Motivo/nota de prueba</label>
          <textarea id="notaPrueba" rows="3" placeholder="Escrib√≠ una breve nota..."></textarea>
          <div style="margin-top:10px;" class="row">
            <div>
              <label>Fecha</label>
              <input type="date" id="fechaPrueba">
            </div>
            <div>
              <label>Hora</label>
              <select id="horaPrueba"><option value="">Seleccionar hora...</option></select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <button onclick="cerrarModal()">Cancelar</button>
      <button onclick="guardarClase()">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal detalle de clase -->
<div class="overlay" id="overlayClase">
  <div class="modal">
    <h3>Detalle de clase</h3>
    <div id="claseInfo" style="margin-bottom:10px;color:#6d6d6d;font-size:13px"></div>

    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:8px;">
      <label><input type="checkbox" id="chkAsistio"> Asisti√≥</label>
      <label><input type="checkbox" id="chkSinAviso"> Ausente sin aviso</label>
      <label><input type="checkbox" id="chkConAviso"> Ausente con aviso</label>
      <label><input type="checkbox" id="chkSobreHora"> Ausente sobre la hora</label>
    </div>

    <div class="footer">
  <button onclick="cerrarModalClase()">Cerrar</button>
  <button onclick="guardarEstadoClase()">Guardar</button>
  <button onclick="eliminarClaseSeleccionada()" style="background:#e57373">Eliminar clase</button>
</div>

  </div>
</div>


<script>
  if (localStorage.getItem('etnya_login') !== 'ok') location='login.html';

  const MESES=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const DIAS =['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
  const SEDES={
    'Craig Reformer':{dias:[1,2,3,4,5],desde:9,hasta:20},
    'Craig Circuito':{dias:[1,2,3,4,5],desde:9,hasta:20},
    'Pedro Goyena': {dias:[1,2,3,4,5,6],desde:8,hasta:21}
  };

  let sedeSeleccionada='Craig Reformer';
  let semanaInicio=getLunes(new Date());
  let alumnos=[], clasesSemana=[];

// ===== Utils =====
function getLunes(d){const x=new Date(d);const day=(x.getDay()+6)%7;x.setDate(x.getDate()-day);x.setHours(0,0,0,0);return x}
function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x}
function ymd(d){return d.toISOString().slice(0,10)}
function humanHour(h){return String(h).padStart(2,'0')+':00'} // muestra HH:MM
function rangoHoras(s){const {desde,hasta}=SEDES[s];const a=[];for(let h=desde;h<=hasta;h++)a.push(humanHour(h));return a}
function diasHabilitados(s){return SEDES[s].dias}
// ‚ö†Ô∏è Normalizar: '10:00' -> '10:00:00'

function normTime(t){ return t && t.length===5 ? t+':00' : t; }   // '10:00' -> '10:00:00'
function normDate(d){ return d && d.length>=10 ? d.slice(0,10) : d; } // '2025-08-19T...' -> '2025-08-19'


let clasesAlumnoActual = [];  // clases futuras del alumno seleccionado

function dowNumFromYMD(ymd){
  const d = new Date(ymd + 'T00:00:00');
  const w = d.getDay();      // 0..6  (0=Dom)
  return w === 0 ? 7 : w;    // 1..7  (1=Lun)
}

// clave para comparar patrones (d√≠a de semana + hora + sede)
function groupKey(dow, hora, sede){
  return `${dow}|${normTime(hora)}|${(sede||'').trim()}`;
}

// ===== Header / navegaci√≥n =====
function actualizarHeader(){document.getElementById('labelMes').textContent=MESES[semanaInicio.getMonth()]+' '+semanaInicio.getFullYear()}
function moverSemana(d){semanaInicio=addDays(semanaInicio,7*d);cargarSemana()}
function cambiarSede(s){sedeSeleccionada=s;['tabReformer','tabCircuito','tabGoyena'].forEach(id=>document.getElementById(id).classList.remove('active'));
  if(s==='Craig Reformer')tabReformer.classList.add('active');
  if(s==='Craig Circuito')tabCircuito.classList.add('active');
  if(s==='Pedro Goyena')tabGoyena.classList.add('active');
  cargarSemana()
}

/* ========== Construcci√≥n grilla (1 slot por hora/d√≠a) ========== */
function construirTablaBase(){
  const tabla=document.getElementById('tablaAgenda'); tabla.innerHTML='';
  const thead=document.createElement('thead'); const trh=document.createElement('tr');
  const thHora=document.createElement('th'); thHora.className='col-hora'; thHora.textContent='Hora'; trh.appendChild(thHora);

  const dias=diasHabilitados(sedeSeleccionada); const lunes=semanaInicio;
  for(const dow of dias){
    const fecha=addDays(lunes,dow-1);
    const th=document.createElement('th'); th.dataset.fecha=ymd(fecha);
    th.textContent=`${DIAS[dow]} ${String(fecha.getDate()).padStart(2,'0')}/${String(fecha.getMonth()+1).padStart(2,'0')}`;
    trh.appendChild(th);
  }
  thead.appendChild(trh);

  const tbody=document.createElement('tbody'); const horas=rangoHoras(sedeSeleccionada);
  horas.forEach(hh=>{
    const tr=document.createElement('tr');

    const tdHora=document.createElement('td'); tdHora.className='col-hora'; tdHora.textContent=hh; tr.appendChild(tdHora);

    dias.forEach(dow=>{
      const td=document.createElement('td'); td.className='slot';
      td.dataset.fecha=ymd(addDays(semanaInicio,dow-1));
      td.dataset.hora=normTime(hh); // <-- guardamos con segundos
      td.dataset.sede=sedeSeleccionada;

      td.innerHTML = `<div class="slot-inner">
                        <div class="half left"></div>
                        <div class="half right"></div>
                      </div>`;

td.addEventListener('dblclick', onSlotDblClick);
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  tabla.appendChild(thead); tabla.appendChild(tbody);
}

/* ===== Datos ===== */
async function cargarAlumnos(){
  const res=await fetch('/alumnos'); const data=await res.json();
  alumnos=data.map(a=>({id:a.id,nombre:a.nombre,apellido:a.apellido,numero:a.numero_alumno}));
  poblarListaAlumnos('');
}

function poblarListaAlumnos(f=''){
  const sel=document.getElementById('selectAlumno'); sel.innerHTML='';
  const t=f.trim().toLowerCase(); if(!t) return;
  const list=alumnos.filter(a=>{
    const padded=String(a.numero).padStart(2,'0');
    const label=`${padded} - ${a.apellido||''}, ${a.nombre||''}`.toLowerCase();
    return padded.includes(t)||label.includes(t);
  });
  list.slice(0,200).forEach(a=>{
    const opt=document.createElement('option'); opt.value=a.id;
    const padded=String(a.numero).padStart(2,'0'); opt.textContent=`${padded} - ${a.apellido||''}, ${a.nombre||''}`;
    sel.appendChild(opt);
  });
}
function filtrarAlumnos(){poblarListaAlumnos(document.getElementById('buscadorAlumno').value)}

async function cargarClasesSemana(){
  const desde = ymd(semanaInicio);
  const dias  = diasHabilitados(sedeSeleccionada) || [1,2,3,4,5];
  const hasta = ymd(addDays(semanaInicio, Math.max(...dias)));

  // Construcci√≥n segura de la query
  const params = new URLSearchParams();
  params.set('desde', desde);
  params.set('hasta', hasta);
  params.set('sede', sedeSeleccionada || '');

  const url = `/clases?${params.toString()}`;
  // console.debug('GET', url);

  try{
    const res = await fetch(url);
    if (!res.ok){
      const txt = await res.text().catch(()=> '');
      console.error('GET /clases fallo', res.status, txt);
      clasesSemana = [];
      return;
    }

    const data = await res.json();
    if (!Array.isArray(data)){
      console.warn('GET /clases no devolvi√≥ array:', data);
      clasesSemana = [];
      return;
    }

    clasesSemana = data
      .map(c => ({
        ...c,
        fecha : normDate(c.fecha),
        hora  : normTime(c.hora),
        sede  : (c.sede || '').trim(),
        estado: c.estado || null
      }))
      .filter(c => c.sede === sedeSeleccionada);

  }catch(err){
    console.error('Error de red/parseo en /clases:', err);
    clasesSemana = [];
  }
}

async function cargarSituacionAlumno(alumnoId){
  const cont = document.getElementById('situacionActual');
  if (!alumnoId){
    clasesAlumnoActual = [];
    if (cont) cont.innerHTML = '';
    return;
  }

  const desde = ymd(semanaInicio);
  const fin   = ymd(new Date(semanaInicio.getFullYear(), 11, 31));

  const res  = await fetch(`/clases?alumno_id=${alumnoId}&desde=${desde}&hasta=${fin}`);
  const data = await res.json();

  // normalizar y quedarnos con futuras
  clasesAlumnoActual = (data || [])
    .map(c => ({ ...c, fecha: normDate(c.fecha), hora: normTime(c.hora), sede: (c.sede||'').trim() }))
    .filter(c => c.fecha >= desde);

  // render en chips agrupados por patr√≥n (d√≠a/hora/sede)
  if (!cont) return;
  cont.innerHTML = '';
  if (clasesAlumnoActual.length === 0){
    cont.textContent = 'Sin clases futuras.';
    return;
  }

  const mapa = new Map(); // key: dow|hora|sede  -> cantidad
  for (const c of clasesAlumnoActual){
    const key = `${dowNumFromYMD(c.fecha)}|${c.hora}|${c.sede}`;
    mapa.set(key, (mapa.get(key) || 0) + 1);
  }

  for (const [key, cant] of mapa.entries()){
    const [dow, hora, sede] = key.split('|');
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.textContent = `${DIAS[parseInt(dow,10)]} ${hora.slice(0,5)} ¬∑ ${sede} (${cant})`;
    cont.appendChild(chip);

const btn = document.getElementById('btnEliminarClases');
if (btn){
  const tiene = clasesAlumnoActual.length > 0;
  btn.disabled = !tiene;
  btn.style.opacity = tiene ? '1' : '0.5';
  btn.style.cursor  = tiene ? 'pointer' : 'not-allowed';
}

  }
}

async function eliminarClasesAlumno(){
  const alumno_id = parseInt(selectAlumno.value, 10) || 0;
  if (!alumno_id){ alert('Primero eleg√≠ una/o.'); return; }

  const ids = (clasesAlumnoActual || []).map(c => c.id);
  if (!ids.length){ alert('No hay clases futuras para eliminar.'); return; }

  const ok = confirm(`¬øEliminar ${ids.length} clases asignadas desde esta semana en adelante?`);
  if (!ok) return;

  try{
    let del = await fetch('/clases', {
      method:'DELETE',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ ids })
    });

    // fallback si tu backend expone bulk-delete como POST
    if (del.status === 404){
      del = await fetch('/clases/bulk-delete', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ ids })
      });
    }

    if (!del.ok){
      const t = await del.text();
      throw new Error(t || 'No se pudo borrar');
    }

    await cargarSemana();
    await cargarSituacionAlumno(alumno_id);
    alert('Clases eliminadas');
  } catch(e){
    console.error(e);
    alert('Error al eliminar las clases');
  }
}
// Texto del chip: n√∫mero+nombre (alumno) o nombre de prueba (nota)
function chipText(cl){
  const nombrePrueba = (cl.nota || '').trim();
  // si no hay alumno (prueba), usamos el nombre ingresado
  if ((cl.alumno_id == null || cl.alumno_id === 0) && nombrePrueba) return nombrePrueba;

  const nombre = (cl.nombre || '').trim();
  const num = (cl.numero_alumno != null) ? String(cl.numero_alumno).padStart(2,'0') : '';
  const base = `${num ? num + ' ' : ''}${nombre}`.trim();
  return base || nombrePrueba || 'Prueba';
}


// aplicar clases visuales seg√∫n estado
function applyEstadoClassToTag(tag, estado){
  tag.classList.remove('estado-asistio','estado-sin-aviso','estado-con-aviso','estado-sobre-hora');
  if (!estado) return;
  if (estado==='asistio')     tag.classList.add('estado-asistio');
  if (estado==='sin_aviso')   tag.classList.add('estado-sin-aviso');
  if (estado==='con_aviso')   tag.classList.add('estado-con-aviso');
  if (estado==='sobre_hora')  tag.classList.add('estado-sobre-hora');
}


/* ===== Pintar ===== */
function pintarClases(){
  // limpiar
  document.querySelectorAll('td.slot .left, td.slot .right').forEach(n => n.innerHTML = '');

  // agrupar por fecha|hora|sede
  const mapa = new Map();
  for (const c of clasesSemana){
    const sede = (c.sede || '').trim();
    const key  = `${c.fecha}|${c.hora}|${sede}`;
    if (!mapa.has(key)) mapa.set(key, []);
    mapa.get(key).push(c);
  }

  // render
  document.querySelectorAll('td.slot').forEach(td => {
    const key  = `${td.dataset.fecha}|${normTime(td.dataset.hora)}|${(td.dataset.sede||'').trim()}`;
    const arr  = mapa.get(key) || [];
    const left = td.querySelector('.left');
    const right= td.querySelector('.right');

    arr.forEach((cl, idx) => {
      const tag = document.createElement('div');
      tag.className = 'tag is-clickable';
      tag.textContent = chipText(cl);
      // datos para modal de estado (si ya lo ten√©s)
      tag.dataset.id      = cl.id;
      tag.dataset.estado  = cl.estado || '';
      tag.dataset.nombre  = (cl.nombre || cl.nota || '').trim();
      tag.dataset.numero  = cl.numero_alumno != null ? String(cl.numero_alumno).padStart(2,'0') : '';
      applyEstadoClassToTag(tag, tag.dataset.estado);
      tag.addEventListener('dblclick', onTagDblClick);
      (idx % 2 === 0 ? left : right).appendChild(tag);
    });
  });
}

let claseSelId = null;
let claseSelTag = null;

function onTagDblClick(e){
  e.stopPropagation();
  const tag = e.currentTarget;
  claseSelTag = tag;
  claseSelId  = parseInt(tag.dataset.id, 10) || null;

  const nombre = tag.dataset.nombre || tag.textContent;
  const numero = tag.dataset.numero || '';

  document.getElementById('claseInfo').textContent = `${numero ? numero+' ¬∑ ' : ''}${nombre}`;

  const estado = tag.dataset.estado || '';
  chkAsistio.checked   = (estado === 'asistio');
chkSinAviso.checked  = (estado === 'sin_aviso');
chkConAviso.checked  = (estado === 'con_aviso');
chkSobreHora.checked = (estado === 'sobre_hora');


  overlayClase.style.display = 'flex';
}

function cerrarModalClase(){ overlayClase.style.display = 'none'; }

async function guardarEstadoClase(){
  // √∫nico estado seleccionado (o ninguno para limpiar)
  let estado = '';
  if (chkAsistio.checked)        estado = 'asistio';
  else if (chkSinAviso.checked)  estado = 'sin_aviso';
  else if (chkConAviso.checked)  estado = 'con_aviso';
  else if (chkSobreHora.checked) estado = 'sobre_hora';

  // UI inmediata
  if (claseSelTag){
    claseSelTag.dataset.estado = estado;
    applyEstadoClassToTag(claseSelTag, estado);
  }

  try{
    if (claseSelId){
      // intenta PATCH /clases/:id
      let r = await fetch(`/clases/${claseSelId}`, {
        method: 'PATCH',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ estado: estado || null })
      });

      // fallback POST /clases/estado si el PATCH no existe
      if (!r.ok){
        r = await fetch('/clases/estado', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ id: claseSelId, estado: estado || null })
        });
        if (!r.ok) throw new Error('No se pudo guardar el estado');
      }

      // sincronizar cache local para persistir en repintados/cambios de semana
      const it = clasesSemana.find(c => c.id === claseSelId);
      if (it) it.estado = estado || null;
    }
    cerrarModalClase();
  }catch(err){
    console.error(err);
    alert('No se pudo guardar el estado');

    // rollback visual si fall√≥
    if (claseSelTag){
      const it = clasesSemana.find(c => c.id === claseSelId);
      const prev = it ? (it.estado || '') : '';
      claseSelTag.dataset.estado = prev;
      applyEstadoClassToTag(claseSelTag, prev);
    }
  }
}

// exponer para los botones del modal
window.cerrarModalClase = cerrarModalClase;
window.guardarEstadoClase = guardarEstadoClase;

function onSlotDblClick(e){
  const td = e.currentTarget;
  const fecha = td.dataset.fecha;
  const hora  = normTime(td.dataset.hora);
  const sede  = (td.dataset.sede||'').trim();

  // abrir y preparar modal
  abrirModal();

  // setear sede y reconstruir combos de horas/d√≠as
  selectSede.value = sede;
  onSedeChange(); // llama a refrescarDiasYHoras internamente

  // preseleccionar "√∫nica vez" (pod√©s cambiar a 'prueba' si quer√©s)
  chkUnica.checked = true;
  chkPrueba.checked = false;
  toggleModo('unica');

  // precargar fecha/hora en ambas secciones (por si cambi√°s de modo)
  fechaUnica.value   = fecha;
  horaUnica.value    = hora;
  fechaPrueba.value  = fecha;
  horaPrueba.value   = hora;
}



/* ===== Modal helpers ===== */
function selectedDOWs(){return Array.from(document.querySelectorAll('#chipsDias .chip.selected')).map(ch=>parseInt(ch.dataset.dow,10))}
function applySedeToSelectedDays(){
  const sede=selectSede.value;if(!sede)return;
  selectedDOWs().forEach(d=>{
    const row=[...document.querySelectorAll('#perDia > div')].find(el=>parseInt(el.dataset.dow,10)===d);
    if(row){const selects=row.querySelectorAll('select'); if(selects[1]) selects[1].value=sede;}
  });
}
function applyHoraToSelectedDays(){
  const horaGen = document.getElementById('selectHoraGeneral').value;
  const seleccionados = selectedDOWs();
  if (!horaGen || seleccionados.length === 0) return; // <-- si no hay d√≠as, no hace nada

  seleccionados.forEach(d=>{
    const row = Array.from(document.querySelectorAll('#perDia > div'))
      .find(el => parseInt(el.dataset.dow,10) === d);
    if (!row) return;
    const selHora = row.querySelector('select'); // primer select (hora)
    if (selHora) selHora.value = horaGen;
  });
}
function onSedeChange(){refrescarDiasYHoras();applySedeToSelectedDays();applyHoraToSelectedDays()}

function refrescarDiasYHoras(){
  const sede = selectSede.value, cont = chipsDias, selGen = selectHoraGeneral, perDia = perDiaDiv;

  // reset
  cont.innerHTML = '';
  selGen.innerHTML = '<option value="">Seleccionar hora...</option>';
  perDia.innerHTML = '';

  if (!sede){
    horaUnica.innerHTML  = '<option value="">Seleccionar hora...</option>';
    horaPrueba.innerHTML = '<option value="">Seleccionar hora...</option>';
    return;                    // ‚úÖ cerramos el if ac√°
  }

  // chips de d√≠as
  const dias = diasHabilitados(sede);
  dias.forEach(d=>{
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.dataset.dow = d;
    chip.textContent = DIAS[d];
    chip.onclick = ()=>{
      chip.classList.toggle('selected');
      applySedeToSelectedDays();
      applyHoraToSelectedDays(); // solo aplica si hay d√≠as seleccionados
    };
    cont.appendChild(chip);
  });

  // opciones de hora general
  const horas = rangoHoras(sede);
  horas.forEach(h=>{
    const o = document.createElement('option');
    o.value = normTime(h);
    o.textContent = h;
    selGen.appendChild(o);
  });

  // filas por d√≠a (hora + sede editables)
  dias.forEach(d=>{
    const wrap  = document.createElement('div'); wrap.style.marginTop='6px'; wrap.dataset.dow = d;
    const label = document.createElement('label'); label.textContent = `${DIAS[d]}: `; label.style.marginRight='6px';

    const selHora = document.createElement('select');
    const defH = document.createElement('option'); defH.value=''; defH.textContent='Seleccionar hora...'; selHora.appendChild(defH);
    horas.forEach(h=>{ const o=document.createElement('option'); o.value=normTime(h); o.textContent=h; selHora.appendChild(o); });

    const selSede = document.createElement('select');
    ['Craig Reformer','Craig Circuito','Pedro Goyena'].forEach(s=>{ const o=document.createElement('option'); o.textContent=s; selSede.appendChild(o); });
    selSede.value = sede;

    wrap.appendChild(label);
    wrap.appendChild(selHora);
    wrap.appendChild(document.createTextNode(' '));
    wrap.appendChild(selSede);
    perDia.appendChild(wrap);
  });

  // √önica / Prueba
  horaUnica.innerHTML  = '<option value="">Seleccionar hora...</option>';
  horas.forEach(h=>{ const o=document.createElement('option'); o.value=normTime(h); o.textContent=h; horaUnica.appendChild(o); });
  horaPrueba.innerHTML = '<option value="">Seleccionar hora...</option>';
  horas.forEach(h=>{ const o=document.createElement('option'); o.value=normTime(h); o.textContent=h; horaPrueba.appendChild(o); });

  // Propagar sede a d√≠as seleccionados (si hay)
  applySedeToSelectedDays();

  // Propagar hora general SOLO si hay d√≠as seleccionados
  const hGen = selectHoraGeneral.value;
  if (hGen && selectedDOWs().length) applyHoraToSelectedDays();
}


// Cupo ilimitado: nunca bloquea
function cupoDisponible(fecha, hora, sede){
  return Number.POSITIVE_INFINITY;
}

// Genera todas las fechas (YYYY-MM-DD) desde la semana visible hasta fin de a√±o
// para el d√≠a de la semana indicado (1=Lun ... 7=Dom)
function fechasHastaFinDeAnio(dow){
  const fin = new Date(semanaInicio.getFullYear(), 11, 31);
  let first = addDays(semanaInicio, dow - 1);
  const hoy = new Date(); hoy.setHours(0,0,0,0);
  if (first < hoy) first = addDays(first, 7);

  const out = [];
  for (let d = first; d <= fin; d = addDays(d, 7)) {
    out.push(ymd(d));
  }
  return out;
}


/* ===== Guardar ===== */
function guardarClase(){
  const esUnica  = chkUnica.checked;
  const esPrueba = chkPrueba.checked;

  // alumno_id solo si NO es prueba
  let alumno_id = null;
  if (!esPrueba){
    alumno_id = parseInt(selectAlumno.value, 10);
    if (!alumno_id){ alert('Seleccion√° una alumna/o'); return; }
  }

  let clases = [];

  // === √önica vez ===
  if (esUnica){
    const sede  = selectSede.value; if (!sede){ alert('Seleccion√° una sede'); return; }
    const fecha = fechaUnica.value;
    const hora  = normTime(horaUnica.value);
    if (!fecha || !hora){ alert('Complet√° fecha y hora'); return; }
    clases.push({ fecha, hora, sede });
  }

  // === Clase de PRUEBA (sin alumno, usa nombrePrueba en 'nota') ===
  else if (esPrueba){
    const sede   = selectSede.value; if (!sede){ alert('Seleccion√° una sede'); return; }
    const fecha  = fechaPrueba.value;
    const hora   = normTime(horaPrueba.value);
    const nombre = (document.getElementById('nombrePrueba')?.value || '').trim();
    if (!fecha || !hora){ alert('Complet√° fecha y hora'); return; }
    if (!nombre){ alert('Ingres√° el nombre de la persona'); return; }
    clases.push({ fecha, hora, sede, nota: nombre });
  }

  // === Recurrente (reemplazo inteligente) ===
  else {
    const sedeBase = selectSede.value;
    if (!sedeBase){ alert('Seleccion√° una sede'); return; }

    const seleccionados = selectedDOWs();
    if (seleccionados.length === 0){ alert('Seleccion√° al menos un d√≠a'); return; }

    // 1) patrones nuevos
    const nuevos = [];
    for (const d of seleccionados){
      const row = [...document.querySelectorAll('#perDia > div')].find(el => parseInt(el.dataset.dow,10) === d);
      const selects = row ? row.querySelectorAll('select') : null;
      const hora = normTime(selects && selects[0] ? selects[0].value : '');
      const sede = ((selects && selects[1]) ? selects[1].value : sedeBase).trim();
      if (!hora){ alert('Complet√° la hora para los d√≠as seleccionados'); return; }
      nuevos.push({ dow:d, hora, sede });
    }

    // 2) patrones actuales
    const actualesSet = new Set();
    for (const c of clasesAlumnoActual){
      actualesSet.add(groupKey(dowNumFromYMD(c.fecha), c.hora, c.sede));
    }

    // 3) a eliminar
    const nuevosSet = new Set(nuevos.map(p => groupKey(p.dow, p.hora, p.sede)));
    const patronesAEliminar = [...actualesSet].filter(k => !nuevosSet.has(k));
    const idsAEliminar = clasesAlumnoActual
      .filter(c => patronesAEliminar.includes(groupKey(dowNumFromYMD(c.fecha), c.hora, c.sede)))
      .map(c => c.id);

    // 4) a insertar
    const clasesNuevas = [];
    for (const p of nuevos){
      for (const f of fechasHastaFinDeAnio(p.dow)){
        clasesNuevas.push({ fecha:f, hora:p.hora, sede:p.sede });
      }
    }
    if (clasesNuevas.length===0 && idsAEliminar.length===0){
      alert('No hay cambios para aplicar.'); return;
    }

    // 5) ejecutar
    (async ()=>{
      try{
        if (idsAEliminar.length){
          let del = await fetch('/clases', {
            method:'DELETE',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ ids: idsAEliminar })
          });
          if (del.status === 404){
            del = await fetch('/clases/bulk-delete', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ ids: idsAEliminar })
            });
          }
          if (!del.ok) throw new Error('No se pudieron borrar las clases anteriores');
        }

        if (clasesNuevas.length){
          const res = await fetch('/clases', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ alumno_id, clases: clasesNuevas })
          });
          if (!res.ok) throw new Error('No se pudieron crear las clases nuevas');
        }

        cerrarModal();
        await cargarSemana();
        await cargarSituacionAlumno(alumno_id || 0);
        alert('Cambios aplicados');
      }catch(e){
        console.error(e);
        alert(e.message || 'Error al guardar cambios');
      }
    })();

    return; // no seguir al bloque final
  }

  // === Env√≠o para √önica/Prueba ===
  (async ()=>{
    try{
      const res = await fetch('/clases', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ alumno_id, clases })
      });
      if (!res.ok) throw new Error('Error al guardar');
      cerrarModal();
      await cargarSemana();
      await cargarSituacionAlumno(alumno_id || 0);
      alert('Clases registradas');
    }catch(e){
      console.error(e);
      alert('No se pudo guardar');
    }

async function eliminarClaseSeleccionada(){
  if (!claseSelId){
    alert('No hay una clase seleccionada.'); 
    return;
  }
  const ok = confirm('¬øEliminar esta clase? Esta acci√≥n no se puede deshacer.');
  if (!ok) return;

  try{
    // Intento 1: endpoint por id
    let r = await fetch(`/clases/${claseSelId}`, { method:'DELETE' });

    // Fallback: borra con el endpoint masivo enviando un solo id
    if (r.status === 404){
      r = await fetch('/clases', {
        method:'DELETE',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ ids: [claseSelId] })
      });
    }

    if (!r.ok){
      const t = await r.text();
      throw new Error(t || 'No se pudo eliminar la clase');
    }

    // Actualizar cache local y UI
    clasesSemana = clasesSemana.filter(c => c.id !== claseSelId);
    pintarClases();
    cerrarModalClase();
    alert('Clase eliminada.');
  }catch(err){
    console.error(err);
    alert('Error al eliminar la clase.');
  }
}

// üîπ Esto es lo que faltaba para que el onclick del HTML la vea
window.eliminarClaseSeleccionada = eliminarClaseSeleccionada;


  })();
}

// === Modal (exponer en window para que funcionen los onclick del HTML) ===
window.abrirModal = function (){
  overlay.style.display = 'flex';
  buscadorAlumno.value = '';
  selectAlumno.innerHTML = '';
  chkUnica.checked = false;
  chkPrueba.checked = false;
  boxRecurrente.style.display = '';
  boxUnica.style.display = 'none';
  boxPrueba.style.display = 'none';
  selectSede.value = '';
  refrescarDiasYHoras();
// limpiar/resumir situaci√≥n cuando abr√≠s
const idSel = parseInt(selectAlumno.value, 10) || 0;
cargarSituacionAlumno(idSel);

};

window.cerrarModal = function (){
  overlay.style.display = 'none';
};

window.toggleModo = function (modo){
  if (modo === 'unica'  && chkUnica.checked)  chkPrueba.checked = false;
  if (modo === 'prueba' && chkPrueba.checked) chkUnica.checked = false;

  const unica  = chkUnica.checked;
  const prueba = chkPrueba.checked;
// ocultar/mostrar la columna izquierda (buscador) seg√∫n sea prueba
const colIzq = document.querySelector('.modal .row > div:first-child');
if (colIzq) colIzq.style.display = (prueba ? 'none' : '');


  boxRecurrente.style.display = (!unica && !prueba) ? '' : 'none';
  boxUnica.style.display      = unica  ? '' : 'none';
  boxPrueba.style.display     = prueba ? '' : 'none';

  refrescarDiasYHoras();
};

const btnEliminar = document.getElementById('btnEliminarClases');
if (btnEliminar){
  btnEliminar.addEventListener('click', eliminarClasesAlumno);
}

const np = document.getElementById('nombrePrueba');
if (np) np.value = '';


/* ===== Init ===== */
async function cargarSemana(){actualizarHeader();construirTablaBase();await cargarClasesSemana();pintarClases()}
window.onload=async()=>{await cargarAlumnos(); await cargarSemana()}


  // refs r√°pidas (evita document.getElementById repetido)
  const overlay=document.getElementById('overlay');
  const selectAlumno=document.getElementById('selectAlumno');
  const buscadorAlumno=document.getElementById('buscadorAlumno');
  const chkUnica=document.getElementById('chkUnica');
  const chkPrueba=document.getElementById('chkPrueba');
  const boxRecurrente=document.getElementById('boxRecurrente');
  const boxUnica=document.getElementById('boxUnica');
  const boxPrueba=document.getElementById('boxPrueba');
  const selectSede=document.getElementById('selectSede');
  const selectHoraGeneral=document.getElementById('selectHoraGeneral');
  selectHoraGeneral.addEventListener('change', applyHoraToSelectedDays);
  const chipsDias=document.getElementById('chipsDias');
  const perDiaDiv=document.getElementById('perDia');
  const fechaUnica=document.getElementById('fechaUnica');
  const horaUnica=document.getElementById('horaUnica');
  const fechaPrueba=document.getElementById('fechaPrueba');
  const horaPrueba=document.getElementById('horaPrueba');
  const notaPrueba=document.getElementById('notaPrueba');
  const id = parseInt(selectAlumno.value, 10) || 0;
  cargarSituacionAlumno(id);
// Refs modal de clase
const chkAsistio  = document.getElementById('chkAsistio');
const chkSinAviso  = document.getElementById('chkSinAviso');
const chkConAviso  = document.getElementById('chkConAviso');
const chkSobreHora = document.getElementById('chkSobreHora');

[chkAsistio, chkSinAviso, chkConAviso, chkSobreHora].forEach((chk, _, arr) => {
  chk.addEventListener('change', (e)=>{
    if (!e.target.checked) return;
    arr.forEach(c => { if (c !== e.target) c.checked = false; });
  });
});


	
selectAlumno.addEventListener('change', () => {
  const id = parseInt(selectAlumno.value, 10) || 0;
  cargarSituacionAlumno(id);
});
</script>
</body>
</html>
