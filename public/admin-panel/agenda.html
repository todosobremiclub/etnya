<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Agenda</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
 <style>
  /* ====== Base ====== */
  :root{
    --grid-line: #aeb7b3;          /* líneas normales */
    --grid-strong: #8a9790;        /* separadores fuertes (hora, bordes) */
  }

  body{margin:0;font-family:'Inter',sans-serif;background:#cce1d6;color:#6d6d6d}
  .sidebar{position:fixed;top:0;left:0;width:200px;height:100vh;background:#91586d;padding-top:60px;box-shadow:2px 0 5px rgba(0,0,0,.1);z-index:1000}
  .sidebar a{display:block;padding:10px 16px;color:#fff;text-decoration:none;font-weight:bold;border-bottom:1px solid rgba(255,255,255,.1);font-size:13px}
  .sidebar a:hover{background:#6d3e4e}
  main{margin-left:200px;padding:16px}
  .header{display:flex;align-items:center;gap:10px;justify-content:center;margin-bottom:16px}
  .header img{height:40px}
  h1{color:#91586d;margin:0 0 12px;text-align:center;font-size:20px}

  /* botón hamburguesa (mobile) */
  #menuToggle{display:none;position:fixed;top:10px;left:10px;z-index:1100;background:#91586d;color:#fff;border:none;border-radius:6px;padding:8px 12px;font-size:18px;cursor:pointer}

  /* ====== Controles (topbar en 2 filas) ====== */
  .topbar{
    display:grid;
    grid-template-columns: 1fr auto 1fr; /* izq | centro | der */
    grid-template-areas:
      "tabs week actions"
      "search search .";
    align-items:center;
    gap:10px;
    margin-bottom:12px;
  }
  .sede-tabs{ grid-area:tabs; display:flex; gap:6px; flex-wrap:wrap; }
  .week-nav{  grid-area:week; display:flex; align-items:center; gap:8px; justify-self:center; }
  .actions{   grid-area:actions; display:flex; gap:8px; justify-self:end; align-items:center; }
  .search-wrap{ grid-area:search; position:relative; display:flex; gap:8px; align-items:center; }

  .sede-tabs button,
  .week-nav button,
  .actions button{
    background:#b48a99;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:13px;
  }
  .sede-tabs button.active{background:#91586d}
  .week-label{font-weight:600;color:#91586d;min-width:160px;text-align:center}

  .legend{margin:8px 0;font-size:12px;color:#6d6d6d;display:flex;gap:12px;justify-content:flex-end}
  .legend i{width:12px;height:12px;border-radius:3px;display:inline-block}
  .i-free{background:#cce1d6;border:1px solid #94b8a3}
  .i-full{background:#ffd5d5;border:1px solid #ff9b9b}

  @media (max-width:768px){
    .topbar{
      grid-template-columns: 1fr 1fr;
      grid-template-areas:
        "tabs actions"
        "week week"
        "search search";
    }
  }

  /* ====== Grilla ====== */
  .agenda-wrap{background:#fff;border-radius:10px;box-shadow:0 1px 6px rgba(0,0,0,.05);overflow:hidden}
  table.agenda{width:100%;border-collapse:collapse;table-layout:fixed}
  .agenda th,.agenda td{border-bottom:1px solid var(--grid-line);border-right:1px solid var(--grid-line);vertical-align:top}
  .agenda th:last-child,.agenda td:last-child{border-right:none}
  .agenda th{background:#b48a99;color:#fff;font-size:13px;position:sticky;top:0;z-index:2;padding:6px;border-bottom:2px solid var(--grid-strong)}
  .col-hora{width:70px;background:#f7f7f7;font-weight:600;text-align:center;position:sticky;left:0;z-index:3;padding:6px;border-right:2px solid var(--grid-strong)}
  .agenda tbody tr:last-child td{border-bottom:2px solid var(--grid-strong)}

  /* ====== Slot único por hora/día dividido en dos ====== */
  td.slot{padding:0}
  .slot-inner{min-height:110px;display:grid;grid-template-columns:1fr 1fr}
  .half{gap:8px;padding:6px;box-sizing:border-box;min-width:0}
  .half.left{border-right:1px solid var(--grid-line)}

  .tag{
    display:block;width:100%;max-width:100%;box-sizing:border-box;
    padding:6px 8px;border-radius:10px;background:#f3fbf7;border:1px solid #94b8a3;box-shadow:0 1px 0 rgba(0,0,0,.03);
    font-size:11px;line-height:1.2;white-space:normal;overflow:visible;text-overflow:clip;word-break:break-word;
  }
  .tag.full{background:#ffdede;border-color:#ff9b9b;text-align:center;font-weight:600}
  .tag-prueba{background:#8e44ad;color:#fff}
  .tag-recuperacion{background:#c62828;color:#fff}

  /* Estados de asistencia (colores oficiales) */
  .tag.estado-asistio     { background:#fff6bf; border-color:#e6d98a; color:#5a5200; }
  .tag.estado-sin-aviso   { background:#ffe066; border-color:#e6b800; color:#5a4b00; }
  .tag.estado-con-aviso   { background:#ffc2d1; border-color:#ff8fa3; color:#6d3e4e; }
  .tag.estado-sobre-hora  { background:#b2f2bb; border-color:#63d471; color:#245b2a; }
  .tag.is-clickable{ cursor:pointer; user-select:none; }

  /* ====== Modal ====== */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:1200}
  .modal{width:min(900px,95vw);background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);padding:16px;max-height:90vh;overflow:auto}
  .modal h3{margin:0 0 10px;color:#91586d;text-align:center}
  .modal .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .modal label{font-size:13px;font-weight:600;color:#6d6d6d}
  .modal input[type="text"],.modal input[type="date"],.modal select,.modal textarea{width:100%;padding:8px;border:1px solid #94b8a3;border-radius:6px;background:#f9f9f9;font-size:13px}
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{padding:6px 10px;background:#cce1d6;border:1px solid #94b8a3;border-radius:999px;cursor:pointer;font-size:12px;user-select:none}
  .chip.selected{background:#b48a99;border-color:#91586d;color:#fff}
  .modal .footer{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
  .modal .footer button{background:#b48a99;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:13px}
  .switches{display:flex;gap:16px;align-items:center;justify-content:center;margin-bottom:8px}

  /* ====== Mobile ====== */
  @media (max-width:768px){
    #menuToggle{display:block}
    .sidebar{display:none;width:100%;height:auto;position:absolute;top:50px;left:0}
    .sidebar.mostrar{display:block}
    main{margin-left:0;padding:10px}
    .header{flex-direction:column}
    h1{font-size:18px}
    .modal .row{grid-template-columns:1fr}

    .topbar{
      grid-template-columns:1fr 1fr;
      grid-template-areas:
        "tabs actions"
        "week week"
        "search limpiar";
    }
  }

  /* ====== Mobile agenda tweaks ====== */
  @media (max-width: 768px) {
    .agenda-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    #tablaAgenda { border-collapse: separate; border-spacing: 0; min-width: 900px; }
    #tablaAgenda thead th { position: sticky; top: 0; z-index: 3; background:#b07a8a; color:#fff; }
    #tablaAgenda .col-hora { position: sticky; left: 0; z-index: 4; background:#e9f0ec; min-width:66px; width:66px; }
    #tablaAgenda td.slot, #tablaAgenda th[data-fecha]{ min-width:120px; }
    #tablaAgenda td.slot{ height:68px; }
    #sedeSelector{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }
    #sedeSelector .tile{ padding:8px 10px; font-size:13px; }
    .nav-mes{ display:flex; align-items:center; gap:10px; }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:12px; max-width:110px;
      font-size:12px; line-height:1.2; white-space:nowrap;
      overflow:hidden; text-overflow:ellipsis;
    }
    .chip .numero{ font-weight:600; opacity:.85; }
    .chip.recupero{ background:#7f3f74; color:#fff; }
  }

  /* Encabezado y hora pegados también en desktop + wrapper */
  #tablaAgenda thead th{ position:sticky; top:0; z-index:2; }
  #tablaAgenda .col-hora{ position:sticky; left:0; z-index:3; background:#f5f7f6; }
  .agenda-wrapper{ overflow-x:auto; }

  /* Resaltado del buscador */
  .tag.find-hit{
    outline:3px solid #ff9800;
    box-shadow:0 0 0 3px rgba(255,152,0,.25);
  }

  /* ===== Tooltip (tag/chip) ===== */
  .tag.has-tooltip, .chip.has-tooltip{ position: relative; }
  .tag.has-tooltip::before, .chip.has-tooltip::before{
    content:""; position:absolute; right:2px; top:2px;
    border-width:0 7px 7px 0; border-style:solid;
    border-color:transparent #e57373 transparent transparent;
  }
  .tag.has-tooltip:hover::after, .chip.has-tooltip:hover::after{
    content: attr(data-tooltip);
    position:absolute; left:0; top:100%; transform: translateY(6px);
    background:#333; color:#fff; padding:8px 10px; border-radius:6px;
    box-shadow:0 6px 20px rgba(0,0,0,.2); width:max-content; max-width:300px;
    white-space:normal; z-index:1000;
  }

  /* ===== Menú rápido tipo Excel ===== */
  .quick-menu{position:absolute;display:none;min-width:220px;background:#fff;border:1px solid #ddd;border-radius:8px;
    box-shadow:0 10px 25px rgba(0,0,0,.15);z-index:3000;font-size:13px;overflow:hidden}
  .quick-menu .item{display:flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer}
  .quick-menu .item:hover{background:#f3f4f6}
  .quick-menu .sep{height:1px;background:#eee;margin:2px 0}
  .quick-menu .dot{width:10px;height:10px;border-radius:50%}
  /* Quick menu: colores iguales a los estados */
  .quick-menu .asistio    .dot{ background:#fff6bf; border:1px solid #e6d98a; }
  .quick-menu .sin_aviso  .dot{ background:#ffe066; border:1px solid #e6b800; }
  .quick-menu .con_aviso  .dot{ background:#ffc2d1; border:1px solid #ff8fa3; }
  .quick-menu .sobre_hora .dot{ background:#b2f2bb; border:1px solid #63d471; }

/* === Líneas principales más fuertes (días y horas) === */
table.agenda td.slot{
  border-bottom: 2px solid var(--grid-strong);   /* horizontales entre horas */
}
table.agenda td.slot + td.slot{
  border-left: 2px solid var(--grid-strong);     /* verticales entre días */
}

/* === Línea interna (separación del horario) más suave === */
.half.left{
  border-right: 1px solid var(--grid-line);      /* mantiene la división suave */
}

/* === Grid: intermedias grises claras y bordes gris oscuro === */
:root{
  --grid-line:   #c8c8c8; /* intermedias */
  --grid-border: #4f4f4f; /* bordes/contorno */
}

/* Marco exterior más oscuro */
.agenda-wrap{
  border: 2px solid var(--grid-border);
  border-radius: 10px;        /* mantenemos redondeo */
}

/* Cabecera y última fila con borde oscuro */
table.agenda thead th,
#tablaAgenda thead th{
  border-bottom: 2px solid var(--grid-border);
}
table.agenda tbody tr:last-child td,
#tablaAgenda tbody tr:last-child td{
  border-bottom: 2px solid var(--grid-border);
}

/* Derecha del todo más oscura */
table.agenda tbody td.slot:last-child,
#tablaAgenda tbody td.slot:last-child{
  border-right: 2px solid var(--grid-border);
}

/* Separación columna de hora (borde fuerte) */
table.agenda .col-hora,
#tablaAgenda .col-hora{
  border-right: 2px solid var(--grid-border);
}

/* Líneas internas (entre días y horas) más suaves en gris */
table.agenda td.slot,
#tablaAgenda td.slot{
  border-bottom: 1px solid var(--grid-line);
}
table.agenda td.slot + td.slot,
#tablaAgenda td.slot + td.slot{
  border-left: 1px solid var(--grid-line);
}

/* División interna del slot (izq|der) aún más sutil */
.half.left{
  border-right: 1px solid #d6d6d6;
}

/* Día feriado en la agenda */
td.slot.feriado {
  background-color: #d6d6d6 !important;  /* gris fuerte */
}


/* === Separadores principales con el MISMO borde que los costados === */
table.agenda td.slot,
#tablaAgenda td.slot{
  border-bottom: 2px solid var(--grid-border) !important;   /* entre horas */
}

table.agenda td.slot + td.slot,
#tablaAgenda td.slot + td.slot{
  border-left: 2px solid var(--grid-border) !important;     /* entre días */
}

/* === Divisor interno del horario (mitades) se mantiene suave === */
.half.left{
  border-right: 1px solid var(--grid-line) !important;
}



</style>


</head>
<body>
<button id="menuToggle" onclick="document.querySelector('.sidebar').classList.toggle('mostrar')">☰</button>

<div class="sidebar">
  <a href="index.html">📋 Alumnas/os</a>
  <a href="pagos.html">💳 Pagos</a>
  <a href="gastos.html">🧾 Gastos</a>
  <a href="agenda.html">📅 Agenda</a>
  <a href="configuracion.html">⚙️ Configuración</a>
  <a href="reportes.html">📈 Reportes</a>
  <button onclick="localStorage.removeItem('etnya_login');location='login.html'" style="width:100%;text-align:left;padding:10px 16px;background:transparent;border:none;color:#fff;font-weight:bold;font-size:13px;border-top:1px solid rgba(255,255,255,.1);cursor:pointer">🚪 Cerrar sesión</button>
</div>

<main>
  <div class="header">
    <img src="logo.jpeg" alt="Logo">
    <h1>Agenda de Clases</h1>
  </div>

  <div class="topbar">
    <!-- Izquierda: sedes -->
    <div class="sede-tabs">
      <button id="tabReformer" class="active" onclick="cambiarSede('Craig Reformer')">Craig Reformer</button>
      <button id="tabCircuito" onclick="cambiarSede('Craig Circuito')">Craig Circuito</button>
      <button id="tabGoyena" onclick="cambiarSede('Pedro Goyena')">Pedro Goyena</button>
    </div>

    <!-- Centro: selector de semana -->
    <div class="week-nav">
      <button onclick="moverSemana(-1)">◀</button>
      <div class="week-label" id="labelMes"></div>
      <button onclick="moverSemana(1)">▶</button>
    </div>

    <!-- Derecha: acción -->
    <div class="actions">
      <button type="button" onclick="abrirModal()">+ Registrar clase</button>
    </div>

    <!-- Fila 2: buscador + limpiar juntos -->
    <div class="search-wrap">
      <input id="findAlumnoInput" type="text"
             placeholder="Buscar alumno (nro, apellido, nombre)" style="min-width:260px">
      <select id="findAlumnoSelect" size="6"
              style="display:none;position:absolute;z-index:1300;max-height:220px;overflow:auto;"></select>
      <button id="btnLimpiarFind" type="button">Limpiar selección</button>
    </div>
  </div>

  <!-- Grilla de agenda -->
  <div class="agenda-wrap">
    <div class="agenda-wrapper">
      <table class="agenda" id="tablaAgenda"></table>
    </div>
  </div>
</main>

<!-- ====== Modal Registrar ====== -->
<div class="overlay" id="overlay">
  <div class="modal">
    <h3>Registrar clase</h3>

    <div class="switches">
      <label><input type="checkbox" id="chkUnica"  onchange="toggleModo('unica')"> Clase de Recuperación</label>
      <label><input type="checkbox" id="chkPrueba" onchange="toggleModo('prueba')"> Clase de prueba</label>
    </div>

    <div class="row">
      <!-- IZQUIERDA -->
      <div>
        <label>Buscar alumna/o</label>
        <input type="text" id="buscadorAlumno" placeholder="Ingresá nombre o número" oninput="filtrarAlumnos()">
        <select id="selectAlumno" size="6" style="margin-top:6px;"></select>

        <!-- Datos del alumno (debajo del listado) -->
        <div id="boxDatosAlumno" style="margin-top:8px;border:1px dashed #e0e0e0;border-radius:8px;padding:8px;background:#fafafa">
          <label style="display:block;margin-bottom:4px;">Datos del alumno</label>
          <div id="datosAlumno" style="font-size:13px; line-height:1.35; color:#555"></div>
        </div>
      </div>

      <!-- DERECHA -->
      <div>
        <label>Sede principal</label>
        <select id="selectSede" onchange="onSedeChange()">
          <option value="">Seleccionar sede...</option>
          <option>Craig Reformer</option>
          <option>Craig Circuito</option>
          <option>Pedro Goyena</option>
        </select>

        <!-- Recurrente -->
        <div id="boxRecurrente" style="margin-top:10px;">
          <label>Días (según sede)</label>
          <div class="chips" id="chipsDias"></div>
          <div style="margin-top:10px;">
            <label>Hora para todos los días</label>
            <select id="selectHoraGeneral"><option value="">Seleccionar hora...</option></select>
          </div>
          <div id="perDia" style="margin-top:10px;"></div>
          <small>Se generarán las clases seleccionadas desde la semana visible hasta fin de año.</small>
        </div>

        <!-- Situación actual -->
        <div id="boxSituacion" style="margin-top:10px;border-top:1px dashed #e0e0e0;padding-top:8px;">
          <label>Situación actual (desde la semana visible)</label>
          <div id="situacionActual" class="chips"></div>
          <div style="margin-top:8px; display:flex; justify-content:flex-end;">
            <button id="btnEliminarClases"
                    style="background:#e57373;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">
              Eliminar todas (desde esta semana)
            </button>
          </div>
        </div>

        <!-- Única -->
        <div id="boxUnica" style="display:none;margin-top:10px;">
          <label>Fecha única</label>
          <input type="date" id="fechaUnica">
          <div style="margin-top:10px;">
            <label>Hora</label>
            <select id="horaUnica"><option value="">Seleccionar hora...</option></select>
          </div>
        </div>

        <!-- Prueba -->
        <div id="boxPrueba" style="display:none;margin-top:10px;">
          <div style="margin-top:10px;">
            <label>Nombre (prueba)</label>
            <input type="text" id="nombrePrueba" placeholder="Ingresá nombre">
          </div>
          <label>Observación</label>
          <textarea id="notaPrueba" rows="3" placeholder="Escribí una breve nota..."></textarea>
          <div style="margin-top:10px;" class="row">
            <div>
              <label>Fecha</label>
              <input type="date" id="fechaPrueba">
            </div>
            <div>
              <label>Hora</label>
              <select id="horaPrueba"><option value="">Seleccionar hora...</option></select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <button onclick="cerrarModal()">Cerrar</button>
      <button onclick="guardarClase()">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal detalle de clase -->
<div class="overlay" id="overlayClase">
  <div class="modal">
    <h3>Detalle de clase</h3>
    <div id="claseInfo" style="margin-bottom:10px;color:#6d6d6d;font-size:13px"></div>

    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:8px;">
      <label><input type="checkbox" id="chkAsistio"> Asistió</label>
      <label><input type="checkbox" id="chkSinAviso"> Ausente sin aviso</label>
      <label><input type="checkbox" id="chkConAviso"> Ausente con aviso</label>
      <label><input type="checkbox" id="chkSobreHora"> Ausente sobre la hora</label>
    </div>

  <div class="footer">
  <button onclick="cerrarModalClase()">Cerrar</button>
  <button onclick="guardarEstadoClase()">Guardar</button>
  <button onclick="eliminarClaseSeleccionada()" style="background:#e57373">Eliminar clase</button>
</div>

<div id="detalleObservacion" style="margin-top:10px; width:100%;">
  <label>Observación</label>
  <textarea id="observacionClase" rows="2" style="width:100%;"></textarea>
</div>




  </div>
</div>


<script>
  // ===== Guardia de login =====
  if (localStorage.getItem('etnya_login') !== 'ok') location = 'login.html';

  // ===== Timeout de sesión (6 horas sin actividad) =====
  (function sessionTimeout() {
    const SESSION_TIMEOUT_MS = 6 * 60 * 60 * 1000; // 6h
    const KEY_LOGIN = 'etnya_login';
    const KEY_LAST  = 'etnya_lastActivity';

    const now = () => Date.now();
    const isLogged = () => localStorage.getItem(KEY_LOGIN) === 'ok';
    const setLast = (t = now()) => localStorage.setItem(KEY_LAST, String(t));
    const getLast = () => {
      const v = Number(localStorage.getItem(KEY_LAST));
      return Number.isFinite(v) ? v : 0;
    };
    const expire = () => {
      if (!isLogged()) return; // evitar dobles entre pestañas
      alert('Sesión expirada por inactividad. Volvé a iniciar sesión.');
      localStorage.removeItem(KEY_LOGIN);
      if (!location.pathname.endsWith('/login.html')) location.href = 'login.html';
    };

    // Registrar actividad (throttle para no spamear)
    let throttled = false;
    const markActivity = () => {
      if (document.visibilityState === 'hidden') return;
      if (throttled) return;
      throttled = true;
      setLast();
      setTimeout(() => (throttled = false), 500);
    };
    ['mousemove','mousedown','keydown','scroll','click','touchstart','visibilitychange']
      .forEach(ev => window.addEventListener(ev, markActivity, { passive: true }));

    // Sincronizar entre pestañas
    window.addEventListener('storage', (e) => {
      if (e.key === KEY_LOGIN && e.newValue !== 'ok') expire();
    });

    // Chequeo periódico
    const check = () => {
      if (!isLogged()) return;
      const last = getLast();
      if (!last) return setLast(); // primera actividad de la sesión
      if (now() - last > SESSION_TIMEOUT_MS) expire();
    };
    setInterval(check, 60 * 1000); // cada 1 min
    if (isLogged()) setLast();     // marcar al cargar
  })();

  // ===== App =====
  const MESES=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const DIAS =['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'];
  const SEDES={
    'Craig Reformer':{dias:[1,2,3,4,5],desde:9,hasta:20},
    'Craig Circuito':{dias:[1,2,3,4,5],desde:9,hasta:20},
    'Pedro Goyena': {dias:[1,2,3,4,5,6],desde:8,hasta:21}
  };

  let sedeSeleccionada='Craig Reformer';
  let semanaInicio=getLunes(new Date());
  let alumnos=[], clasesSemana=[];

// ==== VISTAS: Semana / Día ==================================================
let vista = (window.innerWidth <= 768) ? 'dia' : 'semana';

const btnSemana   = document.getElementById('btnSemana');
const btnDia      = document.getElementById('btnDia');
const selectorDia = document.getElementById('selectorDia');

if (btnSemana) btnSemana.onclick = () => { vista = 'semana'; renderAgenda(); };
if (btnDia)    btnDia.onclick    = () => { vista = 'dia';    renderAgenda(); };

// Adaptador: usamos tu render semanal actual
const renderSemana = () => {
  // Si tu función se llama distinto, cambiala acá:
  renderizarAgenda(); // <--- tu función existente para ver la semana
  // preparar selector de días para la vista día
  if (typeof prepararSelectorDia === 'function') {
    prepararSelectorDia(obtenerFechasSemana());
  }
};

function renderAgenda() {
  if (vista === 'dia') {
    if (selectorDia) selectorDia.style.display = 'inline-block';
    renderDia();
  } else {
    if (selectorDia) selectorDia.style.display = 'none';
    renderSemana();
  }
}

// Devuelve array de YYYY-MM-DD de la semana visible, según tus utilidades
function obtenerFechasSemana() {
  const dias = diasHabilitados(sedeSeleccionada);  // ya la usás
  const lunes = semanaInicio;                       // ya lo tenés global
  return dias.map(d => ymd(addDays(lunes, d - 1))); // ya tenés ymd/addDays
}

// Carga el select de día
function prepararSelectorDia(diasSemana) {
  if (!selectorDia) return;
  selectorDia.innerHTML = '';
  diasSemana.forEach(d => {
    const dt = new Date(d);
    const label = dt.toLocaleDateString('es-AR', { weekday: 'short', day: '2-digit', month: '2-digit' });
    const opt = document.createElement('option');
    opt.value = d; opt.textContent = label;
    selectorDia.appendChild(opt);
  });
  selectorDia.onchange = renderDia;
}

// Render de un solo día en formato lista por hora
function renderDia() {
  const cont = document.querySelector('.agenda-wrapper');
  if (!cont) return;

  const diasSemana = obtenerFechasSemana();
  const dia = (selectorDia && selectorDia.value) ? selectorDia.value : diasSemana[0];

  // Filtramos clases de ese día (y sede, si corresponde)
  const clasesDelDia = (window.clasesSemana || []).filter(c => {
    const sedeOK = (sedeSeleccionada === 'Todas') ? true : (String(c.sede || '').trim() === String(sedeSeleccionada).trim());
    return c.fecha === dia && sedeOK;
  });

  // Agrupar por hora normalizada
  const byHora = {};
  for (const c of clasesDelDia) {
    const h = normTime(c.hora);
    (byHora[h] ||= []).push(c);
  }

  // Construir lista
  cont.innerHTML = '';
  const ul = document.createElement('ul');
  ul.style.listStyle = 'none';
  ul.style.padding = '0 12px';

  Object.keys(byHora).sort().forEach(h => {
    const li = document.createElement('li');
    li.style.margin = '10px 0';
    li.style.padding = '10px';
    li.style.background = '#fff';
    li.style.borderRadius = '12px';

    const titulo = document.createElement('div');
    titulo.style.fontWeight = '600';
    titulo.textContent = h;

    const fila = document.createElement('div');
    fila.style.display = 'flex';
    fila.style.flexWrap = 'wrap';
    fila.style.gap = '8px';
    fila.style.marginTop = '8px';

    byHora[h].forEach(c => {
      const chip = document.createElement('span');
      chip.className = 'chip' + (c.recupero ? ' recupero' : '');
      const numero = c.numero || c.numero_alumno || '';
      const nombre = c.nombre || c.alumno_nombre || '';
      chip.innerHTML = `<span class="numero">${numero}</span> ${nombre}`;
      fila.appendChild(chip);
    });

    li.appendChild(titulo);
    li.appendChild(fila);
    ul.appendChild(li);
  });

  cont.appendChild(ul);
}

// Cambiar automáticamente según ancho
window.addEventListener('resize', () => {
  const nueva = (window.innerWidth <= 768) ? 'dia' : 'semana';
  if (nueva !== vista) {
    vista = nueva;
    renderAgenda();
  }
});


// ===== Utils =====
function getLunes(d){const x=new Date(d);const day=(x.getDay()+6)%7;x.setDate(x.getDate()-day);x.setHours(0,0,0,0);return x}
function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x}
function ymd(d){return d.toISOString().slice(0,10)}
function humanHour(h){return String(h).padStart(2,'0')+':00'} // muestra HH:MM
function rangoHoras(s){const {desde,hasta}=SEDES[s];const a=[];for(let h=desde;h<=hasta;h++)a.push(humanHour(h));return a}
function diasHabilitados(s){return SEDES[s].dias}
// ⚠️ Normalizar: '10:00' -> '10:00:00'

function normTime(t){ return t && t.length===5 ? t+':00' : t; }   // '10:00' -> '10:00:00'
function normDate(d){ return d && d.length>=10 ? d.slice(0,10) : d; } // '2025-08-19T...' -> '2025-08-19'

// ===== Datos del alumno (ficha en el modal) =====
function calcularEdad(iso){
  if (!iso) return '';
  const d = new Date(String(iso).slice(0,10));
  if (isNaN(d)) return '';
  const hoy = new Date();
  let e = hoy.getFullYear() - d.getFullYear();
  const m = hoy.getMonth() - d.getMonth();
  if (m < 0 || (m === 0 && hoy.getDate() < d.getDate())) e--;
  return e;
}

function renderDatosAlumno(alumnoId){
  const box = document.getElementById('datosAlumno');
  if (!box){ return; }
  if (!alumnoId){ box.innerHTML = ''; return; }

  // usar el array real; si por algún motivo está vacío, caemos al global auxiliar
  const list = (alumnos && alumnos.length) ? alumnos : (window.alumnosGlobal || []);
  const a = list.find(x => Number(x.id) === Number(alumnoId));
  if (!a){ box.innerHTML = ''; return; }

  const edad = calcularEdad(a.fecha_nacimiento);
  const num  = (a.numero != null)
    ? (String(a.numero).includes('-') ? String(a.numero) : String(a.numero).padStart(2,'0'))
    : '';

  box.innerHTML = `
    <div><b>N° socio:</b> ${num || '-'}</div>
    <div><b>Apellido:</b> ${a.apellido || '-'}</div>
    <div><b>Nombre:</b> ${a.nombre || '-'}</div>
    <div><b>Teléfono:</b> ${a.telefono || '-'}</div>
    <div><b>Edad:</b> ${edad ? edad + ' años' : '-'}</div>
    <div><b>Sede:</b> ${a.sede || '-'}</div>
    <div><b>Modalidad:</b> ${a.modalidad || '-'}</div>
  `;
}



let clasesAlumnoActual = [];  // clases futuras del alumno seleccionado

function dowNumFromYMD(ymd){
  const d = new Date(ymd + 'T00:00:00');
  const w = d.getDay();      // 0..6  (0=Dom)
  return w === 0 ? 7 : w;    // 1..7  (1=Lun)
}

// clave para comparar patrones (día de semana + hora + sede)
function groupKey(dow, hora, sede){
  return `${dow}|${normTime(hora)}|${(sede||'').trim()}`;
}

// ===== Header / navegación =====
function actualizarHeader(){document.getElementById('labelMes').textContent=MESES[semanaInicio.getMonth()]+' '+semanaInicio.getFullYear()}
function moverSemana(d){semanaInicio=addDays(semanaInicio,7*d);cargarSemana()}
function cambiarSede(s){sedeSeleccionada=s;['tabReformer','tabCircuito','tabGoyena'].forEach(id=>document.getElementById(id).classList.remove('active'));
  if(s==='Craig Reformer')tabReformer.classList.add('active');
  if(s==='Craig Circuito')tabCircuito.classList.add('active');
  if(s==='Pedro Goyena')tabGoyena.classList.add('active');
  cargarSemana()
}

/* ========== Construcción grilla (1 slot por hora/día) ========== */
function construirTablaBase(){
  // Asegurar que exista la tabla dentro de .agenda-wrapper
  let tabla = document.getElementById('tablaAgenda');
  if (!tabla) {
    const wrap = document.querySelector('.agenda-wrapper');
    if (!wrap) return;                          // si no existe el contenedor, salgo
    wrap.innerHTML = '';
    tabla = document.createElement('table');
    tabla.id = 'tablaAgenda';
    tabla.className = 'agenda';
    wrap.appendChild(tabla);
  } else {
    tabla.innerHTML = '';
  }

  // THEAD
  const thead = document.createElement('thead');
  const trh = document.createElement('tr');

  const thHora = document.createElement('th');
  thHora.className = 'col-hora';
  thHora.textContent = 'Hora';
  trh.appendChild(thHora);

  const dias = diasHabilitados(sedeSeleccionada);
  const lunes = semanaInicio;

  for (const dow of dias){
    const fecha = addDays(lunes, dow - 1);
    const th = document.createElement('th');
    th.dataset.fecha = ymd(fecha);
    th.textContent = `${DIAS[dow]} ${String(fecha.getDate()).padStart(2,'0')}/${String(fecha.getMonth()+1).padStart(2,'0')}`;
    trh.appendChild(th);
  }
  thead.appendChild(trh);

  // TBODY
  const tbody = document.createElement('tbody');
  const horas = rangoHoras(sedeSeleccionada);

  horas.forEach(hh => {
    const tr = document.createElement('tr');

    const tdHora = document.createElement('td');
    tdHora.className = 'col-hora';
    tdHora.textContent = hh;
    tr.appendChild(tdHora);

    dias.forEach(dow => {
      const td = document.createElement('td');
      td.className = 'slot';
      td.dataset.fecha = ymd(addDays(semanaInicio, dow - 1));
      td.dataset.hora  = normTime(hh);      // guardamos con segundos
      td.dataset.sede  = sedeSeleccionada;

      td.innerHTML = `
        <div class="slot-inner">
          <div class="half left"></div>
          <div class="half right"></div>
        </div>
      `;

      td.addEventListener('dblclick', onSlotDblClick);
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  tabla.appendChild(thead);
  tabla.appendChild(tbody);
}

/* ===== Datos ===== */
async function cargarAlumnos(){
  const res = await fetch('/alumnos');
  const data = await res.json();
  alumnos = data.map(a => ({
    id: a.id,
    numero: a.numero_alumno,
    nombre: a.nombre,
    apellido: a.apellido,
    telefono: a.telefono || a.celular || '',
    fecha_nacimiento: a.fecha_nacimiento || a.nacimiento || '',
    sede: a.sede || '',
    modalidad: a.modalidad || a.tipo_clase || a.modalidad_nombre || ''
  }));
  window.alumnosGlobal = alumnos;   // 👈 útil para otras funciones
  poblarListaAlumnos('');
  buildIdxAlumnos();
}

function poblarListaAlumnos(f=''){
  const sel = document.getElementById('selectAlumno');
  sel.innerHTML = '';
  const t = (f || '').trim().toLowerCase();
  if (!t) return;

  const list = alumnos.filter(a => {
    const rawNum = String(a.numero || '').trim();
    const numVis = rawNum.includes('-') ? rawNum : String(rawNum).padStart(2,'0');
    const label  = `${numVis} - ${a.apellido||''}, ${a.nombre||''}`.toLowerCase();
    return numVis.toLowerCase().includes(t) || label.includes(t);
  });

  list.slice(0, 200).forEach(a => {
    const opt = document.createElement('option');
    opt.value = a.id;
    const rawNum = String(a.numero || '').trim();
    const numVis = rawNum.includes('-') ? rawNum : String(rawNum).padStart(2,'0');
    opt.textContent = `${numVis} - ${a.apellido||''}, ${a.nombre||''}`;
    sel.appendChild(opt);
  });

  // ⤵️ si hay resultados: elegir primero y renderizar ficha + situación
  if (sel.options.length > 0){
    sel.selectedIndex = 0;
    const id = Number(sel.value) || 0;
    renderDatosAlumno(id);
    cargarSituacionAlumno(id);
  }
}
function filtrarAlumnos(){poblarListaAlumnos(document.getElementById('buscadorAlumno').value)}

async function cargarClasesSemana(){
  const desde = ymd(semanaInicio);
  const dias  = diasHabilitados(sedeSeleccionada) || [1,2,3,4,5];
  const hasta = ymd(addDays(semanaInicio, Math.max(...dias)));

  const params = new URLSearchParams();
  params.set('desde', desde);
  params.set('hasta', hasta);
  params.set('sede', sedeSeleccionada || '');

  const url = `/clases?${params.toString()}`;

  try{
    const res = await fetch(url);
    if (!res.ok){
      const txt = await res.text().catch(()=> '');
      console.error('GET /clases fallo', res.status, txt);
      clasesSemana = [];
      return;
    }

    const data = await res.json();
    if (!Array.isArray(data)){
      console.warn('GET /clases no devolvió array:', data);
      clasesSemana = [];
      return;
    }

   clasesSemana = data.map(c => ({
  ...c,
  fecha  : normDate(c.fecha),
  hora   : normTime(c.hora),
  sede   : (c.sede || '').trim(),
  estado : c.estado || null,
  alumno_id : c.alumno_id ?? null,
  nota       : (c.nota || '').trim(),
  observacion: (c.observacion || c.obs || c.motivo || '').trim(), // 👈 agregado
  tipo   : c.tipo ?? (
            c.es_prueba ? 'prueba' :
            (c.es_recuperacion || c.unica_vez || c.recuperacion ? 'recuperacion' : null)
          )
})).filter(c => c.sede === sedeSeleccionada);



  }catch(err){
    console.error('Error de red/parseo en /clases:', err);
    clasesSemana = [];
  }
}

// ---- Bloqueos "no clases" para Agenda ----
let noClases = [];

function dowFromYMD(ymd){
  const d = new Date(String(ymd).slice(0,10) + 'T00:00:00');
  const w = d.getDay();         // 0=Dom..6=Sáb
  return w === 0 ? 7 : w;       // 1=Lun..7=Dom
}

async function cargarNoClases() {
  try {
    const res = await fetch('/no-clases');
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();
    noClases = data.map(r => ({
      sede: String(r.sede || '').trim(),
      dow : Number(r.dow || 0),
      hora: normTime(r.hora) // normaliza 'HH:MM' -> 'HH:MM:SS'
    }));
  } catch (e) {
    console.error('Error /no-clases', e);
    noClases = [];
  }
}


async function cargarSituacionAlumno(alumnoId){
  const cont = document.getElementById('situacionActual');

  // Sin selección: limpiar todo
  if (!alumnoId){
    clasesAlumnoActual = [];
    if (cont) cont.innerHTML = '';
    const btn0 = document.getElementById('btnEliminarClases');
    if (btn0){
      btn0.disabled = true;
      btn0.style.opacity = '0.5';
      btn0.style.cursor  = 'not-allowed';
    }
    if (typeof renderDatosAlumno === 'function') renderDatosAlumno(0);
    return;
  }

  // Mostrar ficha del alumno (número, apellido, etc.)
  if (typeof renderDatosAlumno === 'function') renderDatosAlumno(alumnoId);

  const desde = ymd(semanaInicio);
  const fin   = ymd(new Date(semanaInicio.getFullYear(), 11, 31));

  try{
    const res = await fetch(`/clases?alumno_id=${alumnoId}&desde=${desde}&hasta=${fin}`);
    if (!res.ok){
      console.error('GET /clases fallo', res.status, await res.text().catch(()=> ''));
      clasesAlumnoActual = [];
    } else {
      const data = await res.json();
      clasesAlumnoActual = (Array.isArray(data) ? data : [])
        .map(c => ({
          ...c,
          fecha: normDate(c.fecha),
          hora : normTime(c.hora),
          sede : (c.sede || '').trim()
        }))
        .filter(c => c.fecha >= desde);
    }
  } catch(err){
    console.error('Error cargando clases del alumno:', err);
    clasesAlumnoActual = [];
  }

  // Render de chips agrupados por patrón (día/hora/sede)
  if (!cont) return;
  cont.innerHTML = '';

  if (clasesAlumnoActual.length === 0){
    cont.textContent = 'Sin clases futuras.';
  } else {
    const mapa = new Map(); // key: dow|hora|sede -> count
    for (const c of clasesAlumnoActual){
      const key = `${dowNumFromYMD(c.fecha)}|${c.hora}|${c.sede}`;
      mapa.set(key, (mapa.get(key) || 0) + 1);
    }
    for (const [key, cant] of mapa.entries()){
      const [dow, hora, sede] = key.split('|');
      const chip = document.createElement('div');
      chip.className = 'chip';
      chip.textContent = `${DIAS[parseInt(dow,10)]} ${hora.slice(0,5)} · ${sede} (${cant})`;
      cont.appendChild(chip);
    }
  }

  // Estado del botón "Eliminar todas"
  const btn = document.getElementById('btnEliminarClases');
  if (btn){
    const tiene = clasesAlumnoActual.length > 0;
    btn.disabled = !tiene;
    btn.style.opacity = tiene ? '1' : '0.5';
    btn.style.cursor  = tiene ? 'pointer' : 'not-allowed';
  }
}


async function eliminarClasesAlumno(){
  const alumno_id = parseInt(selectAlumno.value, 10) || 0;
  if (!alumno_id){ alert('Primero elegí una/o.'); return; }

  const ids = (clasesAlumnoActual || []).map(c => c.id);
  if (!ids.length){ alert('No hay clases futuras para eliminar.'); return; }

  const ok = confirm(`¿Eliminar ${ids.length} clases asignadas desde esta semana en adelante?`);
  if (!ok) return;

  try{
    let del = await fetch('/clases', {
      method:'DELETE',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ ids })
    });

    // fallback si tu backend expone bulk-delete como POST
    if (del.status === 404){
      del = await fetch('/clases/bulk-delete', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ ids })
      });
    }

    if (!del.ok){
      const t = await del.text();
      throw new Error(t || 'No se pudo borrar');
    }

    await cargarSemana();
    await cargarSituacionAlumno(alumno_id);
    alert('Clases eliminadas');
  } catch(e){
    console.error(e);
    alert('Error al eliminar las clases');
  }
}
// Texto del chip: número+nombre (alumno) o nombre de prueba (nota)
function chipText(cl){
  const nombrePrueba = (cl.nota || '').trim();
  if ((cl.alumno_id == null || cl.alumno_id === 0) && nombrePrueba) return nombrePrueba;

  const nombre = (cl.nombre || '').trim();

  // ✅ usar numero_alumno tal cual si ya trae sede (02-C, 149-G, 225-CR)
  let numTxt = '';
  if (cl.numero_alumno != null) {
    const raw = String(cl.numero_alumno).trim();
    numTxt = raw.includes('-') ? raw : String(raw).padStart(2,'0'); // si es solo número, pad a 2
  }

  const base = `${numTxt ? numTxt + ' ' : ''}${nombre}`.trim();
  return base || nombrePrueba || 'Prueba';
}


// aplicar clases visuales según estado
function applyEstadoClassToTag(tag, estado){
  tag.classList.remove('estado-asistio','estado-sin-aviso','estado-con-aviso','estado-sobre-hora');
  if (!estado) return;
  if (estado==='asistio')     tag.classList.add('estado-asistio');
  if (estado==='sin_aviso')   tag.classList.add('estado-sin-aviso');
  if (estado==='con_aviso')   tag.classList.add('estado-con-aviso');
  if (estado==='sobre_hora')  tag.classList.add('estado-sobre-hora');
}

let quickMenu=null, quickMenuTarget=null;

function initQuickMenu(){
  if (quickMenu) return;
  quickMenu = document.createElement('div');
  quickMenu.id = 'quickMenu';
  quickMenu.className = 'quick-menu';
  quickMenu.innerHTML = `
    <div class="item asistio"    data-estado="asistio"><span class="dot"></span>Asistió</div>
    <div class="item sin_aviso"  data-estado="sin_aviso"><span class="dot"></span>Ausente sin aviso</div>
    <div class="item con_aviso"  data-estado="con_aviso"><span class="dot"></span>Ausente con aviso</div>
    <div class="item sobre_hora" data-estado="sobre_hora"><span class="dot"></span>Ausente sobre la hora</div>
    <div class="sep"></div>
    <div class="item" data-estado="">Limpiar estado</div>
  `;
  document.body.appendChild(quickMenu);

  quickMenu.addEventListener('click', async (e)=>{
  const it = e.target.closest('.item'); if (!it) return;
  const estado = it.dataset.estado ?? '';

  if (quickMenuTarget){
    // 1) actualizar dataset
    quickMenuTarget.dataset.estado = estado;

    // 2) SIEMPRE limpiar/aplicar clases de estado
    applyEstadoClassToTag(quickMenuTarget, estado);

    // 3) si quedó sin estado, volver al color por tipo (normal/prueba/recuperación)
    if (!estado) applyTipoColorToTag(quickMenuTarget);

    // 4) cache y persistencia
    const id = parseInt(quickMenuTarget.dataset.id,10) || 0;
    const row = clasesSemana.find(c => c.id === id);
    if (row) row.estado = estado || null;

    if (id){
      try{
        const r = await fetch(`/clases/${id}`,{
          method:'PATCH',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ estado: estado || null })
        });
        if (!r.ok) console.error('PATCH estado falló', await r.text());
      }catch(err){ console.error(err); }
    }
  }
  closeQuickMenu();
});


  // cerrar si clic fuera / scroll / resize / ESC
  document.addEventListener('click',(ev)=>{
    if (quickMenu && quickMenu.style.display==='block'){
      if (!quickMenu.contains(ev.target)) closeQuickMenu();
    }
  }, true);
  window.addEventListener('scroll', closeQuickMenu, true);
  window.addEventListener('resize', closeQuickMenu, true);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeQuickMenu(); });
}

function openQuickMenu(target){
  initQuickMenu();
  quickMenuTarget = target;
  quickMenu.style.display = 'block';
  // posicionar debajo del tag
  const r = target.getBoundingClientRect();
  const left = Math.min(r.left + window.scrollX, window.scrollX + document.documentElement.clientWidth - 240);
  const top  = r.bottom + window.scrollY + 6;
  quickMenu.style.left = left + 'px';
  quickMenu.style.top  = top  + 'px';
}

function closeQuickMenu(){
  if (quickMenu) quickMenu.style.display='none';
  quickMenuTarget = null;
}

/* Aplica color por tipo sólo cuando NO hay estado */
function applyTipoColorToTag(tag){
  const tipo = (tag.dataset.tipo || '').toLowerCase();
  tag.classList.remove('is-primary','is-link','is-info','is-success','is-warning','is-danger','tag-prueba','tag-recuperacion');
  tag.style.removeProperty('background-color');
  tag.style.removeProperty('color');

  if (tipo === 'prueba'){
    tag.classList.add('tag-prueba');
    tag.style.setProperty('background-color', '#8e44ad', 'important');
    tag.style.setProperty('color', '#fff', 'important');
  } else if (tipo === 'recuperacion'){
    tag.classList.add('tag-recuperacion');
    tag.style.setProperty('background-color', '#c62828', 'important');
    tag.style.setProperty('color', '#fff', 'important');
  }
}

/* Click en un tag: abrir menú rápido */
function onTagClick(e){
  e.stopPropagation();
  openQuickMenu(e.currentTarget);
}


/* ===== Pintar ===== */
function pintarClases(){
  // limpiar chips
  document.querySelectorAll('td.slot .left, td.slot .right').forEach(n => n.innerHTML = '');

  // feriados a Set
  const feriadosSet = new Set(Array.isArray(feriados) ? feriados.map(f => String(f).slice(0,10)) : []);

  // agrupar clases por (fecha|hora|sede)
  const mapa = new Map();
  for (const c of (clasesSemana || [])){
    const sede  = (c.sede || '').trim();
    const fecha = String(c.fecha).slice(0,10);
    const hora  = normTime(c.hora); // HH:MM:SS
    const key   = `${fecha}|${hora}|${sede}`;
    if (!mapa.has(key)) mapa.set(key, []);
    mapa.get(key).push({ ...c, hora });
  }

  // helper sede activa por si la celda no trae data-sede
  const sedeActiva =
    (window.sedeActiva || window.sedeSel || window.sede || '').toString().trim() ||
    (document.querySelector('.sedes .is-selected, .sedes .selected')?.textContent || '').trim();

  // recorrer celdas
  document.querySelectorAll('td.slot').forEach(td => {
    // claves de la celda
    const fechaTd = String(td.dataset.fecha || '').slice(0,10);
    const horaTd  = normTime(String(td.dataset.hora || ''));         // HH:MM:SS
    const sedeTd  = String(td.dataset.sede || sedeActiva || '').trim();
    const dowTd   = typeof dowFromYMD === 'function' ? dowFromYMD(fechaTd) : null;

    // reset fondo
    td.classList.remove('feriado');

    // feriado (todo el día)
    if (feriadosSet.has(fechaTd)) {
      td.classList.add('feriado');
    } else {
      // bloque no-clases (solo ese slot)
      const arrBloques = Array.isArray(noClases) ? noClases : [];
      const bloqueado = arrBloques.some(nc => {
        const sameHora  = normTime(nc.hora) === horaTd;      // normaliza HH:MM -> HH:MM:SS
        const sameDow   = Number(nc.dow) === Number(dowTd);
        const sameSede  = sedeTd ? (String(nc.sede||'').trim() === sedeTd) : true; // si no hay sede en la celda, matchea por hora+dow
        return sameHora && sameDow && sameSede;
      });
      if (bloqueado) td.classList.add('feriado');
    }

    // chips de clases
    const key   = `${fechaTd}|${horaTd}|${sedeTd}`;
    const arr   = mapa.get(key) || [];
    const left  = td.querySelector('.left');
    const right = td.querySelector('.right');

    arr.forEach((cl, idx) => {
      const tag = document.createElement('div');
      tag.className = 'tag is-clickable';
      tag.textContent = chipText(cl);

      // datasets
      tag.dataset.id       = (cl.id != null) ? String(cl.id) : '';
      tag.dataset.estado   = cl.estado || '';
      tag.dataset.nombre   = ((cl.nombre || cl.nota || '') + '').trim();
      tag.dataset.numero   = (cl.numero_alumno != null) ? String(cl.numero_alumno).padStart(2,'0') : '';
      tag.dataset.alumnoId = (cl.alumno_id != null) ? String(cl.alumno_id) : '';
      tag.dataset.fecha    = cl.fecha || '';
      tag.dataset.hora     = cl.hora  || '';
      tag.dataset.sede     = cl.sede  || '';

      // tooltip/motivo
      let motivo = '';
      if (cl.observacion && String(cl.observacion).trim()) motivo = String(cl.observacion).trim();
      else if (cl.motivo && String(cl.motivo).trim())      motivo = String(cl.motivo).trim();
      else if (cl.nota && String(cl.nota).trim())          motivo = String(cl.nota).trim();
      tag.dataset.observacion = motivo;

      // estado y tipo
      applyEstadoClassToTag(tag, tag.dataset.estado);
      const tipo = cl.tipo ?? (cl.es_prueba ? 'prueba'
                  : (cl.unica_vez || cl.es_recuperacion ? 'recuperacion'
                  : (!cl.alumno_id && cl.nota ? 'prueba' : 'normal')));
      tag.dataset.tipo = tipo;
      if (!tag.dataset.estado) applyTipoColorToTag(tag);

      if ((String(tipo).toLowerCase()==='prueba' || !cl.alumno_id) && motivo){
        tag.title = `Observación/motivo de prueba: ${motivo}`;
        tag.classList.add('has-tooltip');
        tag.dataset.tooltip = `Observación/motivo de prueba: ${motivo}`;
      }

      tag.addEventListener('click', onTagClick);
      tag.addEventListener('dblclick', onTagDblClick);
      (idx % 2 === 0 ? left : right).appendChild(tag);
    });
  });
}

let claseSelId = null;
let claseSelTag = null;

function onTagDblClick(e){
  e.stopPropagation();
  const tag = e.currentTarget;

  // guardar refs para guardar/eliminar
  claseSelTag = tag;
  claseSelId  = parseInt(tag.dataset.id, 10) || null;

  // Título arriba del modal: número + "Nombre (prueba)" si lo hubiera
  var nombre = tag.dataset.nombre || tag.textContent || '';
  var numero = tag.dataset.numero || '';
  document.getElementById('claseInfo').textContent =
    (numero ? (numero + ' · ') : '') + nombre;

  // Estado (checks exclusivos)
  var estado = tag.dataset.estado || '';
  chkAsistio.checked   = (estado === 'asistio');
  chkSinAviso.checked  = (estado === 'sin_aviso');
  chkConAviso.checked  = (estado === 'con_aviso');
  chkSobreHora.checked = (estado === 'sobre_hora');

 // Observación
var obs = (tag.dataset.observacion || '').trim();

// Último recurso: buscar en cache por id
if (!obs) {
  var idSel = parseInt(tag.dataset.id, 10) || 0;
  if (idSel) {
    try {
      var cache = JSON.parse(localStorage.getItem('motivos_prueba') || '{}');
      if (cache[String(idSel)]) obs = String(cache[String(idSel)]);
    } catch(e){}
  }
}
document.getElementById('observacionClase').value = obs;


  // abrir modal
  overlayClase.style.display = 'flex';
}


async function guardarEstadoClase(){
  // único estado seleccionado (o ninguno para limpiar)
  var estado = '';
  if (chkAsistio.checked)        estado = 'asistio';
  else if (chkSinAviso.checked)  estado = 'sin_aviso';
  else if (chkConAviso.checked)  estado = 'con_aviso';
  else if (chkSobreHora.checked) estado = 'sobre_hora';

  // Observación (nota de prueba o comentario)
  var obsEl = document.getElementById('observacionClase');
  var observacion = obsEl ? obsEl.value : '';

  // Buscar la clase en cache para saber el tipo
  var it = null;
  for (var i = 0; i < clasesSemana.length; i++) {
    if (Number(clasesSemana[i].id) === Number(claseSelId)) { it = clasesSemana[i]; break; }
  }
  var tipo = it ? (it.tipo || '') : '';

  // ==== UI inmediata
  if (claseSelTag){
    claseSelTag.dataset.estado = estado;
    if (tipo === 'prueba') {
      claseSelTag.dataset.observacion = observacion;
      // cache persistente del motivo por id
      try {
        var cache = JSON.parse(localStorage.getItem('motivos_prueba') || '{}');
        cache[String(claseSelId)] = observacion || '';
        localStorage.setItem('motivos_prueba', JSON.stringify(cache));
      } catch(e){}
    } else {
      claseSelTag.dataset.nota = observacion || '';
    }
    applyEstadoClassToTag(claseSelTag, estado);
  }

  // ==== Cache en memoria
  if (it){
    it.estado = estado || null;
    if (tipo === 'prueba') it.observacion = observacion || '';
    else it.nota = observacion || '';
  }

  try{
    if (claseSelId){
      // intenta PATCH /clases/:id con estado + observacion
      var r = await fetch('/clases/' + claseSelId, {
        method: 'PATCH',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          estado: estado || null,
          observacion: observacion   // 
        })
      });

      // fallback POST /clases/estado si el PATCH no existe
      if (!r.ok){
        r = await fetch('/clases/estado', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            id: claseSelId,
            estado: estado || null,
            observacion: observacion
          })
        });
        if (!r.ok) throw new Error('No se pudo guardar el estado/observación');
      }
    }
    cerrarModalClase();
  } catch(err){
    console.error(err);
    alert('No se pudo guardar el estado/observación');

    // rollback visual si falló
    if (claseSelTag){
      var prevEstado = it ? (it.estado || '') : '';
      var prevObs    = '';
      if (it){
        prevObs = (tipo === 'prueba')
          ? (it.observacion || '')
          : (it.nota || '');
      }
      claseSelTag.dataset.estado = prevEstado;
      if (tipo === 'prueba') claseSelTag.dataset.observacion = prevObs;
      else claseSelTag.dataset.nota = prevObs;
      applyEstadoClassToTag(claseSelTag, prevEstado);
    }
  }
}

// (si no lo tenías ya exportado)
window.guardarEstadoClase = guardarEstadoClase;



function onSlotDblClick(e){
  const td = e.currentTarget;
  const fecha = td.dataset.fecha;
  const hora  = normTime(td.dataset.hora);
  const sede  = (td.dataset.sede||'').trim();

  // abrir y preparar modal
  abrirModal();

  // setear sede y reconstruir combos de horas/días
  selectSede.value = sede;
  onSedeChange(); // llama a refrescarDiasYHoras internamente

  // preseleccionar "única vez" (podés cambiar a 'prueba' si querés)
  chkUnica.checked = true;
  chkPrueba.checked = false;
  toggleModo('unica');

  // precargar fecha/hora en ambas secciones (por si cambiás de modo)
  fechaUnica.value   = fecha;
  horaUnica.value    = hora;
  fechaPrueba.value  = fecha;
  horaPrueba.value   = hora;
}



/* ===== Modal helpers ===== */
function selectedDOWs(){return Array.from(document.querySelectorAll('#chipsDias .chip.selected')).map(ch=>parseInt(ch.dataset.dow,10))}
function applySedeToSelectedDays(){
  const sede=selectSede.value;if(!sede)return;
  selectedDOWs().forEach(d=>{
    const row=[...document.querySelectorAll('#perDia > div')].find(el=>parseInt(el.dataset.dow,10)===d);
    if(row){const selects=row.querySelectorAll('select'); if(selects[1]) selects[1].value=sede;}
  });
}
function applyHoraToSelectedDays(){
  const horaGen = document.getElementById('selectHoraGeneral').value;
  const seleccionados = selectedDOWs();
  if (!horaGen || seleccionados.length === 0) return; // <-- si no hay días, no hace nada

  seleccionados.forEach(d=>{
    const row = Array.from(document.querySelectorAll('#perDia > div'))
      .find(el => parseInt(el.dataset.dow,10) === d);
    if (!row) return;
    const selHora = row.querySelector('select'); // primer select (hora)
    if (selHora) selHora.value = horaGen;
  });
}
function onSedeChange(){refrescarDiasYHoras();applySedeToSelectedDays();applyHoraToSelectedDays()}

function refrescarDiasYHoras(){
  const sede = selectSede.value, cont = chipsDias, selGen = selectHoraGeneral, perDia = perDiaDiv;

  // reset
  cont.innerHTML = '';
  selGen.innerHTML = '<option value="">Seleccionar hora...</option>';
  perDia.innerHTML = '';

  if (!sede){
    horaUnica.innerHTML  = '<option value="">Seleccionar hora...</option>';
    horaPrueba.innerHTML = '<option value="">Seleccionar hora...</option>';
    return;                    // ✅ cerramos el if acá
  }

  // chips de días
  const dias = diasHabilitados(sede);
  dias.forEach(d=>{
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.dataset.dow = d;
    chip.textContent = DIAS[d];
    chip.onclick = ()=>{
      chip.classList.toggle('selected');
      applySedeToSelectedDays();
      applyHoraToSelectedDays(); // solo aplica si hay días seleccionados
    };
    cont.appendChild(chip);
  });

  // opciones de hora general
  const horas = rangoHoras(sede);
  horas.forEach(h=>{
    const o = document.createElement('option');
    o.value = normTime(h);
    o.textContent = h;
    selGen.appendChild(o);
  });

  // filas por día (hora + sede editables)
  dias.forEach(d=>{
    const wrap  = document.createElement('div'); wrap.style.marginTop='6px'; wrap.dataset.dow = d;
    const label = document.createElement('label'); label.textContent = `${DIAS[d]}: `; label.style.marginRight='6px';

    const selHora = document.createElement('select');
    const defH = document.createElement('option'); defH.value=''; defH.textContent='Seleccionar hora...'; selHora.appendChild(defH);
    horas.forEach(h=>{ const o=document.createElement('option'); o.value=normTime(h); o.textContent=h; selHora.appendChild(o); });

    const selSede = document.createElement('select');
    ['Craig Reformer','Craig Circuito','Pedro Goyena'].forEach(s=>{ const o=document.createElement('option'); o.textContent=s; selSede.appendChild(o); });
    selSede.value = sede;

    wrap.appendChild(label);
    wrap.appendChild(selHora);
    wrap.appendChild(document.createTextNode(' '));
    wrap.appendChild(selSede);
    perDia.appendChild(wrap);
  });

  // Única / Prueba
  horaUnica.innerHTML  = '<option value="">Seleccionar hora...</option>';
  horas.forEach(h=>{ const o=document.createElement('option'); o.value=normTime(h); o.textContent=h; horaUnica.appendChild(o); });
  horaPrueba.innerHTML = '<option value="">Seleccionar hora...</option>';
  horas.forEach(h=>{ const o=document.createElement('option'); o.value=normTime(h); o.textContent=h; horaPrueba.appendChild(o); });

  // Propagar sede a días seleccionados (si hay)
  applySedeToSelectedDays();

  // Propagar hora general SOLO si hay días seleccionados
  const hGen = selectHoraGeneral.value;
  if (hGen && selectedDOWs().length) applyHoraToSelectedDays();
}


// Cupo ilimitado: nunca bloquea
function cupoDisponible(fecha, hora, sede){
  return Number.POSITIVE_INFINITY;
}

// Genera todas las fechas (YYYY-MM-DD) desde la semana visible hasta fin de año
// para el día de la semana indicado (1=Lun ... 7=Dom)
function fechasHastaFinDeAnio(dow){
  const fin = new Date(semanaInicio.getFullYear(), 11, 31);
  let first = addDays(semanaInicio, dow - 1);
  const hoy = new Date(); hoy.setHours(0,0,0,0);
  if (first < hoy) first = addDays(first, 7);

  const out = [];
  for (let d = first; d <= fin; d = addDays(d, 7)) {
    out.push(ymd(d));
  }
  return out;
}


/* ===== Guardar ===== */
function guardarClase(){
  const esRecuperacion = chkUnica.checked;   // "Clase de Recuperación"
  const esPrueba       = chkPrueba.checked;

  // alumno_id solo si NO es prueba
  let alumno_id = null;
  if (!esPrueba){
    alumno_id = parseInt(selectAlumno.value, 10);
    if (!alumno_id){ 
      alert('Seleccioná una alumna/o'); 
      return; 
    }
  }

  let clases = [];

  // === Clase de RECUPERACIÓN (antes única vez) ===
  if (esRecuperacion){
    const sede  = (selectSede.value || '').trim(); 
    if (!sede){ alert('Seleccioná una sede'); return; }

    const fecha = fechaUnica.value;
    const hora  = normTime(horaUnica.value);
    if (!fecha || !hora){ 
      alert('Completá fecha y hora'); 
      return; 
    }

    clases.push({ fecha, hora, sede, tipo: 'recuperacion' });
  }

  // === Clase de PRUEBA (sin alumno) ===
  else if (esPrueba){
    const sede   = (selectSede.value || '').trim(); 
    if (!sede){ alert('Seleccioná una sede'); return; }

    const fecha  = fechaPrueba.value;
    const hora   = normTime(horaPrueba.value);
    var elNombre = document.getElementById('nombrePrueba');
var elNota   = document.getElementById('notaPrueba');
const nombre = (elNombre ? elNombre.value : '').trim();
const nota   = (elNota   ? elNota.value   : '').trim();

    if (!fecha || !hora){ alert('Completá fecha y hora'); return; }
    if (!nombre){ alert('Ingresá el nombre de la persona'); return; }

    // nota = nombre visible del chip; observacion = motivo
    clases.push({ fecha, hora, sede, nota: nombre, observacion: nota, tipo: 'prueba' });
  }

  // === Clase RECURRENTE (normal) ===
  else {
    const sedeBase = (selectSede.value || '').trim();
    if (!sedeBase){ alert('Seleccioná una sede'); return; }

    const seleccionados = selectedDOWs();
    if (seleccionados.length === 0){ alert('Seleccioná al menos un día'); return; }

    // 1) patrones nuevos
    const nuevos = [];
    for (const d of seleccionados){
      const row = [...document.querySelectorAll('#perDia > div')].find(el => parseInt(el.dataset.dow,10) === d);
      const selects = row ? row.querySelectorAll('select') : null;
      const hora = normTime(selects && selects[0] ? selects[0].value : '');
      const sede = ((selects && selects[1]) ? selects[1].value : sedeBase).trim();
      if (!hora){ alert('Completá la hora para los días seleccionados'); return; }
      nuevos.push({ dow:d, hora, sede });
    }

    // 2) patrones actuales
    const actualesSet = new Set();
    for (const c of clasesAlumnoActual){
      actualesSet.add(groupKey(dowNumFromYMD(c.fecha), c.hora, c.sede));
    }

    // 3) a eliminar
    const nuevosSet = new Set(nuevos.map(p => groupKey(p.dow, p.hora, p.sede)));
    const patronesAEliminar = [...actualesSet].filter(k => !nuevosSet.has(k));
    const idsAEliminar = clasesAlumnoActual
      .filter(c => patronesAEliminar.includes(groupKey(dowNumFromYMD(c.fecha), c.hora, c.sede)))
      .map(c => c.id);

    // 4) a insertar
    const clasesNuevas = [];
    for (const p of nuevos){
      for (const f of fechasHastaFinDeAnio(p.dow)){
        clasesNuevas.push({ fecha:f, hora:p.hora, sede:p.sede });
      }
    }

    if (clasesNuevas.length===0 && idsAEliminar.length===0){
      alert('No hay cambios para aplicar.'); 
      return;
    }

    // 5) ejecutar
    (async ()=>{
      try{
        if (idsAEliminar.length){
          let del = await fetch('/clases', {
            method:'DELETE',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ ids: idsAEliminar })
          });
          if (del.status === 404){
            del = await fetch('/clases/bulk-delete', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ ids: idsAEliminar })
            });
          }
          if (!del.ok) throw new Error('No se pudieron borrar las clases anteriores');
        }

        if (clasesNuevas.length){
          const res = await fetch('/clases', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ alumno_id, clases: clasesNuevas })
          });
          if (!res.ok) throw new Error('No se pudieron crear las clases nuevas');
        }

        cerrarModal();
        await cargarSemana();
        await cargarSituacionAlumno(alumno_id || 0);
        alert('Cambios aplicados');
      }catch(e){
        console.error(e);
        alert(e.message || 'Error al guardar cambios');
      }
    })();

    return; // termina rama recurrente
  }

  // === Guardado para PRUEBA o RECUPERACIÓN ===
  (async ()=>{
    try{
      const res = await fetch('/clases', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ alumno_id, clases })
      });
      if (!res.ok) throw new Error('No se pudo registrar la clase');

      // Intentar leer respuesta
      let data; try { data = await res.json(); } catch {}
      let creadas = [];
      if (Array.isArray(data)) {
        creadas = data;
      } else if (data && typeof data === 'object') {
        creadas = [data];
      }

      // Datos del alumno para pintar correctamente (recuperación)
      const listaAlumnos = (window.alumnosGlobal || window.alumnos || []);
      const alum = listaAlumnos.find(a => Number(a.id) === Number(alumno_id));
      const displayNombre = alum ? `${alum.apellido || ''} ${alum.nombre || ''}`.trim() : '';
      const numeroAlumno  = alum && alum.numero_alumno != null ? alum.numero_alumno : null;


      // Si no vino nada útil del backend, recargamos semana
      if (creadas.length === 0 || creadas.every(c => c.id == null)) {
        cerrarModal();
        await cargarSemana();
        return;
      }

      // Insertar en cache local
      const tipoLocal  = clases[0]?.tipo || null; // 👈 'recuperacion' o 'prueba'
      const baseSede   = (selectSede.value || '').trim();
      const fechaLocal = clases[0].fecha;
      const horaLocal  = clases[0].hora;

// cache local de motivos por id (por si el backend no lo devuelve)
var inpNotaPrueba   = document.getElementById('notaPrueba');
var valMotivoPrueba = (inpNotaPrueba ? inpNotaPrueba.value : '').trim();
var cacheMotivos = {};
try { cacheMotivos = JSON.parse(localStorage.getItem('motivos_prueba') || '{}'); } catch(e) { cacheMotivos = {}; }



      for (const c of creadas){
      clasesSemana.push({
  id    : (c.id != null ? c.id : null),
  fecha : normDate(c.fecha || fechaLocal),
  hora  : normTime(c.hora  || horaLocal),
  sede  : (c.sede ? String(c.sede).trim() : baseSede),
  alumno_id,
  nombre: '',                  // prueba no lleva alumno
  numero_alumno: null,
  // Nombre visible del chip (Nombre (prueba))
  nota  : ( (c.nota != null ? c.nota : valNombrePrueba) || '' ).trim(),
  // Motivo/observación para el modal
  observacion: ( (c.observacion || c.obs || c.motivo || valMotivoPrueba) || '' ).trim(),
  estado: c.estado || null,
  tipo  : c.tipo || 'prueba'
});



      }

      pintarClases();
      cerrarModal();
    }catch(e){
      console.error(e);
      alert(e.message || 'Error al guardar la clase');
    }
  })();
} // 👈 cierre de guardarClase





// Eliminar una clase (la seleccionada en el modal)
window.eliminarClaseSeleccionada = async function (){
  if (!claseSelId){
    alert('No hay una clase seleccionada.');
    return;
  }

  const ok = confirm('¿Eliminar esta clase? Esta acción no se puede deshacer.');
  if (!ok) return;

  try{
    let r = await fetch(`/clases/${claseSelId}`, { method:'DELETE' });

    if (r.status === 404){
      r = await fetch('/clases', {
        method:'DELETE',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ ids: [claseSelId] })
      });
    }

    if (!r.ok){
      const t = await r.text();
      throw new Error(t || 'No se pudo eliminar la clase');
    }

    clasesSemana = clasesSemana.filter(c => c.id !== claseSelId);
    pintarClases();
    cerrarModalClase();
    alert('Clase eliminada.');
  } catch(err){
    console.error(err);
    alert('Error al eliminar la clase.');
  }
};

// === Modal (exponer en window para que funcionen los onclick del HTML) ===
window.abrirModal = function (){
  overlay.style.display = 'flex';
  buscadorAlumno.value = '';
  selectAlumno.innerHTML = '';
  chkUnica.checked = false;
  chkPrueba.checked = false;
  boxRecurrente.style.display = '';
  boxUnica.style.display = 'none';
  boxPrueba.style.display = 'none';
  selectSede.value = '';
  refrescarDiasYHoras();

  const idSel = parseInt(selectAlumno.value, 10) || 0;
  cargarSituacionAlumno(idSel);
  renderDatosAlumno(idSel);    // <--- NUEVO
};

window.cerrarModal = function (){
  overlay.style.display = 'none';
};

window.toggleModo = function (modo){
  if (modo === 'unica'  && chkUnica.checked)  chkPrueba.checked = false;
  if (modo === 'prueba' && chkPrueba.checked) chkUnica.checked = false;

  const unica  = chkUnica.checked;
  const prueba = chkPrueba.checked;
// ocultar/mostrar la columna izquierda (buscador) según sea prueba
const colIzq = document.querySelector('.modal .row > div:first-child');
if (colIzq) colIzq.style.display = (prueba ? 'none' : '');


  boxRecurrente.style.display = (!unica && !prueba) ? '' : 'none';
  boxUnica.style.display      = unica  ? '' : 'none';
  boxPrueba.style.display     = prueba ? '' : 'none';

  refrescarDiasYHoras();
};

const btnEliminar = document.getElementById('btnEliminarClases');
if (btnEliminar){
  btnEliminar.addEventListener('click', eliminarClasesAlumno);
}

const np = document.getElementById('nombrePrueba');
if (np) np.value = '';

const btnEliminarClaseUnica = document.getElementById('btnEliminarClaseUnica');
if (btnEliminarClaseUnica){
  btnEliminarClaseUnica.addEventListener('click', eliminarClaseSeleccionada);
}


/* ===== Init ===== */
async function cargarSemana() {
  actualizarHeader();
  construirTablaBase();
  await cargarFeriados();   // 👈 nuevo
  await cargarNoClases();
  await cargarClasesSemana();
  pintarClases();
}

window.addEventListener('load', function () {
  cargarAlumnos()
    .then(() => cargarSemana())
    .catch(console.error);
});

// ====== Buscador tipo Excel (semana visible) ======
const $findIn   = document.getElementById('findAlumnoInput');
const $findDrop = document.getElementById('findAlumnoSelect');
const $findClr  = document.getElementById('btnLimpiarFind');

let idxAlumnos = [];      // [{id, label, hayGuion, numero, nombreCompletoLower}]
let alumnoFindSel = null; // id seleccionado actualmente (para re-seleccionar tras repintar)

// Construye índice de alumnos para autocompletar
function buildIdxAlumnos(){
  // usa el array global "alumnos" que ya cargás en /alumnos
  idxAlumnos = (alumnos || []).map(a => {
    const rawNum = String(a.numero || '').trim();
    const numVis = rawNum.includes('-') ? rawNum : String(rawNum).padStart(2,'0');
    const label  = `${numVis} - ${(a.apellido||'')}, ${(a.nombre||'')}`.trim();
    return {
      id: a.id,
      numero: numVis,
      label,
      needle: (numVis + ' ' + label).toLowerCase()
    };
  });
}
buildIdxAlumnos();

// Rellena el dropdown con coincidencias
function showFindOptions(text){
  const t = text.trim().toLowerCase();
  const items = t ? idxAlumnos.filter(x => x.needle.includes(t)).slice(0, 50) : [];
  $findDrop.innerHTML = '';
  if (!items.length){ $findDrop.style.display = 'none'; return; }
  items.forEach(x => {
    const opt = document.createElement('option');
    opt.value = String(x.id);
    opt.textContent = x.label;
    $findDrop.appendChild(opt);
  });
  const r = $findIn.getBoundingClientRect();
  $findDrop.style.left = (r.left) + 'px';
  $findDrop.style.top  = (r.bottom + window.scrollY) + 'px';
  $findDrop.style.width = (r.width) + 'px';
  $findDrop.style.display = 'block';
}

// Quita resaltado actual
function clearFindSelection(){
  document.querySelectorAll('.tag.find-hit').forEach(el => el.classList.remove('find-hit'));
  alumnoFindSel = null;
  $findDrop.style.display = 'none';
  $findIn.value = '';
}

// Resalta todas las clases del alumno en la semana visible
function selectAlumnoEnSemana(alumnoId){
  alumnoFindSel = Number(alumnoId) || null;
  // limpiar anteriores
  document.querySelectorAll('.tag.find-hit').forEach(el => el.classList.remove('find-hit'));

  if (!alumnoFindSel) return;

  // marcar todas las coincidencias en los chips de la semana renderizada
  let hits = 0;
  document.querySelectorAll('.tag').forEach(tag => {
    const aid = Number(tag.dataset.alumnoId || 0);
    if (aid === alumnoFindSel){
      tag.classList.add('find-hit');
      hits++;
    }
  });

  // Si encontramos algo, scrolleo al primer match
  if (hits){
    const first = document.querySelector('.tag.find-hit');
    if (first) first.scrollIntoView({ behavior:'smooth', block:'center', inline:'center' });
  }
}

// Hook: cuando se repinta la semana, volver a aplicar la selección si existía
const _pintarClases = pintarClases;
pintarClases = function(){
  _pintarClases();
  if (alumnoFindSel) selectAlumnoEnSemana(alumnoFindSel);
};

// Eventos del buscador
$findIn.addEventListener('input', e => showFindOptions(e.target.value));
$findIn.addEventListener('keydown', e => {
  if (e.key === 'ArrowDown'){ $findDrop.focus(); if ($findDrop.options.length) $findDrop.selectedIndex = 0; }
  if (e.key === 'Escape'){ $findDrop.style.display = 'none'; }
if (e.key === 'Enter'){
    const t = $findIn.value.trim().toLowerCase();
    const m = idxAlumnos.find(x => x.needle.includes(t));
    if (m) selectAlumnoEnSemana(m.id);
  }
});

$findDrop.addEventListener('change', () => {
  const id = Number($findDrop.value || 0);
  const opt = $findDrop.options[$findDrop.selectedIndex];
  if (opt){ $findIn.value = opt.textContent || ''; }
  $findDrop.style.display = 'none';
  selectAlumnoEnSemana(id);
});
$findDrop.addEventListener('keydown', e => {
  if (e.key === 'Enter'){ $findDrop.dispatchEvent(new Event('change')); }
  if (e.key === 'Escape'){ $findDrop.style.display = 'none'; $findIn.focus(); }
});

$findClr.addEventListener('click', clearFindSelection);

let feriados = [];

async function cargarFeriados() {
  try {
    const res = await fetch('/feriados');
    if (!res.ok) throw new Error(await res.text());
    feriados = await res.json();
    // normalizamos a YYYY-MM-DD
    feriados = feriados.map(f => new Date(f.fecha).toISOString().slice(0,10));
  } catch (err) {
    console.error('Error al cargar feriados', err);
    feriados = [];
  }
}


// Si /alumnos se recarga en algún momento, reconstruir índice
// (ya llamás cargarAlumnos() al iniciar la página) :contentReference[oaicite:2]{index=2}



  // refs rápidas (evita document.getElementById repetido)
  const overlay=document.getElementById('overlay');
  const selectAlumno=document.getElementById('selectAlumno');
  const buscadorAlumno=document.getElementById('buscadorAlumno');
  const chkUnica=document.getElementById('chkUnica');
  const chkPrueba=document.getElementById('chkPrueba');
  const boxRecurrente=document.getElementById('boxRecurrente');
  const boxUnica=document.getElementById('boxUnica');
  const boxPrueba=document.getElementById('boxPrueba');
  const selectSede=document.getElementById('selectSede');
  const selectHoraGeneral=document.getElementById('selectHoraGeneral');
  selectHoraGeneral.addEventListener('change', applyHoraToSelectedDays);
  const chipsDias=document.getElementById('chipsDias');
  const perDiaDiv=document.getElementById('perDia');
  const fechaUnica=document.getElementById('fechaUnica');
  const horaUnica=document.getElementById('horaUnica');
  const fechaPrueba=document.getElementById('fechaPrueba');
  const horaPrueba=document.getElementById('horaPrueba');
  const notaPrueba=document.getElementById('notaPrueba');
  const id = parseInt(selectAlumno.value, 10) || 0;
  cargarSituacionAlumno(id);
// Refs modal de clase
const chkAsistio  = document.getElementById('chkAsistio');
const chkSinAviso  = document.getElementById('chkSinAviso');
const chkConAviso  = document.getElementById('chkConAviso');
const chkSobreHora = document.getElementById('chkSobreHora');

[chkAsistio, chkSinAviso, chkConAviso, chkSobreHora].forEach((chk, _, arr) => {
  chk.addEventListener('change', (e)=>{
    if (!e.target.checked) return;
    arr.forEach(c => { if (c !== e.target) c.checked = false; });
  });
});


	
selectAlumno.addEventListener('change', () => {
  const id = parseInt(selectAlumno.value, 10) || 0;
  cargarSituacionAlumno(id);
  renderDatosAlumno(id);   // <--- NUEVO
});

function cerrarModalClase() {
  document.getElementById('overlayClase').style.display = 'none';
}

</script>
</body>
</html>
