<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agenda</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #d9e8e2;
      margin: 0;
      padding: 0;
    }
    h1, h2 {
      text-align: center;
      color: #6b3c4e;
    }
    .selector-sede {
      text-align: center;
      margin-top: 10px;
    }
    select {
      font-size: 16px;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .calendario {
      max-width: 95%;
      margin: 20px auto;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .calendario th, .calendario td {
      border: 1px solid #bbb;
      padding: 6px;
      height: 60px;
      text-align: center;
      vertical-align: top;
    }
    .calendario th {
      background-color: #91586d;
      color: white;
    }
    .hora {
      background: #eee;
      font-weight: bold;
    }
    .nav-semana {
      text-align: center;
      margin-top: 10px;
    }
    .nav-semana button {
      padding: 5px 15px;
      font-size: 16px;
      background-color: #91586d;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .formulario-clase {
      max-width: 600px;
      background: white;
      margin: 20px auto;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .formulario-clase input, .formulario-clase select {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
    }

 #campoSabado {
  display: none;
}

  </style>
</head>
<body>

  <h1>Agenda Semanal</h1>

  <div class="selector-sede">
    <label>Seleccionar sede:</label>
    <select id="selectorSede" onchange="renderizarAgenda()">
      <option value="craig_reformer">Craig Reformer</option>
      <option value="craig_circuito">Craig Circuito</option>
      <option value="goyena">Pedro Goyena</option>
    </select>
    <br><br>
    <button onclick="mostrarFormulario()">➕ Registrar Clase</button>
  </div>

  <div class="nav-semana">
    <button onclick="cambiarSemana(-1)">◄ Semana anterior</button>
    <span id="tituloSemana">Semana actual</span>
    <button onclick="cambiarSemana(1)">Semana siguiente ►</button>
  </div>

  <table class="calendario" id="tablaAgenda">	
    <thead id="theadAgenda"></thead>
    <tbody id="tbodyAgenda"></tbody>
  </table>

  <div class="formulario-clase" id="formularioClase" style="display: none;">
    <h2>Registrar Clase</h2>
    <input type="text" id="busquedaAlumno" placeholder="Buscar alumno...">
    <select id="alumnoSeleccionado"></select>

    <label><input type="checkbox" id="esPrueba"> Clase de Prueba</label>
    <label><input type="checkbox" id="esUnica" onchange="alternarUnica()"> Clase por única vez</label>

    <div id="formRecurrente">
      <label>Sede:</label>
      <select id="sedeRecurrente">
        <option value="Craig Reformer">Craig Reformer</option>
        <option value="Craig Circuito">Craig Circuito</option>
        <option value="Pedro Goyena">Pedro Goyena</option>
      </select>

      <div id="diasSemana">
  <label>Lunes: <input type="time" id="hora-Lunes" step="3600"></label><br>
  <label>Martes: <input type="time" id="hora-Martes" step="3600"></label><br>
  <label>Miércoles: <input type="time" id="hora-Miércoles" step="3600"></label><br>
  <label>Jueves: <input type="time" id="hora-Jueves" step="3600"></label><br>
  <label>Viernes: <input type="time" id="hora-Viernes" step="3600"></label><br>
  <label id="campoSabado">Sábado: <input type="time" id="hora-Sábado" step="3600"></label><br>


</div>

    </div>

    <div id="formUnica" style="display:none;">
      <label>Fecha exacta:</label>
      <input type="date" id="fechaUnica">
      <label>Horario:</label>
      <select id="horaUnica"></select>
      <label>Sede:</label>
      <select id="sedeUnica"></select>
    </div>

    <button onclick="guardarClase()">Guardar Clase</button>
    <button onclick="cerrarFormulario()">Cancelar</button>
  </div>

<script>
let semanaOffset = 0;

function cambiarSemana(d) {
  semanaOffset += d;
  renderizarAgenda();
}

async function renderizarAgenda() {
  const sede = document.getElementById('selectorSede').value;
  const hoy = new Date();
  hoy.setDate(hoy.getDate() + semanaOffset * 7);
  const dia = hoy.getDay();
  const lunes = new Date(hoy);
  lunes.setDate(hoy.getDate() - ((dia + 6) % 7));

  const dias = sede === 'goyena'
    ? ['Lunes','Martes','Miércoles','Jueves','Viernes','Sábado']
    : ['Lunes','Martes','Miércoles','Jueves','Viernes'];

  const horas = sede === 'goyena'
    ? Array.from({length: 14}, (_, i) => `${(8 + i).toString().padStart(2,'0')}:00`)
    : Array.from({length: 12}, (_, i) => `${(9 + i).toString().padStart(2,'0')}:00`);

  const thead = document.getElementById('theadAgenda');
  const tbody = document.getElementById('tbodyAgenda');
  thead.innerHTML = '';
  tbody.innerHTML = '';

  // encabezado con mes y año
  const fechaStr = lunes.toLocaleDateString('es-AR', { month: 'long', year: 'numeric' });
  document.getElementById('tituloSemana').innerText = `${fechaStr.charAt(0).toUpperCase() + fechaStr.slice(1)}`;

  const encabezadoDias = dias.map((d, i) => {
    const f = new Date(lunes);
    f.setDate(lunes.getDate() + i);
    return `<th>${d} ${f.getDate()}</th>`;
  }).join('');

  thead.innerHTML = `<tr><th class='hora'>Hora</th>${encabezadoDias}</tr>`;

  const filas = horas.map(h => [`<td class='hora'>${h}</td>`].concat(dias.map(() => '<td></td>')));
  for (let fila of filas) tbody.innerHTML += `<tr>${fila.join('')}</tr>`;

  // cargar clases desde backend
  const desde = new Date(lunes);
  const hasta = new Date(lunes);
  hasta.setDate(hasta.getDate() + dias.length - 1);

  const desdeStr = desde.toISOString().split('T')[0];
  const hastaStr = hasta.toISOString().split('T')[0];

  try {
    const res = await fetch(`/clases?desde=${desdeStr}&hasta=${hastaStr}`);
    const clases = await res.json();

    clases.filter(c => c.sede.toLowerCase().includes(sede.replace('_',' '))).forEach(clase => {
      const fecha = new Date(clase.fecha);
      const hora = clase.hora.slice(0, 5);
      const diaSemana = (fecha.getDay() + 6) % 7; // lunes = 0
      if (diaSemana >= dias.length) return;

      const fila = Array.from(tbody.querySelectorAll('tr')).find(tr => tr.children[0].textContent === hora);
      if (!fila) return;

   
      const celda = fila.children[diaSemana + 1];
      celda.innerHTML += `<div>${clase.nombre} - N°${clase.numero_alumno}</div>`;
    });

  } catch (err) {
    console.error('Error al cargar clases:', err);
  }
}

function mostrarFormulario() {	
  document.getElementById('formularioClase').style.display = 'block';
}
function cerrarFormulario() {
  document.getElementById('formularioClase').style.display = 'none';
}
function alternarUnica() {
  const esUnica = document.getElementById('esUnica').checked;
  document.getElementById('formRecurrente').style.display = esUnica ? 'none' : 'block';
  document.getElementById('formUnica').style.display = esUnica ? 'block' : 'none';
}

// Mostrar u ocultar el campo de Sábado según la sede seleccionada
const sedeRecurrenteSelect = document.getElementById('sedeRecurrente');
sedeRecurrenteSelect.addEventListener('change', () => {
  const mostrar = sedeRecurrenteSelect.value === 'Pedro Goyena';
  document.getElementById('campoSabado').style.display = mostrar ? 'block' : 'none';
});


renderizarAgenda();
</script>
</body>
</html>