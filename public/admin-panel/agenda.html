<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Agenda</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* ====== Base ====== */
    body{margin:0;font-family:'Inter',sans-serif;background:#cce1d6;color:#6d6d6d}
    .sidebar{position:fixed;top:0;left:0;width:200px;height:100vh;background:#91586d;padding-top:60px;box-shadow:2px 0 5px rgba(0,0,0,.1);z-index:1000}
    .sidebar a{display:block;padding:10px 16px;color:#fff;text-decoration:none;font-weight:bold;border-bottom:1px solid rgba(255,255,255,.1);font-size:13px}
    .sidebar a:hover{background:#6d3e4e}
    main{margin-left:200px;padding:16px}
    .header{display:flex;align-items:center;gap:10px;justify-content:center;margin-bottom:16px}
    .header img{height:40px}
    h1{color:#91586d;margin:0 0 12px;text-align:center;font-size:20px}
    #menuToggle{display:none;position:fixed;top:10px;left:10px;z-index:1100;background:#91586d;color:#fff;border:none;border-radius:6px;padding:8px 12px;font-size:18px;cursor:pointer}
    @media (max-width:768px){#menuToggle{display:block}.sidebar{display:none;width:100%;height:auto;position:absolute;top:50px;left:0}.sidebar.mostrar{display:block}main{margin-left:0;padding:10px}.header{flex-direction:column}h1{font-size:18px}}

    /* ====== Controles ====== */
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .sede-tabs{display:flex;gap:6px;flex-wrap:wrap}
    .sede-tabs button,.week-nav button,.actions button{background:#b48a99;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:13px}
    .sede-tabs button.active{background:#91586d}
    .week-nav{display:flex;align-items:center;gap:8px}
    .week-label{font-weight:600;color:#91586d;min-width:160px;text-align:center}
    .legend{margin:8px 0;font-size:12px;color:#6d6d6d;display:flex;gap:12px;justify-content:flex-end}
    .legend i{width:12px;height:12px;border-radius:3px;display:inline-block}
    .i-free{background:#cce1d6;border:1px solid #94b8a3}
    .i-full{background:#ffd5d5;border:1px solid #ff9b9b}

    /* ====== Grilla ====== */
    .agenda-wrap{background:#fff;border-radius:10px;box-shadow:0 1px 6px rgba(0,0,0,.05);overflow:hidden}
    table.agenda{width:100%;border-collapse:collapse;table-layout:fixed}
    .agenda th,.agenda td{border-bottom:1px solid #e0e0e0;border-right:1px solid #e0e0e0;vertical-align:top}
    .agenda th:last-child,.agenda td:last-child{border-right:none}
    .agenda th{background:#b48a99;color:#fff;font-size:13px;position:sticky;top:0;z-index:2;padding:6px}
    .col-hora{width:70px;background:#f7f7f7;font-weight:600;text-align:center;position:sticky;left:0;z-index:1;padding:6px}

    /* ====== Slot √∫nico por hora/d√≠a dividido en dos ====== */
    td.slot{padding:0}
    .slot-inner{
      min-height:110px;
      display:grid;
      grid-template-columns:1fr 1fr;
    }
    .half{
  gap: 8px;
  padding: 6px;
  box-sizing: border-box;
  min-width: 0;          /* clave en grid para que el contenido no desborde */
}
    .half.left{border-right:1px solid #e0e0e0}
  .tag{
  display:block;
  width:100%;
  max-width:100%;
  box-sizing:border-box;
  padding:6px 8px;              /* un poco menos de padding */
  border-radius:10px;
  background:#f3fbf7;
  border:1px solid #94b8a3;
  box-shadow:0 1px 0 rgba(0,0,0,.03);

  /* ‚Äî cambios clave ‚Äî */
  font-size:11px;               /* m√°s chico */
  line-height:1.2;
  white-space:normal;           /* permite salto de l√≠nea */
  overflow:visible;             /* sin recorte */
  text-overflow:clip;           /* sin '...' */
  word-break:break-word;        /* por si un nombre es muy largo */
}

.tag.full{
  background:#ffdede;
  border-color:#ff9b9b;
  text-align:center;
  font-weight:600;
}

    /* ====== Modal ====== */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:1200}
    .modal{width:min(900px,95vw);background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);padding:16px;max-height:90vh;overflow:auto}
    .modal h3{margin:0 0 10px;color:#91586d;text-align:center}
    .modal .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .modal label{font-size:13px;font-weight:600;color:#6d6d6d}
    .modal input[type="text"],.modal input[type="date"],.modal select,.modal textarea{width:100%;padding:8px;border:1px solid #94b8a3;border-radius:6px;background:#f9f9f9;font-size:13px}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{padding:6px 10px;background:#cce1d6;border:1px solid #94b8a3;border-radius:999px;cursor:pointer;font-size:12px;user-select:none}
    .chip.selected{background:#b48a99;border-color:#91586d;color:#fff}
    .modal .footer{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
    .modal .footer button{background:#b48a99;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:13px}
    .switches{display:flex;gap:16px;align-items:center;justify-content:center;margin-bottom:8px}
    @media (max-width:768px){.modal .row{grid-template-columns:1fr}}
  </style>
</head>
<body>
<button id="menuToggle" onclick="document.querySelector('.sidebar').classList.toggle('mostrar')">‚ò∞</button>

<div class="sidebar">
  <a href="index.html">üìã Alumnas/os</a>
  <a href="pagos.html">üí≥ Pagos</a>
  <a href="gastos.html">üßæ Gastos</a>
  <a href="agenda.html">üìÖ Agenda</a>
  <a href="configuracion.html">‚öôÔ∏è Configuraci√≥n</a>
  <a href="reportes.html">üìà Reportes</a>
  <button onclick="localStorage.removeItem('etnya_login');location='login.html'" style="width:100%;text-align:left;padding:10px 16px;background:transparent;border:none;color:#fff;font-weight:bold;font-size:13px;border-top:1px solid rgba(255,255,255,.1);cursor:pointer">üö™ Cerrar sesi√≥n</button>
</div>

<main>
  <div class="header">
    <img src="logo.jpeg" alt="Logo">
    <h1>Agenda de Clases</h1>
  </div>

  <div class="topbar">
    <div class="sede-tabs">
      <button id="tabReformer" class="active" onclick="cambiarSede('Craig Reformer')">Craig Reformer</button>
      <button id="tabCircuito" onclick="cambiarSede('Craig Circuito')">Craig Circuito</button>
      <button id="tabGoyena" onclick="cambiarSede('Pedro Goyena')">Pedro Goyena</button>
    </div>
    <div class="week-nav">
      <button onclick="moverSemana(-1)">‚óÄ</button>
      <div class="week-label" id="labelMes"></div>
      <button onclick="moverSemana(1)">‚ñ∂</button>
    </div>
    <div class="actions">
      <button onclick="abrirModal()">+ Registrar clase</button>
    </div>
  </div>

  <div class="legend"><span><i class="i-free"></i> cupos disponibles</span><span><i class="i-full"></i> cupo completo</span></div>

  <div class="agenda-wrap">
    <table class="agenda" id="tablaAgenda"></table>
  </div>
</main>

<!-- ====== Modal Registrar ====== -->
<div class="overlay" id="overlay">
  <div class="modal">
    <h3>Registrar clase</h3>
    <div class="switches">
      <label><input type="checkbox" id="chkUnica" onchange="toggleModo('unica')"> Clase por √∫nica vez</label>
      <label><input type="checkbox" id="chkPrueba" onchange="toggleModo('prueba')"> Clase de prueba</label>
    </div>

    <div class="row">
      <div>
        <label>Buscar alumna/o</label>
        <input type="text" id="buscadorAlumno" placeholder="Ingres√° nombre o n√∫mero" oninput="filtrarAlumnos()">
        <select id="selectAlumno" size="6" style="margin-top:6px;"></select>
      </div>
      <div>
        <label>Sede principal</label>
        <select id="selectSede" onchange="onSedeChange()">
          <option value="">Seleccionar sede...</option>
          <option>Craig Reformer</option>
          <option>Craig Circuito</option>
          <option>Pedro Goyena</option>
        </select>

        <!-- Recurrente -->
        <div id="boxRecurrente" style="margin-top:10px;">
          <label>D√≠as (seg√∫n sede)</label>
          <div class="chips" id="chipsDias"></div>
          <div style="margin-top:10px;">
            <label>Hora para todos los d√≠as</label>
            <select id="selectHoraGeneral"><option value="">Seleccionar hora...</option></select>
          </div>
          <div id="perDia" style="margin-top:10px;"></div>
          <small>Se generar√°n las clases seleccionadas desde la semana visible hasta fin de a√±o.</small>
        </div>

        <!-- Situaci√≥n actual -->
<div id="boxSituacion" style="margin-top:10px;border-top:1px dashed #e0e0e0;padding-top:8px;">
  <label>Situaci√≥n actual (desde la semana visible)</label>
  <div id="situacionActual" class="chips"></div>
</div>


        <!-- √önica -->
        <div id="boxUnica" style="display:none;margin-top:10px;">
          <label>Fecha √∫nica</label>
          <input type="date" id="fechaUnica">
          <div style="margin-top:10px;">
            <label>Hora</label>
            <select id="horaUnica"><option value="">Seleccionar hora...</option></select>
          </div>
        </div>

        <!-- Prueba -->
        <div id="boxPrueba" style="display:none;margin-top:10px;">
          <label>Motivo/nota de prueba</label>
          <textarea id="notaPrueba" rows="3" placeholder="Escrib√≠ una breve nota..."></textarea>
          <div style="margin-top:10px;" class="row">
            <div>
              <label>Fecha</label>
              <input type="date" id="fechaPrueba">
            </div>
            <div>
              <label>Hora</label>
              <select id="horaPrueba"><option value="">Seleccionar hora...</option></select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <button onclick="cerrarModal()">Cancelar</button>
      <button onclick="guardarClase()">Guardar</button>
    </div>
  </div>
</div>

<script>
  if (localStorage.getItem('etnya_login') !== 'ok') location='login.html';

  const MESES=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const DIAS =['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
  const SEDES={
    'Craig Reformer':{dias:[1,2,3,4,5],desde:9,hasta:20},
    'Craig Circuito':{dias:[1,2,3,4,5],desde:9,hasta:20},
    'Pedro Goyena': {dias:[1,2,3,4,5,6],desde:8,hasta:21}
  };

  let sedeSeleccionada='Craig Reformer';
  let semanaInicio=getLunes(new Date());
  let alumnos=[], clasesSemana=[];

// ===== Utils =====
function getLunes(d){const x=new Date(d);const day=(x.getDay()+6)%7;x.setDate(x.getDate()-day);x.setHours(0,0,0,0);return x}
function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x}
function ymd(d){return d.toISOString().slice(0,10)}
function humanHour(h){return String(h).padStart(2,'0')+':00'} // muestra HH:MM
function rangoHoras(s){const {desde,hasta}=SEDES[s];const a=[];for(let h=desde;h<=hasta;h++)a.push(humanHour(h));return a}
function diasHabilitados(s){return SEDES[s].dias}
// ‚ö†Ô∏è Normalizar: '10:00' -> '10:00:00'

function normTime(t){ return t && t.length===5 ? t+':00' : t; }   // '10:00' -> '10:00:00'
function normDate(d){ return d && d.length>=10 ? d.slice(0,10) : d; } // '2025-08-19T...' -> '2025-08-19'


let clasesAlumnoActual = [];  // clases futuras del alumno seleccionado

function dowNumFromYMD(ymd){
  const d = new Date(ymd + 'T00:00:00');
  const w = d.getDay();      // 0..6  (0=Dom)
  return w === 0 ? 7 : w;    // 1..7  (1=Lun)
}

// clave para comparar patrones (d√≠a de semana + hora + sede)
function groupKey(dow, hora, sede){
  return `${dow}|${normTime(hora)}|${(sede||'').trim()}`;
}

// ===== Header / navegaci√≥n =====
function actualizarHeader(){document.getElementById('labelMes').textContent=MESES[semanaInicio.getMonth()]+' '+semanaInicio.getFullYear()}
function moverSemana(d){semanaInicio=addDays(semanaInicio,7*d);cargarSemana()}
function cambiarSede(s){sedeSeleccionada=s;['tabReformer','tabCircuito','tabGoyena'].forEach(id=>document.getElementById(id).classList.remove('active'));
  if(s==='Craig Reformer')tabReformer.classList.add('active');
  if(s==='Craig Circuito')tabCircuito.classList.add('active');
  if(s==='Pedro Goyena')tabGoyena.classList.add('active');
  cargarSemana()
}

/* ========== Construcci√≥n grilla (1 slot por hora/d√≠a) ========== */
function construirTablaBase(){
  const tabla=document.getElementById('tablaAgenda'); tabla.innerHTML='';
  const thead=document.createElement('thead'); const trh=document.createElement('tr');
  const thHora=document.createElement('th'); thHora.className='col-hora'; thHora.textContent='Hora'; trh.appendChild(thHora);

  const dias=diasHabilitados(sedeSeleccionada); const lunes=semanaInicio;
  for(const dow of dias){
    const fecha=addDays(lunes,dow-1);
    const th=document.createElement('th'); th.dataset.fecha=ymd(fecha);
    th.textContent=`${DIAS[dow]} ${String(fecha.getDate()).padStart(2,'0')}/${String(fecha.getMonth()+1).padStart(2,'0')}`;
    trh.appendChild(th);
  }
  thead.appendChild(trh);

  const tbody=document.createElement('tbody'); const horas=rangoHoras(sedeSeleccionada);
  horas.forEach(hh=>{
    const tr=document.createElement('tr');

    const tdHora=document.createElement('td'); tdHora.className='col-hora'; tdHora.textContent=hh; tr.appendChild(tdHora);

    dias.forEach(dow=>{
      const td=document.createElement('td'); td.className='slot';
      td.dataset.fecha=ymd(addDays(semanaInicio,dow-1));
      td.dataset.hora=normTime(hh); // <-- guardamos con segundos
      td.dataset.sede=sedeSeleccionada;

      td.innerHTML = `<div class="slot-inner">
                        <div class="half left"></div>
                        <div class="half right"></div>
                      </div>`;
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  tabla.appendChild(thead); tabla.appendChild(tbody);
}

/* ===== Datos ===== */
async function cargarAlumnos(){
  const res=await fetch('/alumnos'); const data=await res.json();
  alumnos=data.map(a=>({id:a.id,nombre:a.nombre,apellido:a.apellido,numero:a.numero_alumno}));
  poblarListaAlumnos('');
}

function poblarListaAlumnos(f=''){
  const sel=document.getElementById('selectAlumno'); sel.innerHTML='';
  const t=f.trim().toLowerCase(); if(!t) return;
  const list=alumnos.filter(a=>{
    const padded=String(a.numero).padStart(2,'0');
    const label=`${padded} - ${a.apellido||''}, ${a.nombre||''}`.toLowerCase();
    return padded.includes(t)||label.includes(t);
  });
  list.slice(0,200).forEach(a=>{
    const opt=document.createElement('option'); opt.value=a.id;
    const padded=String(a.numero).padStart(2,'0'); opt.textContent=`${padded} - ${a.apellido||''}, ${a.nombre||''}`;
    sel.appendChild(opt);
  });
}
function filtrarAlumnos(){poblarListaAlumnos(document.getElementById('buscadorAlumno').value)}

async function cargarClasesSemana(){
  const desde = ymd(semanaInicio);
  const dias  = diasHabilitados(sedeSeleccionada);
  const hasta = ymd(addDays(semanaInicio, Math.max(...dias)));

  const res  = await fetch(`/clases?desde=${desde}&hasta=${hasta}&sede=${encodeURIComponent(sedeSeleccionada)}`);
  const data = await res.json();

  clasesSemana = data
    .map(c => ({
      ...c,
      fecha: normDate(c.fecha),     // '2025-08-19T...' -> '2025-08-19'
      hora : normTime(c.hora),      // '10:00' -> '10:00:00'
      sede : (c.sede || '').trim()  // normaliza espacios
    }))
    .filter(c => c.sede === sedeSeleccionada); // <- filtro final por sede
}

async function cargarSituacionAlumno(alumnoId){
  const cont = document.getElementById('situacionActual');
  if (!alumnoId){
    clasesAlumnoActual = [];
    if (cont) cont.innerHTML = '';
    return;
  }

  const desde = ymd(semanaInicio);
  const fin   = ymd(new Date(semanaInicio.getFullYear(), 11, 31));

  const res  = await fetch(`/clases?alumno_id=${alumnoId}&desde=${desde}&hasta=${fin}`);
  const data = await res.json();

  // normalizar y quedarnos con futuras
  clasesAlumnoActual = (data || [])
    .map(c => ({ ...c, fecha: normDate(c.fecha), hora: normTime(c.hora), sede: (c.sede||'').trim() }))
    .filter(c => c.fecha >= desde);

  // render en chips agrupados por patr√≥n (d√≠a/hora/sede)
  if (!cont) return;
  cont.innerHTML = '';
  if (clasesAlumnoActual.length === 0){
    cont.textContent = 'Sin clases futuras.';
    return;
  }

  const mapa = new Map(); // key: dow|hora|sede  -> cantidad
  for (const c of clasesAlumnoActual){
    const key = `${dowNumFromYMD(c.fecha)}|${c.hora}|${c.sede}`;
    mapa.set(key, (mapa.get(key) || 0) + 1);
  }

  for (const [key, cant] of mapa.entries()){
    const [dow, hora, sede] = key.split('|');
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.textContent = `${DIAS[parseInt(dow,10)]} ${hora.slice(0,5)} ¬∑ ${sede} (${cant})`;
    cont.appendChild(chip);
  }
}


/* ===== Pintar ===== */
function pintarClases(){
  document.querySelectorAll('td.slot .left, td.slot .right').forEach(n=>n.innerHTML='');

  // agrupar por fecha|hora (normalizada)
  const mapa=new Map();
  for(const c of clasesSemana){
    const key = `${c.fecha}|${c.hora}`; // ya vienen normalizados
    if(!mapa.has(key)) mapa.set(key,[]);
    mapa.get(key).push(c);
  }

  document.querySelectorAll('td.slot').forEach(td=>{
    const key=`${td.dataset.fecha}|${normTime(td.dataset.hora)}`;
    const arr=mapa.get(key)||[];
    const left=td.querySelector('.left'); const right=td.querySelector('.right');

    arr.slice(0,3).forEach(cl=>{
  const tag = document.createElement('div'); tag.className='tag';
  const num = cl.numero_alumno != null ? String(cl.numero_alumno).padStart(2,'0') : '';
  const nombre = cl.nombre ?? '';
  tag.textContent = `${num ? num + ' ' : ''}${nombre}`.trim();
  left.appendChild(tag);
});

arr.slice(3,6).forEach(cl=>{
  const tag = document.createElement('div'); tag.className='tag';
  const num = cl.numero_alumno != null ? String(cl.numero_alumno).padStart(2,'0') : '';
  const nombre = cl.nombre ?? '';
  tag.textContent = `${num ? num + ' ' : ''}${nombre}`.trim();
  right.appendChild(tag);
});

    if(arr.length>6){
      const d=document.createElement('div'); d.className='tag full'; d.textContent=`+ ${arr.length-6} en espera`;
      right.appendChild(d);
    }
  });
}

/* ===== Modal helpers ===== */
function selectedDOWs(){return Array.from(document.querySelectorAll('#chipsDias .chip.selected')).map(ch=>parseInt(ch.dataset.dow,10))}
function applySedeToSelectedDays(){
  const sede=selectSede.value;if(!sede)return;
  selectedDOWs().forEach(d=>{
    const row=[...document.querySelectorAll('#perDia > div')].find(el=>parseInt(el.dataset.dow,10)===d);
    if(row){const selects=row.querySelectorAll('select'); if(selects[1]) selects[1].value=sede;}
  });
}
function applyHoraToSelectedDays(){
  const horaGen = document.getElementById('selectHoraGeneral').value;
  const seleccionados = selectedDOWs();
  if (!horaGen || seleccionados.length === 0) return; // <-- si no hay d√≠as, no hace nada

  seleccionados.forEach(d=>{
    const row = Array.from(document.querySelectorAll('#perDia > div'))
      .find(el => parseInt(el.dataset.dow,10) === d);
    if (!row) return;
    const selHora = row.querySelector('select'); // primer select (hora)
    if (selHora) selHora.value = horaGen;
  });
}
function onSedeChange(){refrescarDiasYHoras();applySedeToSelectedDays();applyHoraToSelectedDays()}

function refrescarDiasYHoras(){
  const sede = selectSede.value, cont = chipsDias, selGen = selectHoraGeneral, perDia = perDiaDiv;

  // reset
  cont.innerHTML = '';
  selGen.innerHTML = '<option value="">Seleccionar hora...</option>';
  perDia.innerHTML = '';

  if (!sede){
    horaUnica.innerHTML  = '<option value="">Seleccionar hora...</option>';
    horaPrueba.innerHTML = '<option value="">Seleccionar hora...</option>';
    return;                    // ‚úÖ cerramos el if ac√°
  }

  // chips de d√≠as
  const dias = diasHabilitados(sede);
  dias.forEach(d=>{
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.dataset.dow = d;
    chip.textContent = DIAS[d];
    chip.onclick = ()=>{
      chip.classList.toggle('selected');
      applySedeToSelectedDays();
      applyHoraToSelectedDays(); // solo aplica si hay d√≠as seleccionados
    };
    cont.appendChild(chip);
  });

  // opciones de hora general
  const horas = rangoHoras(sede);
  horas.forEach(h=>{
    const o = document.createElement('option');
    o.value = normTime(h);
    o.textContent = h;
    selGen.appendChild(o);
  });

  // filas por d√≠a (hora + sede editables)
  dias.forEach(d=>{
    const wrap  = document.createElement('div'); wrap.style.marginTop='6px'; wrap.dataset.dow = d;
    const label = document.createElement('label'); label.textContent = `${DIAS[d]}: `; label.style.marginRight='6px';

    const selHora = document.createElement('select');
    const defH = document.createElement('option'); defH.value=''; defH.textContent='Seleccionar hora...'; selHora.appendChild(defH);
    horas.forEach(h=>{ const o=document.createElement('option'); o.value=normTime(h); o.textContent=h; selHora.appendChild(o); });

    const selSede = document.createElement('select');
    ['Craig Reformer','Craig Circuito','Pedro Goyena'].forEach(s=>{ const o=document.createElement('option'); o.textContent=s; selSede.appendChild(o); });
    selSede.value = sede;

    wrap.appendChild(label);
    wrap.appendChild(selHora);
    wrap.appendChild(document.createTextNode(' '));
    wrap.appendChild(selSede);
    perDia.appendChild(wrap);
  });

  // √önica / Prueba
  horaUnica.innerHTML  = '<option value="">Seleccionar hora...</option>';
  horas.forEach(h=>{ const o=document.createElement('option'); o.value=normTime(h); o.textContent=h; horaUnica.appendChild(o); });
  horaPrueba.innerHTML = '<option value="">Seleccionar hora...</option>';
  horas.forEach(h=>{ const o=document.createElement('option'); o.value=normTime(h); o.textContent=h; horaPrueba.appendChild(o); });

  // Propagar sede a d√≠as seleccionados (si hay)
  applySedeToSelectedDays();

  // Propagar hora general SOLO si hay d√≠as seleccionados
  const hGen = selectHoraGeneral.value;
  if (hGen && selectedDOWs().length) applyHoraToSelectedDays();
}


/* ===== L√≥gica de cupo ===== */
function cupoDisponible(fecha,hora,sede){
  const h = normTime(hora);
  const arr=clasesSemana.filter(c=>c.fecha===fecha && normTime(c.hora)===h && c.sede===sede);
  return Math.max(0,6-arr.length);
}

// Genera todas las fechas (YYYY-MM-DD) desde la semana visible hasta fin de a√±o
// para el d√≠a de la semana indicado (1=Lun ... 7=Dom)
function fechasHastaFinDeAnio(dow){
  const fin = new Date(semanaInicio.getFullYear(), 11, 31);
  let first = addDays(semanaInicio, dow - 1);
  const hoy = new Date(); hoy.setHours(0,0,0,0);
  if (first < hoy) first = addDays(first, 7);

  const out = [];
  for (let d = first; d <= fin; d = addDays(d, 7)) {
    out.push(ymd(d));
  }
  return out;
}


/* ===== Guardar ===== */
function guardarClase(){
  const sel = selectAlumno;
  const alumno_id = parseInt(sel.value, 10);
  if (!alumno_id){ alert('Seleccion√° una alumna/o'); return; }

  const esUnica  = chkUnica.checked;
  const esPrueba = chkPrueba.checked;
  const clases = [];

  if (esUnica){
    const sede  = selectSede.value; if (!sede){ alert('Seleccion√° una sede'); return; }
    const fecha = fechaUnica.value;
    const hora  = normTime(horaUnica.value);
    if (!fecha || !hora){ alert('Complet√° fecha y hora'); return; }
    if (cupoDisponible(fecha, hora, sede) <= 0){ alert('Cupo completo'); return; }
    clases.push({ fecha, hora, sede });
  } else if (esPrueba){
    const sede  = selectSede.value; if (!sede){ alert('Seleccion√° una sede'); return; }
    const fecha = fechaPrueba.value;
    const hora  = normTime(horaPrueba.value);
    if (!fecha || !hora){ alert('Complet√° fecha y hora'); return; }
    if (cupoDisponible(fecha, hora, sede) <= 0){ alert('Cupo completo'); return; }
    clases.push({ fecha, hora, sede });
 // === Recurrente (reemplazo inteligente) ===
} else {
  const sedeBase = selectSede.value; 
  if(!sedeBase){ alert('Seleccion√° una sede'); return; }

  const seleccionados = selectedDOWs(); 
  if (seleccionados.length === 0){ alert('Seleccion√° al menos un d√≠a'); return; }

  // 1) NUEVOS patrones elegidos (dow/hora/sede)
  const nuevos = []; // [{dow,hora,sede}]
  for (const d of seleccionados){
    const row = [...document.querySelectorAll('#perDia > div')].find(el => parseInt(el.dataset.dow,10) === d);
    const selects = row ? row.querySelectorAll('select') : null;
    const hora = normTime(selects && selects[0] ? selects[0].value : '');
    const sede = ((selects && selects[1]) ? selects[1].value : sedeBase).trim();
    if (!hora){ alert('Complet√° la hora para los d√≠as seleccionados'); return; }
    nuevos.push({ dow:d, hora, sede });
  }

  // 2) PATRONES ACTUALES del alumno (desde la semana visible)
  const actualesSet = new Set();
  for (const c of clasesAlumnoActual){
    actualesSet.add(groupKey(dowNumFromYMD(c.fecha), c.hora, c.sede));
  }

  // 3) Patrones a ELIMINAR = actuales - nuevos
  const nuevosSet = new Set(nuevos.map(p => groupKey(p.dow, p.hora, p.sede)));
  const patronesAEliminar = [...actualesSet].filter(k => !nuevosSet.has(k));

  // IDs a eliminar (todas las futuras del alumno que coincidan con esos patrones)
  const idsAEliminar = clasesAlumnoActual
    .filter(c => patronesAEliminar.includes(groupKey(dowNumFromYMD(c.fecha), c.hora, c.sede)))
    .map(c => c.id);

  // 4) Construir INSERCIONES nuevas (todas las fechas hacia fin de a√±o)
  const clases = [];
  for (const p of nuevos){
    for (const f of fechasHastaFinDeAnio(p.dow)){
      // si quer√©s respetar cupos en la semana visible, dej√° esta l√≠nea:
      if (cupoDisponible(f, p.hora, p.sede) <= 0) continue;
      clases.push({ fecha:f, hora:p.hora, sede:p.sede });
    }
  }

  if (clases.length===0 && idsAEliminar.length===0){
    alert('No hay cambios para aplicar.');
    return;
  }

  // 5) Ejecutar: primero DELETE, luego INSERT
  (async ()=>{
    try{
      if (idsAEliminar.length){
        // Intento 1: DELETE /clases con body {ids}
        let del = await fetch('/clases', {
          method:'DELETE',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ ids: idsAEliminar })
        });
        // Fallback si tu backend usa otro endpoint:
        if (del.status === 404){
          del = await fetch('/clases/bulk-delete', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ ids: idsAEliminar })
          });
        }
        if (!del.ok) throw new Error('No se pudieron borrar las clases anteriores');
      }

      if (clases.length){
        const res = await fetch('/clases', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ alumno_id, clases })
        });
        if (!res.ok) throw new Error('No se pudieron crear las clases nuevas');
      }

      cerrarModal();
      await cargarSemana();                   // refresca la grilla
      await cargarSituacionAlumno(alumno_id); // refresca el resumen en el modal si lo volv√©s a abrir
      alert('Cambios aplicados');
    }catch(e){
      console.error(e);
      alert(e.message || 'Error al guardar cambios');
    }
  })();

  return; // üëà importante: no sigas con el flujo viejo
}

  })();
}

// === Modal (exponer en window para que funcionen los onclick del HTML) ===
window.abrirModal = function (){
  overlay.style.display = 'flex';
  buscadorAlumno.value = '';
  selectAlumno.innerHTML = '';
  chkUnica.checked = false;
  chkPrueba.checked = false;
  boxRecurrente.style.display = '';
  boxUnica.style.display = 'none';
  boxPrueba.style.display = 'none';
  selectSede.value = '';
  refrescarDiasYHoras();
// limpiar/resumir situaci√≥n cuando abr√≠s
const idSel = parseInt(selectAlumno.value, 10) || 0;
cargarSituacionAlumno(idSel);

};

window.cerrarModal = function (){
  overlay.style.display = 'none';
};

window.toggleModo = function (modo){
  if (modo === 'unica'  && chkUnica.checked)  chkPrueba.checked = false;
  if (modo === 'prueba' && chkPrueba.checked) chkUnica.checked = false;

  const unica  = chkUnica.checked;
  const prueba = chkPrueba.checked;

  boxRecurrente.style.display = (!unica && !prueba) ? '' : 'none';
  boxUnica.style.display      = unica  ? '' : 'none';
  boxPrueba.style.display     = prueba ? '' : 'none';

  refrescarDiasYHoras();
};




/* ===== Init ===== */
async function cargarSemana(){actualizarHeader();construirTablaBase();await cargarClasesSemana();pintarClases()}
window.onload=async()=>{await cargarAlumnos(); await cargarSemana()}


  // refs r√°pidas (evita document.getElementById repetido)
  const overlay=document.getElementById('overlay');
  const selectAlumno=document.getElementById('selectAlumno');
  const buscadorAlumno=document.getElementById('buscadorAlumno');
  const chkUnica=document.getElementById('chkUnica');
  const chkPrueba=document.getElementById('chkPrueba');
  const boxRecurrente=document.getElementById('boxRecurrente');
  const boxUnica=document.getElementById('boxUnica');
  const boxPrueba=document.getElementById('boxPrueba');
  const selectSede=document.getElementById('selectSede');
  const selectHoraGeneral=document.getElementById('selectHoraGeneral');
  selectHoraGeneral.addEventListener('change', applyHoraToSelectedDays);
  const chipsDias=document.getElementById('chipsDias');
  const perDiaDiv=document.getElementById('perDia');
  const fechaUnica=document.getElementById('fechaUnica');
  const horaUnica=document.getElementById('horaUnica');
  const fechaPrueba=document.getElementById('fechaPrueba');
  const horaPrueba=document.getElementById('horaPrueba');
  const notaPrueba=document.getElementById('notaPrueba');
  const id = parseInt(selectAlumno.value, 10) || 0;
  cargarSituacionAlumno(id);

	
selectAlumno.addEventListener('change', () => {
  const id = parseInt(selectAlumno.value, 10) || 0;
  cargarSituacionAlumno(id);
});
</script>
</body>
</html>
