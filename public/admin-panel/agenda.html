<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Agenda</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
 <style>
  /* ====== Base ====== */
  :root{
    --grid-line: #aeb7b3;          /* l√≠neas normales */
    --grid-strong: #8a9790;        /* separadores fuertes (hora, bordes) */
  }

  body{margin:0;font-family:'Inter',sans-serif;background:#cce1d6;color:#6d6d6d}
  .sidebar{position:fixed;top:0;left:0;width:200px;height:100vh;background:#91586d;padding-top:60px;box-shadow:2px 0 5px rgba(0,0,0,.1);z-index:1000}
  .sidebar a{display:block;padding:10px 16px;color:#fff;text-decoration:none;font-weight:bold;border-bottom:1px solid rgba(255,255,255,.1);font-size:13px}
  .sidebar a:hover{background:#6d3e4e}
  main{margin-left:200px;padding:16px}
  .header{display:flex;align-items:center;gap:10px;justify-content:center;margin-bottom:16px}
  .header img{height:40px}
  h1{color:#91586d;margin:0 0 12px;text-align:center;font-size:20px}

  /* bot√≥n hamburguesa (mobile) */
  #menuToggle{display:none;position:fixed;top:10px;left:10px;z-index:1100;background:#91586d;color:#fff;border:none;border-radius:6px;padding:8px 12px;font-size:18px;cursor:pointer}

  /* ====== Controles (topbar en 2 filas) ====== */
  .topbar{
    display:grid;
    grid-template-columns: 1fr auto 1fr; /* izq | centro | der */
    grid-template-areas:
      "tabs week actions"
      "search search .";
    align-items:center;
    gap:10px;
    margin-bottom:12px;
  }
  .sede-tabs{ grid-area:tabs; display:flex; gap:6px; flex-wrap:wrap; }
  .week-nav{  grid-area:week; display:flex; align-items:center; gap:8px; justify-self:center; }
  .actions{   grid-area:actions; display:flex; gap:8px; justify-self:end; align-items:center; }
  .search-wrap{ grid-area:search; position:relative; display:flex; gap:8px; align-items:center; }

  .sede-tabs button,
  .week-nav button,
  .actions button{
    background:#b48a99;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:13px;
  }
  .sede-tabs button.active{background:#91586d}
  .week-label{font-weight:600;color:#91586d;min-width:160px;text-align:center}

  .legend{margin:8px 0;font-size:12px;color:#6d6d6d;display:flex;gap:12px;justify-content:flex-end}
  .legend i{width:12px;height:12px;border-radius:3px;display:inline-block}
  .i-free{background:#cce1d6;border:1px solid #94b8a3}
  .i-full{background:#ffd5d5;border:1px solid #ff9b9b}

  @media (max-width:768px){
    .topbar{
      grid-template-columns: 1fr 1fr;
      grid-template-areas:
        "tabs actions"
        "week week"
        "search search";
    }
  }

  /* ====== Grilla ====== */
  .agenda-wrap{background:#fff;border-radius:10px;box-shadow:0 1px 6px rgba(0,0,0,.05);overflow:hidden}
  table.agenda{width:100%;border-collapse:collapse;table-layout:fixed}
  .agenda th,.agenda td{border-bottom:1px solid var(--grid-line);border-right:1px solid var(--grid-line);vertical-align:top}
  .agenda th:last-child,.agenda td:last-child{border-right:none}
  .agenda th{background:#b48a99;color:#fff;font-size:13px;position:sticky;top:0;z-index:2;padding:6px;border-bottom:2px solid var(--grid-strong)}
  .col-hora{width:70px;background:#f7f7f7;font-weight:600;text-align:center;position:sticky;left:0;z-index:3;padding:6px;border-right:2px solid var(--grid-strong)}
  .agenda tbody tr:last-child td{border-bottom:2px solid var(--grid-strong)}

  /* ====== Slot √∫nico por hora/d√≠a dividido en dos ====== */
  td.slot{padding:0}
  .slot-inner{min-height:110px;display:grid;grid-template-columns:1fr 1fr}
  .half{gap:8px;padding:6px;box-sizing:border-box;min-width:0}
  .half.left{border-right:1px solid var(--grid-line)}

  .tag{
    display:block;width:100%;max-width:100%;box-sizing:border-box;
    padding:6px 8px;border-radius:10px;background:#f3fbf7;border:1px solid #94b8a3;box-shadow:0 1px 0 rgba(0,0,0,.03);
    font-size:11px;line-height:1.2;white-space:normal;overflow:visible;text-overflow:clip;word-break:break-word;
  }
  .tag.full{background:#ffdede;border-color:#ff9b9b;text-align:center;font-weight:600}
 }



  .tag-recuperacion{background:#c62828;color:#fff}

  /* Estados de asistencia (colores oficiales) */
  .tag.estado-asistio     { background:#fff6bf; border-color:#e6d98a; color:#5a5200; }
  .tag.estado-sin-aviso   { background:#ffe066; border-color:#e6b800; color:#5a4b00; }
  .tag.estado-con-aviso   { background:#ffc2d1; border-color:#ff8fa3; color:#6d3e4e; }
  .tag.estado-sobre-hora  { background:#b2f2bb; border-color:#63d471; color:#245b2a; }
  .tag.is-clickable{ cursor:pointer; user-select:none; }

  /* ====== Modal ====== */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:1200}
  .modal{width:min(900px,95vw);background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);padding:16px;max-height:90vh;overflow:auto}
  .modal h3{margin:0 0 10px;color:#91586d;text-align:center}
  .modal .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .modal label{font-size:13px;font-weight:600;color:#6d6d6d}
  .modal input[type="text"],.modal input[type="date"],.modal select,.modal textarea{width:100%;padding:8px;border:1px solid #94b8a3;border-radius:6px;background:#f9f9f9;font-size:13px}
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{padding:6px 10px;background:#cce1d6;border:1px solid #94b8a3;border-radius:999px;cursor:pointer;font-size:12px;user-select:none}
  .chip.selected{background:#b48a99;border-color:#91586d;color:#fff}
  .modal .footer{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
  .modal .footer button{background:#b48a99;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:13px}
  .switches{display:flex;gap:16px;align-items:center;justify-content:center;margin-bottom:8px}

  /* ====== Mobile ====== */
  @media (max-width:768px){
    #menuToggle{display:block}
    .sidebar{display:none;width:100%;height:auto;position:absolute;top:50px;left:0}
    .sidebar.mostrar{display:block}
    main{margin-left:0;padding:10px}
    .header{flex-direction:column}
    h1{font-size:18px}
    .modal .row{grid-template-columns:1fr}

    .topbar{
      grid-template-columns:1fr 1fr;
      grid-template-areas:
        "tabs actions"
        "week week"
        "search limpiar";
    }
  }

  /* ====== Mobile agenda tweaks ====== */
  @media (max-width: 768px) {
    .agenda-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    #tablaAgenda { border-collapse: separate; border-spacing: 0; min-width: 900px; }
    #tablaAgenda thead th { position: sticky; top: 0; z-index: 3; background:#b07a8a; color:#fff; }
    #tablaAgenda .col-hora { position: sticky; left: 0; z-index: 4; background:#e9f0ec; min-width:66px; width:66px; }
    #tablaAgenda td.slot, #tablaAgenda th[data-fecha]{ min-width:120px; }
    #tablaAgenda td.slot{ height:68px; }
    #sedeSelector{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }
    #sedeSelector .tile{ padding:8px 10px; font-size:13px; }
    .nav-mes{ display:flex; align-items:center; gap:10px; }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:12px; max-width:110px;
      font-size:12px; line-height:1.2; white-space:nowrap;
      overflow:hidden; text-overflow:ellipsis;
    }
    .chip .numero{ font-weight:600; opacity:.85; }
    .chip.recupero{ background:#7f3f74; color:#fff; }
  }

  /* Encabezado y hora pegados tambi√©n en desktop + wrapper */
  #tablaAgenda thead th{ position:sticky; top:0; z-index:2; }
  #tablaAgenda .col-hora{ position:sticky; left:0; z-index:3; background:#f5f7f6; }
  .agenda-wrapper{ overflow-x:auto; }

  /* Resaltado del buscador */
  .tag.find-hit{
    outline:3px solid #ff9800;
    box-shadow:0 0 0 3px rgba(255,152,0,.25);
  }

  /* ===== Tooltip (tag/chip) ===== */
  .tag.has-tooltip, .chip.has-tooltip{ position: relative; }
  .tag.has-tooltip::before, .chip.has-tooltip::before{
    content:""; position:absolute; right:2px; top:2px;
    border-width:0 7px 7px 0; border-style:solid;
    border-color:transparent #e57373 transparent transparent;
  }
  .tag.has-tooltip:hover::after, .chip.has-tooltip:hover::after{
    content: attr(data-tooltip);
    position:absolute; left:0; top:100%; transform: translateY(6px);
    background:#333; color:#fff; padding:8px 10px; border-radius:6px;
    box-shadow:0 6px 20px rgba(0,0,0,.2); width:max-content; max-width:300px;
    white-space:normal; z-index:1000;
  }

/* ===== Men√∫ r√°pido tipo Excel ===== */
.quick-menu{
  position: fixed;          /* relativo al viewport */
  display: none;
  min-width: 220px;
  max-height: 260px;
  overflow: auto;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  box-shadow: 0 10px 25px rgba(0,0,0,.18);
  z-index: 9999;            /* üëà m√°s alto que cualquier overlay */
  font-size: 13px;
}
.quick-menu.drop-up{ box-shadow: 0 -10px 25px rgba(0,0,0,.18); }

.quick-menu .item{display:flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer}
.quick-menu .item:hover{background:#f3f4f6}
.quick-menu .sep{height:1px;background:#eee;margin:2px 0}
.quick-menu .dot{width:10px;height:10px;border-radius:50%}

.quick-menu .asistio    .dot{ background:#fff6bf; border:1px solid #e6d98a; }
.quick-menu .sin_aviso  .dot{ background:#ffe066; border:1px solid #e6b800; }
.quick-menu .con_aviso  .dot{ background:#ffc2d1; border:1px solid #ff8fa3; }
.quick-menu .sobre_hora .dot{ background:#b2f2bb; border:1px solid #63d471; }

/* Solo cambia la sombra cuando abre hacia arriba */
.quick-menu.drop-up{
  box-shadow: 0 -10px 25px rgba(0,0,0,.15);
}


/* === L√≠neas principales m√°s fuertes (d√≠as y horas) === */
table.agenda td.slot{
  border-bottom: 2px solid var(--grid-strong);   /* horizontales entre horas */
}
table.agenda td.slot + td.slot{
  border-left: 2px solid var(--grid-strong);     /* verticales entre d√≠as */
}

/* === L√≠nea interna (separaci√≥n del horario) m√°s suave === */
.half.left{
  border-right: 1px solid var(--grid-line);      /* mantiene la divisi√≥n suave */
}

/* === Grid: intermedias grises claras y bordes gris oscuro === */
:root{
  --grid-line:   #c8c8c8; /* intermedias */
  --grid-border: #4f4f4f; /* bordes/contorno */
}

/* Marco exterior m√°s oscuro */
.agenda-wrap{
  border: 2px solid var(--grid-border);
  border-radius: 10px;        /* mantenemos redondeo */
}

/* Cabecera y √∫ltima fila con borde oscuro */
table.agenda thead th,
#tablaAgenda thead th{
  border-bottom: 2px solid var(--grid-border);
}
table.agenda tbody tr:last-child td,
#tablaAgenda tbody tr:last-child td{
  border-bottom: 2px solid var(--grid-border);
}

/* Derecha del todo m√°s oscura */
table.agenda tbody td.slot:last-child,
#tablaAgenda tbody td.slot:last-child{
  border-right: 2px solid var(--grid-border);
}

/* Separaci√≥n columna de hora (borde fuerte) */
table.agenda .col-hora,
#tablaAgenda .col-hora{
  border-right: 2px solid var(--grid-border);
}

/* L√≠neas internas (entre d√≠as y horas) m√°s suaves en gris */
table.agenda td.slot,
#tablaAgenda td.slot{
  border-bottom: 1px solid var(--grid-line);
}
table.agenda td.slot + td.slot,
#tablaAgenda td.slot + td.slot{
  border-left: 1px solid var(--grid-line);
}

/* Divisi√≥n interna del slot (izq|der) a√∫n m√°s sutil */
.half.left{
  border-right: 1px solid #d6d6d6;
}

/* D√≠a feriado en la agenda */
td.slot.feriado {
  background-color: #d6d6d6 !important;  /* gris fuerte */
}


/* === Separadores principales con el MISMO borde que los costados === */
table.agenda td.slot,
#tablaAgenda td.slot{
  border-bottom: 2px solid var(--grid-border) !important;   /* entre horas */
}

table.agenda td.slot + td.slot,
#tablaAgenda td.slot + td.slot{
  border-left: 2px solid var(--grid-border) !important;     /* entre d√≠as */
}

/* === Divisor interno del horario (mitades) se mantiene suave === */
.half.left{
  border-right: 1px solid var(--grid-line) !important;
}



/* mata cualquier violeta previo y gradientes */
.agenda-wrap table.agenda td.slot .tag.tag-prueba,
.agenda-wrap table.agenda td.slot .tag[data-tipo="prueba"],
.agenda-wrap .tag[data-tipo="prueba"]:not([data-estado]),
.agenda-wrap .tag[data-tipo="prueba"][data-estado=""]{
  background-color: var(--prueba-bg) !important;
  border-color:     var(--prueba-bd) !important;
  color:            var(--prueba-fg) !important;
  background-image: none !important;
}

/* por las dudas, neutralizo la regla antigua */
.tag-prueba{ background: var(--prueba-bg) !important; border-color: var(--prueba-bd) !important; color: var(--prueba-fg) !important; }

/* Pintar TODAS las pruebas en lila, tengan o no estado */
.tag[data-tipo="prueba"]{
  background-color:#EBD9FF !important; /* lila m√°s visible */
  border-color:#CDB8FF !important;
  color:#3b2b72 !important;
  background-image:none !important;
}


/* =================== PRUEBA: fondo lila + anillo por estado =================== */
:root{
  --prueba-bg:  #EBD9FF;  /* lila fondo */
  --prueba-ring:#CDB8FF;  /* lila por defecto */
  --ring-w:     4px;      /* grosor del anillo (sub√≠ a 5-6px si quer√©s m√°s) */
}

/* Fondo lila SIEMPRE y SIN borde; dejamos el anillo como ‚Äúborde visual‚Äù */
.tag[data-tipo="prueba"]{
  background-color: var(--prueba-bg) !important;
  border: none !important;
  color:#3b2b72 !important;
  background-image:none !important;
  box-shadow: 0 0 0 var(--ring-w) var(--prueba-ring) !important; /* anillo lila */
}

/* Anillo por estado (notorio) */
.tag[data-tipo="prueba"].estado-asistio{
  box-shadow: 0 0 0 var(--ring-w) #D4C34A !important; /* amarillo */
}
.tag[data-tipo="prueba"].estado-sin-aviso{
  box-shadow: 0 0 0 var(--ring-w) #E6B800 !important; /* mostaza */
}
.tag[data-tipo="prueba"].estado-con-aviso{
  box-shadow: 0 0 0 var(--ring-w) #FF8FA3 !important; /* rosa */
}
.tag[data-tipo="prueba"].estado-sobre-hora{
  box-shadow: 0 0 0 var(--ring-w) #63D471 !important; /* verde */
}

/* Neutralizo cualquier estilo heredado de .tag-prueba que pueda colarse */
.tag.tag-prueba{
  background-color: var(--prueba-bg) !important;
  border: none !important;
  box-shadow: 0 0 0 var(--ring-w) var(--prueba-ring) !important;
  color:#3b2b72 !important;
}

/* Dropdown del buscador de agenda: pegar al input */
#findAlumnoSelect{
  position: fixed;     /* relativo al viewport */
  z-index: 5000;
  display: none;
  max-height: 260px;   /* por si hay muchos resultados */
  overflow: auto;
}


</style>


</head>
<body>
<button id="menuToggle" onclick="document.querySelector('.sidebar').classList.toggle('mostrar')">‚ò∞</button>

<div class="sidebar">
  <a href="index.html">üìã Alumnas/os</a>
  <a href="pagos.html">üí≥ Pagos</a>
  <a href="gastos.html"   class="menu-gastos">üßæ Gastos</a>
  <a href="agenda.html">üìÖ Agenda</a>
  <a href="configuracion.html">‚öôÔ∏è Configuraci√≥n</a>
  <a href="reportes.html" class="menu-reportes">üìà Reportes</a>
  <button onclick="localStorage.removeItem('etnya_login');location='login.html'" style="width:100%;text-align:left;padding:10px 16px;background:transparent;border:none;color:#fff;font-weight:bold;font-size:13px;border-top:1px solid rgba(255,255,255,.1);cursor:pointer">üö™ Cerrar sesi√≥n</button>
</div>

<main>
  <div class="header">
    <img src="logo.jpeg" alt="Logo">
    <h1>Agenda de Clases</h1>
  </div>

  <div class="topbar">
    <!-- Izquierda: sedes -->
    <div class="sede-tabs">
      <button id="tabReformer" class="active" onclick="cambiarSede('Craig Reformer')">Craig Reformer</button>
      <button id="tabCircuito" onclick="cambiarSede('Craig Circuito')">Craig Circuito</button>
      <button id="tabGoyena" onclick="cambiarSede('Pedro Goyena')">Pedro Goyena</button>
    </div>

    <!-- Centro: selector de semana -->
    <div class="week-nav">
      <button onclick="moverSemana(-1)">‚óÄ</button>
      <div class="week-label" id="labelMes"></div>
      <button onclick="moverSemana(1)">‚ñ∂</button>
    </div>

    <!-- Derecha: acci√≥n -->
    <div class="actions">
      <button type="button" onclick="abrirModal()">+ Registrar clase</button>
    </div>

    <!-- Fila 2: buscador + limpiar juntos -->
    <div class="search-wrap">
      <input id="findAlumnoInput" type="text"
             placeholder="Buscar alumno (nro, apellido, nombre)" style="min-width:260px">
      <select id="findAlumnoSelect" size="6"
        style="display:none;z-index:1300;max-height:220px;overflow:auto;"></select>
      <button id="btnLimpiarFind" type="button">Limpiar selecci√≥n</button>
    </div>
  </div>

  <!-- Grilla de agenda -->
  <div class="agenda-wrap">
    <div class="agenda-wrapper">
      <table class="agenda" id="tablaAgenda"></table>
    </div>
  </div>
</main>



<!-- ====== Modal Registrar ====== -->
<div class="overlay" id="overlay">
  <div class="modal">
    <h3>Registrar clase</h3>

    <div class="switches">
      <label><input type="checkbox" id="chkUnica"  onchange="toggleModo('unica')"> Clase de Recuperaci√≥n</label>
      <label><input type="checkbox" id="chkPrueba" onchange="toggleModo('prueba')"> Clase de prueba</label>
    </div>

    <div class="row">
      <!-- IZQUIERDA -->
      <div>
        <label>Buscar alumna/o</label>
        <input type="text" id="buscadorAlumno" placeholder="Ingres√° nombre o n√∫mero" oninput="filtrarAlumnos()">
        <select id="selectAlumno" size="6" style="margin-top:6px;"></select>

        <!-- Datos del alumno (debajo del listado) -->
        <div id="boxDatosAlumno" style="margin-top:8px;border:1px dashed #e0e0e0;border-radius:8px;padding:8px;background:#fafafa">
          <label style="display:block;margin-bottom:4px;">Datos del alumno</label>
          <div id="datosAlumno" style="font-size:13px; line-height:1.35; color:#555"></div>
        </div>
      </div>

      <!-- DERECHA -->
      <div>
        <label>Sede principal</label>
        <select id="selectSede" onchange="onSedeChange()">
          <option value="">Seleccionar sede...</option>
          <option>Craig Reformer</option>
          <option>Craig Circuito</option>
          <option>Pedro Goyena</option>
        </select>

        <!-- Recurrente -->
        <div id="boxRecurrente" style="margin-top:10px;">
          <label>D√≠as (seg√∫n sede)</label>
          <div class="chips" id="chipsDias"></div>
          <div style="margin-top:10px;">
            <label>Hora para todos los d√≠as</label>
            <select id="selectHoraGeneral"><option value="">Seleccionar hora...</option></select>
          </div>
          <div id="perDia" style="margin-top:10px;"></div>
          <small>Se generar√°n las clases seleccionadas desde la semana visible hasta fin de a√±o.</small>
        </div>

        <!-- Situaci√≥n actual -->
        <div id="boxSituacion" style="margin-top:10px;border-top:1px dashed #e0e0e0;padding-top:8px;">
          <label>Situaci√≥n actual (desde la semana visible)</label>
          <div id="situacionActual" class="chips"></div>
          <div style="margin-top:8px; display:flex; justify-content:flex-end;">
            <button id="btnEliminarClases"
                    style="background:#e57373;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">
              Eliminar todas (desde esta semana)
            </button>
          </div>
        </div>

        <!-- √önica -->
        <div id="boxUnica" style="display:none;margin-top:10px;">
          <label>Fecha √∫nica</label>
          <input type="date" id="fechaUnica">
          <div style="margin-top:10px;">
            <label>Hora</label>
            <select id="horaUnica"><option value="">Seleccionar hora...</option></select>
          </div>
        </div>

        <!-- Prueba -->
        <div id="boxPrueba" style="display:none;margin-top:10px;">
          <div style="margin-top:10px;">
            <label>Nombre (prueba)</label>
            <input type="text" id="nombrePrueba" placeholder="Ingres√° nombre">
          </div>
          <label>Observaci√≥n</label>
          <textarea id="notaPrueba" rows="3" placeholder="Escrib√≠ una breve nota..."></textarea>
          <div style="margin-top:10px;" class="row">
            <div>
              <label>Fecha</label>
              <input type="date" id="fechaPrueba">
            </div>
            <div>
              <label>Hora</label>
              <select id="horaPrueba"><option value="">Seleccionar hora...</option></select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <button onclick="cerrarModal()">Cerrar</button>
      <button onclick="guardarClase()">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal detalle de clase -->
<div class="overlay" id="overlayClase">
  <div class="modal">
    <h3>Detalle de clase</h3>
    <div id="claseInfo" style="margin-bottom:10px;color:#6d6d6d;font-size:13px"></div>

    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:8px;">
      <label><input type="checkbox" id="chkAsistio"> Asisti√≥</label>
      <label><input type="checkbox" id="chkSinAviso"> Ausente sin aviso</label>
      <label><input type="checkbox" id="chkConAviso"> Ausente con aviso</label>
      <label><input type="checkbox" id="chkSobreHora"> Ausente sobre la hora</label>
    </div>

  <div class="footer">
  <button onclick="cerrarModalClase()">Cerrar</button>
  <button onclick="guardarEstadoClase()">Guardar</button>
  <button onclick="eliminarClaseSeleccionada()" style="background:#e57373">Eliminar clase</button>
</div>

<div id="detalleObservacion" style="margin-top:10px; width:100%;">
  <label>Observaci√≥n</label>
  <textarea id="observacionClase" rows="2" style="width:100%;"></textarea>
</div>




  </div>
</div>

<script>
  (function () {
    // 1) Forzar login
    if (localStorage.getItem('etnya_login') !== 'ok') {
      location = 'login.html';
      return;
    }

    // 2) Rol del usuario
    const rol = localStorage.getItem('etnya_role') || '';

    // 3) Ocultar men√∫ si no es admin (sin alert)
    if (rol !== 'admin') {
      document.querySelectorAll('.menu-reportes, .menu-gastos')
        .forEach(el => el.style.display = 'none');
    }

    // 4) Bloqueo silencioso de p√°ginas restringidas (sin alert)
    const restricted = { 'reportes.html': 'admin', 'gastos.html': 'admin' };
    const page = (location.pathname.split('/').pop() || '').toLowerCase();
    if (restricted[page] && rol !== restricted[page]) {
      location = 'index.html';
    }
  })();
</script>



<script>
  // ===== Guardia de login =====
  if (localStorage.getItem('etnya_login') !== 'ok') location = 'login.html';

  // ===== Timeout de sesi√≥n (6 horas sin actividad) =====
  (function sessionTimeout() {
    const SESSION_TIMEOUT_MS = 6 * 60 * 60 * 1000; // 6h
    const KEY_LOGIN = 'etnya_login';
    const KEY_LAST  = 'etnya_lastActivity';

    const now = () => Date.now();
    const isLogged = () => localStorage.getItem(KEY_LOGIN) === 'ok';
    const setLast = (t = now()) => localStorage.setItem(KEY_LAST, String(t));
    const getLast = () => {
      const v = Number(localStorage.getItem(KEY_LAST));
      return Number.isFinite(v) ? v : 0;
    };
    const expire = () => {
      if (!isLogged()) return; // evitar dobles entre pesta√±as
      alert('Sesi√≥n expirada por inactividad. Volv√© a iniciar sesi√≥n.');
      localStorage.removeItem(KEY_LOGIN);
      if (!location.pathname.endsWith('/login.html')) location.href = 'login.html';
    };

    // Registrar actividad (throttle para no spamear)
    let throttled = false;
    const markActivity = () => {
      if (document.visibilityState === 'hidden') return;
      if (throttled) return;
      throttled = true;
      setLast();
      setTimeout(() => (throttled = false), 500);
    };
    ['mousemove','mousedown','keydown','scroll','click','touchstart','visibilitychange']
      .forEach(ev => window.addEventListener(ev, markActivity, { passive: true }));

    // Sincronizar entre pesta√±as
    window.addEventListener('storage', (e) => {
      if (e.key === KEY_LOGIN && e.newValue !== 'ok') expire();
    });

    // Chequeo peri√≥dico
    const check = () => {
      if (!isLogged()) return;
      const last = getLast();
      if (!last) return setLast(); // primera actividad de la sesi√≥n
      if (now() - last > SESSION_TIMEOUT_MS) expire();
    };
    setInterval(check, 60 * 1000); // cada 1 min
    if (isLogged()) setLast();     // marcar al cargar
  })();

  // ===== App =====
  const MESES=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const DIAS =['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
  const SEDES={
    'Craig Reformer':{dias:[1,2,3,4,5],desde:9,hasta:20},
    'Craig Circuito':{dias:[1,2,3,4,5],desde:9,hasta:20},
    'Pedro Goyena': {dias:[1,2,3,4,5,6],desde:8,hasta:21}
  };

  let sedeSeleccionada='Craig Reformer';
  let semanaInicio=getLunes(new Date());
  let alumnos=[], clasesSemana=[];

// ==== VISTAS: Semana / D√≠a ==================================================
let vista = (window.innerWidth <= 768) ? 'dia' : 'semana';

const btnSemana   = document.getElementById('btnSemana');
const btnDia      = document.getElementById('btnDia');
const selectorDia = document.getElementById('selectorDia');

if (btnSemana) btnSemana.onclick = () => { vista = 'semana'; renderAgenda(); };
if (btnDia)    btnDia.onclick    = () => { vista = 'dia';    renderAgenda(); };

// Adaptador: usamos tu render semanal actual
const renderSemana = async () => {
  // Redibuja la semana actual
  await cargarSemana(); // construye la grilla + carga y pinta clases

  // (opcional) preparar el selector de d√≠as para cuando pases a vista d√≠a
  if (typeof prepararSelectorDia === 'function') {
    prepararSelectorDia(obtenerFechasSemana());
  }

};

function renderAgenda() {
  if (vista === 'dia') {
    if (selectorDia) selectorDia.style.display = 'inline-block';
    renderDia();
  } else {
    if (selectorDia) selectorDia.style.display = 'none';
    renderSemana();
  }
}

// Devuelve array de YYYY-MM-DD de la semana visible, seg√∫n tus utilidades
function obtenerFechasSemana() {
  const dias = diasHabilitados(sedeSeleccionada);  // ya la us√°s
  const lunes = semanaInicio;                       // ya lo ten√©s global
  return dias.map(d => ymd(addDays(lunes, d - 1))); // ya ten√©s ymd/addDays
}

// Carga el select de d√≠a
function prepararSelectorDia(diasSemana) {
  if (!selectorDia) return;
  selectorDia.innerHTML = '';
  diasSemana.forEach(d => {
    const dt = new Date(d);
    const label = dt.toLocaleDateString('es-AR', { weekday: 'short', day: '2-digit', month: '2-digit' });
    const opt = document.createElement('option');
    opt.value = d; opt.textContent = label;
    selectorDia.appendChild(opt);
  });
  selectorDia.onchange = renderDia;
}

// Render de un solo d√≠a en formato lista por hora
function renderDia() {
  const cont = document.querySelector('.agenda-wrapper');
  if (!cont) return;

  const diasSemana = obtenerFechasSemana();
  const dia = (selectorDia && selectorDia.value) ? selectorDia.value : diasSemana[0];

  // Filtramos clases de ese d√≠a (y sede, si corresponde)
  const clasesDelDia = (window.clasesSemana || []).filter(c => {
    const sedeOK = (sedeSeleccionada === 'Todas') ? true : (String(c.sede || '').trim() === String(sedeSeleccionada).trim());
    return c.fecha === dia && sedeOK;
  });

  // Agrupar por hora normalizada
  const byHora = {};
  for (const c of clasesDelDia) {
    const h = normTime(c.hora);
    (byHora[h] ||= []).push(c);
  }

  // Construir lista
  cont.innerHTML = '';
  const ul = document.createElement('ul');
  ul.style.listStyle = 'none';
  ul.style.padding = '0 12px';

  Object.keys(byHora).sort().forEach(h => {
    const li = document.createElement('li');
    li.style.margin = '10px 0';
    li.style.padding = '10px';
    li.style.background = '#fff';
    li.style.borderRadius = '12px';

    const titulo = document.createElement('div');
    titulo.style.fontWeight = '600';
    titulo.textContent = h;

    const fila = document.createElement('div');
    fila.style.display = 'flex';
    fila.style.flexWrap = 'wrap';
    fila.style.gap = '8px';
    fila.style.marginTop = '8px';

    byHora[h].forEach(c => {
      const chip = document.createElement('span');
      chip.className = 'chip' + (c.recupero ? ' recupero' : '');
      const numero = c.numero || c.numero_alumno || '';
      const nombre = c.nombre || c.alumno_nombre || '';
      chip.innerHTML = `<span class="numero">${numero}</span> ${nombre}`;
      fila.appendChild(chip);
    });

    li.appendChild(titulo);
    li.appendChild(fila);
    ul.appendChild(li);
  });

  cont.appendChild(ul);
}

// Cambiar autom√°ticamente seg√∫n ancho
window.addEventListener('resize', () => {
  const nueva = (window.innerWidth <= 768) ? 'dia' : 'semana';
  if (nueva !== vista) {
    vista = nueva;
    renderAgenda();
  }
});


// ===== Utils =====
function getLunes(d){const x=new Date(d);const day=(x.getDay()+6)%7;x.setDate(x.getDate()-day);x.setHours(0,0,0,0);return x}
function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x}
function ymd(d){return d.toISOString().slice(0,10)}
function humanHour(h){return String(h).padStart(2,'0')+':00'} // muestra HH:MM
function rangoHoras(s){const {desde,hasta}=SEDES[s];const a=[];for(let h=desde;h<=hasta;h++)a.push(humanHour(h));return a}
function diasHabilitados(s){return SEDES[s].dias}
// ‚ö†Ô∏è Normalizar: '10:00' -> '10:00:00'

function normSede(s){ return String(s || '').trim().toLowerCase(); }  // ‚Üê agregar ac√°

function normTime(t){ return t && t.length===5 ? t+':00' : t; }   // '10:00' -> '10:00:00'

function normDate(d){ return d && d.length>=10 ? d.slice(0,10) : d; } // '2025-08-19T...' -> '2025-08-19'

// ===== Datos del alumno (ficha en el modal) =====
function calcularEdad(iso){
  if (!iso) return '';
  const d = new Date(String(iso).slice(0,10));
  if (isNaN(d)) return '';
  const hoy = new Date();
  let e = hoy.getFullYear() - d.getFullYear();
  const m = hoy.getMonth() - d.getMonth();
  if (m < 0 || (m === 0 && hoy.getDate() < d.getDate())) e--;
  return e;
}

function renderDatosAlumno(alumnoId){
  const box = document.getElementById('datosAlumno');
  if (!box){ return; }
  if (!alumnoId){ box.innerHTML = ''; return; }

  // usar el array real; si por alg√∫n motivo est√° vac√≠o, caemos al global auxiliar
  const list = (alumnos && alumnos.length) ? alumnos : (window.alumnosGlobal || []);
  const a = list.find(x => Number(x.id) === Number(alumnoId));
  if (!a){ box.innerHTML = ''; return; }

  const edad = calcularEdad(a.fecha_nacimiento);
  const num  = (a.numero != null)
    ? (String(a.numero).includes('-') ? String(a.numero) : String(a.numero).padStart(2,'0'))
    : '';

  box.innerHTML = `
    <div><b>N¬∞ socio:</b> ${num || '-'}</div>
    <div><b>Apellido:</b> ${a.apellido || '-'}</div>
    <div><b>Nombre:</b> ${a.nombre || '-'}</div>
    <div><b>Tel√©fono:</b> ${a.telefono || '-'}</div>
    <div><b>Edad:</b> ${edad ? edad + ' a√±os' : '-'}</div>
    <div><b>Sede:</b> ${a.sede || '-'}</div>
    <div><b>Modalidad:</b> ${a.modalidad || '-'}</div>
  `;
}



let clasesAlumnoActual = [];  // clases futuras del alumno seleccionado

function dowNumFromYMD(ymd){
  const d = new Date(ymd + 'T00:00:00');
  const w = d.getDay();      // 0..6  (0=Dom)
  return w === 0 ? 7 : w;    // 1..7  (1=Lun)
}

// clave para comparar patrones (d√≠a de semana + hora + sede)
function groupKey(dow, hora, sede){
  return `${dow}|${normTime(hora)}|${(sede||'').trim()}`;
}

// ===== Header / navegaci√≥n =====
function actualizarHeader(){document.getElementById('labelMes').textContent=MESES[semanaInicio.getMonth()]+' '+semanaInicio.getFullYear()}
function moverSemana(d){semanaInicio=addDays(semanaInicio,7*d);cargarSemana()}
function cambiarSede(s){sedeSeleccionada=s;['tabReformer','tabCircuito','tabGoyena'].forEach(id=>document.getElementById(id).classList.remove('active'));
  if(s==='Craig Reformer')tabReformer.classList.add('active');
  if(s==='Craig Circuito')tabCircuito.classList.add('active');
  if(s==='Pedro Goyena')tabGoyena.classList.add('active');
  cargarSemana()
}

/* ========== Construcci√≥n grilla (1 slot por hora/d√≠a) ========== */
function construirTablaBase(){
  // Asegurar que exista la tabla dentro de .agenda-wrapper
  let tabla = document.getElementById('tablaAgenda');
  if (!tabla) {
    const wrap = document.querySelector('.agenda-wrapper');
    if (!wrap) return;                          // si no existe el contenedor, salgo
    wrap.innerHTML = '';
    tabla = document.createElement('table');
    tabla.id = 'tablaAgenda';
    tabla.className = 'agenda';
    wrap.appendChild(tabla);
  } else {
    tabla.innerHTML = '';
  }

  // THEAD
  const thead = document.createElement('thead');
  const trh = document.createElement('tr');

  const thHora = document.createElement('th');
  thHora.className = 'col-hora';
  thHora.textContent = 'Hora';
  trh.appendChild(thHora);

  const dias = diasHabilitados(sedeSeleccionada);
  const lunes = semanaInicio;

  for (const dow of dias){
    const fecha = addDays(lunes, dow - 1);
    const th = document.createElement('th');
    th.dataset.fecha = ymd(fecha);
    th.textContent = `${DIAS[dow]} ${String(fecha.getDate()).padStart(2,'0')}/${String(fecha.getMonth()+1).padStart(2,'0')}`;
    trh.appendChild(th);
  }
  thead.appendChild(trh);

  // TBODY
  const tbody = document.createElement('tbody');
  const horas = rangoHoras(sedeSeleccionada);

  horas.forEach(hh => {
    const tr = document.createElement('tr');

    const tdHora = document.createElement('td');
    tdHora.className = 'col-hora';
    tdHora.textContent = hh;
    tr.appendChild(tdHora);

    dias.forEach(dow => {
      const td = document.createElement('td');
      td.className = 'slot';
      td.dataset.fecha = ymd(addDays(semanaInicio, dow - 1));
      td.dataset.hora  = normTime(hh);      // guardamos con segundos
      td.dataset.sede  = sedeSeleccionada;

      td.innerHTML = `
        <div class="slot-inner">
          <div class="half left"></div>
          <div class="half right"></div>
        </div>
      `;

      td.addEventListener('dblclick', onSlotDblClick);
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  tabla.appendChild(thead);
  tabla.appendChild(tbody);
}

// Normaliza strings para b√∫squedas (min√∫sculas + sin acentos)
function normTxt(s){
  return String(s || '')
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, ''); // quita tildes
}


// ===== Buscador de agenda (nro / apellido / nombre) =====

// Normaliza (min√∫sculas + sin acentos)
function normTxt(s){
  return String(s || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
}

// √çndice (preferimos /alumnos; si no est√°, lo armamos desde los chips)
window.idxAlumnos = window.idxAlumnos || [];

function buildIdxFromAlumnos(){
  const src = Array.isArray(window.alumnos) ? window.alumnos : [];
  window.idxAlumnos = src.map(a => {
    const id  = a.id ?? a.alumno_id ?? 0;
    const raw = String(a.numero ?? a.numero_alumno ?? '').trim();
    const num = raw ? (raw.includes('-') ? raw : raw.padStart(2,'0')) : '';
    const ape = String(a.apellido || '').trim();
    const nom = String(a.nombre   || '').trim();
    const labelBase = ape && nom ? `${ape}, ${nom}` : `${ape}${ape && nom ? ' ' : ''}${nom}`;
    const label = `${num ? num + ' - ' : ''}${labelBase}`.trim();
    const needle = normTxt(`${num} ${raw} ${ape} ${nom} ${labelBase}`);
    return { id, numero: num, label, needle };
   
  });
window._idxSource = 'alumnos';
}

function buildIdxFromDOM(){
  const map = new Map(); // id -> {id, numero, label, needle}
  document.querySelectorAll('.tag[data-alumno-id]').forEach(tag => {
    const id  = Number(tag.dataset.alumnoId || 0);
    if (!id) return;
    const numero = String(tag.dataset.numero || '').trim();
    const nombre = String(tag.dataset.nombre || tag.textContent || '').trim();
    const label  = `${numero ? numero + ' - ' : ''}${nombre}`;
    const needle = normTxt(`${numero} ${nombre}`);
    if (!map.has(id)) map.set(id, { id, numero, label, needle });
  });
  window.idxAlumnos = Array.from(map.values());
  window._idxSource = 'dom';

}

// Asegura tener √≠ndice (alumnos o DOM)
function ensureIndex(){
  if (Array.isArray(window.alumnos) && window.alumnos.length){
    buildIdxFromAlumnos();
  } else if (!Array.isArray(window.idxAlumnos) || window.idxAlumnos.length === 0){
    buildIdxFromDOM();
  }
}

// Elementos UI
const $findIn   = document.getElementById('findAlumnoInput');
const $findDrop = document.getElementById('findAlumnoSelect');
const $findClr  = document.getElementById('btnLimpiarFind');

let alumnoFindSel = null;

// Garantiza √≠ndice con apellido si el usuario escribe letras
async function ensureIndexReady(queryNorm){
  const hasLetters = /[a-z]/i.test(queryNorm || '');

  // Si ya tenemos √≠ndice desde /alumnos, listo
  if (window._idxSource === 'alumnos' && Array.isArray(window.idxAlumnos) && window.idxAlumnos.length) return;

  // Si hay letras y el √≠ndice es del DOM (sin apellidos), intent√° ‚Äúupgradearlo‚Äù
  if (hasLetters && window._idxSource !== 'alumnos' && typeof window.cargarAlumnos === 'function' && !window._loadingAlumnosForSearch){
    window._loadingAlumnosForSearch = true;
    try{
      await window.cargarAlumnos();   // arma window.alumnos
      if (typeof buildIdxFromAlumnos === 'function') buildIdxFromAlumnos();
      if (Array.isArray(window.idxAlumnos) && window.idxAlumnos.length){
        return; // ya quedamos con apellidos
      }
    }catch(_e){}
    finally{
      window._loadingAlumnosForSearch = false;
    }
  }

  // Fallbacks
  if (Array.isArray(window.alumnos) && window.alumnos.length){
    if (typeof buildIdxFromAlumnos === 'function') buildIdxFromAlumnos();
  } else if (!Array.isArray(window.idxAlumnos) || !window.idxAlumnos.length){
    if (typeof buildIdxFromDOM === 'function') buildIdxFromDOM();
  }
}


// Sugerencias
async function showFindOptions(text){
  if (!$findIn || !$findDrop) return;

  const q = normTxt(text);
  await ensureIndexReady(q);  // üëà garantiza √≠ndice con apellido si se puede

  const items = q
    ? (window.idxAlumnos || []).filter(x => x.needle.includes(q)).slice(0, 60)
    : [];

  $findDrop.innerHTML = '';
  if (!items.length){ $findDrop.style.display = 'none'; return; }

  for (const x of items){
    const opt = document.createElement('option');
    opt.value = String(x.id);
    opt.textContent = x.label; // "NN - Apellido, Nombre"
    $findDrop.appendChild(opt);
  }

  const r = $findIn.getBoundingClientRect();
  $findDrop.style.position = 'fixed';    // asegura que no lo pise nada
  $findDrop.style.left   = r.left + 'px';
  $findDrop.style.top    = r.bottom + 'px';   // üëà fixed
  $findDrop.style.width  = r.width + 'px';
  $findDrop.style.display = 'block';
}

// Limpiar
function clearFindSelection(){
  alumnoFindSel = null;
  if ($findIn)   $findIn.value = '';
  if ($findDrop) $findDrop.style.display = 'none';
  document.querySelectorAll('.tag.find-hit').forEach(el => el.classList.remove('find-hit'));
}

// Resaltar en la semana
function selectAlumnoEnSemana(alumnoId){
  alumnoFindSel = Number(alumnoId) || null;
  document.querySelectorAll('.tag.find-hit').forEach(el => el.classList.remove('find-hit'));
  if (!alumnoFindSel) return;
  let hits = 0;
  document.querySelectorAll('.tag').forEach(tag => {
    const aid = Number(tag.dataset.alumnoId || 0);
    if (aid === alumnoFindSel){ tag.classList.add('find-hit'); hits++; }
  });
  if (hits){
    const first = document.querySelector('.tag.find-hit');
    if (first) first.scrollIntoView({ behavior:'smooth', block:'center', inline:'center' });
  }
}

// Mantener resaltado tras repintar (envolvemos una sola vez)
if (!window._agendaSearchWrapped){
  const _pintarClases = pintarClases;
  window.pintarClases = function(){
    _pintarClases.apply(this, arguments);
    if (alumnoFindSel) selectAlumnoEnSemana(alumnoFindSel);
  };
  window._agendaSearchWrapped = true;
}

// Eventos
if ($findIn){
  $findIn.addEventListener('input', e => showFindOptions(e.target.value));
  $findIn.addEventListener('keydown', async e => {
    if (e.key === 'ArrowDown'){
      if ($findDrop && $findDrop.options.length === 0) showFindOptions($findIn.value);
      if ($findDrop){ $findDrop.style.display = 'block'; $findDrop.focus(); if ($findDrop.options.length) $findDrop.selectedIndex = 0; }
    }
    if (e.key === 'Escape'){ if ($findDrop) $findDrop.style.display = 'none'; }
    if (e.key === 'Enter'){
  const t = normTxt($findIn.value);
  await ensureIndexReady(t);
  const m = (window.idxAlumnos || []).find(x => x.needle.includes(t));
  if (m) selectAlumnoEnSemana(m.id);
}

  });

}

if ($findDrop){
  $findDrop.addEventListener('change', () => {
    const id  = Number($findDrop.value || 0);
    const opt = $findDrop.options[$findDrop.selectedIndex];
    if (opt && $findIn) $findIn.value = opt.textContent || '';
    $findDrop.style.display = 'none';
    if (id) selectAlumnoEnSemana(id);
  });
  $findDrop.addEventListener('keydown', e => {
    if (e.key === 'Enter'){ $findDrop.dispatchEvent(new Event('change')); }
    if (e.key === 'Escape'){ $findDrop.style.display = 'none'; $findIn?.focus(); }
  });
}
$findClr?.addEventListener('click', clearFindSelection);

// Si al cargar alumnos (fetch) actualiz√°s window.alumnos, llam√° a:
if (typeof window.cargarAlumnos === 'function'){
  const _cargarAlumnos = window.cargarAlumnos;
  window.cargarAlumnos = async function(){
    const r = await _cargarAlumnos.apply(this, arguments);
    // reconstruir √≠ndice a partir de /alumnos
    buildIdxFromAlumnos();
    // refrescar sugerencias si el usuario ya comenz√≥ a tipear
    if ($findIn && $findIn.value) showFindOptions($findIn.value);
    return r;
  };
}

// === Alias para compatibilidad con cargarAlumnos() ===
// Si no existe buildIdxAlumnos, la definimos usando los constructores nuevos.
if (typeof window.buildIdxAlumnos !== 'function'){
  window.buildIdxAlumnos = function(){
    // Preferimos el √≠ndice desde /alumnos; si a√∫n no lleg√≥, lo armamos desde los chips de la agenda
    if (Array.isArray(window.alumnos) && window.alumnos.length) {
      if (typeof window.buildIdxFromAlumnos === 'function') window.buildIdxFromAlumnos();
    } else {
      if (typeof window.buildIdxFromDOM === 'function') window.buildIdxFromDOM();
    }
  };
}



/* ===== Datos ===== */
async function cargarAlumnos(){
  const res = await fetch('/alumnos');
  const data = await res.json();
  alumnos = data.map(a => ({
    id: a.id,
    numero: a.numero_alumno,
    nombre: a.nombre,
    apellido: a.apellido,
    telefono: a.telefono || a.celular || '',
    fecha_nacimiento: a.fecha_nacimiento || a.nacimiento || '',
    sede: a.sede || '',
    modalidad: a.modalidad || a.tipo_clase || a.modalidad_nombre || ''
  }));
  window.alumnosGlobal = alumnos;   // üëà √∫til para otras funciones
  poblarListaAlumnos('');
  buildIdxAlumnos();
}

function poblarListaAlumnos(f=''){
  const sel = document.getElementById('selectAlumno');
  sel.innerHTML = '';
  const t = (f || '').trim().toLowerCase();
  if (!t) return;

  const list = alumnos.filter(a => {
    const rawNum = String(a.numero || '').trim();
    const numVis = rawNum.includes('-') ? rawNum : String(rawNum).padStart(2,'0');
    const label  = `${numVis} - ${a.apellido||''}, ${a.nombre||''}`.toLowerCase();
    return numVis.toLowerCase().includes(t) || label.includes(t);
  });

  list.slice(0, 200).forEach(a => {
    const opt = document.createElement('option');
    opt.value = a.id;
    const rawNum = String(a.numero || '').trim();
    const numVis = rawNum.includes('-') ? rawNum : String(rawNum).padStart(2,'0');
    opt.textContent = `${numVis} - ${a.apellido||''}, ${a.nombre||''}`;
    sel.appendChild(opt);
  });

  // ‚§µÔ∏è si hay resultados: elegir primero y renderizar ficha + situaci√≥n
  if (sel.options.length > 0){
    sel.selectedIndex = 0;
    const id = Number(sel.value) || 0;
    renderDatosAlumno(id);
    cargarSituacionAlumno(id);
  }
}
function filtrarAlumnos(){poblarListaAlumnos(document.getElementById('buscadorAlumno').value)}

async function cargarClasesSemana(){
  const desde = ymd(semanaInicio);
  const dias  = diasHabilitados(sedeSeleccionada) || [1,2,3,4,5];
  const hasta = ymd(addDays(semanaInicio, Math.max(...dias)));

  const params = new URLSearchParams();
  params.set('desde', desde);
  params.set('hasta', hasta);
  params.set('sede', sedeSeleccionada || '');

  const url = `/clases?${params.toString()}`;

  try{
    const res = await fetch(url);
    if (!res.ok){
      const txt = await res.text().catch(()=> '');
      console.error('GET /clases fallo', res.status, txt);
      clasesSemana = [];
      return;
    }

    const data = await res.json();
    if (!Array.isArray(data)){
      console.warn('GET /clases no devolvi√≥ array:', data);
      clasesSemana = [];
      return;
    }

   clasesSemana = data.map(c => ({
  ...c,
  fecha  : normDate(c.fecha),
  hora   : normTime(c.hora),
  sede   : (c.sede || '').trim(),
  estado : c.estado || null,
  alumno_id : c.alumno_id ?? null,
  nota       : (c.nota || '').trim(),
  observacion: (c.observacion || c.obs || c.motivo || '').trim(), // üëà agregado
  tipo   : c.tipo ?? (
            c.es_prueba ? 'prueba' :
            (c.es_recuperacion || c.unica_vez || c.recuperacion ? 'recuperacion' : null)
          )
})).filter(c => c.sede === sedeSeleccionada);



  }catch(err){
    console.error('Error de red/parseo en /clases:', err);
    clasesSemana = [];
  }
}

// ---- Bloqueos "no clases" para Agenda ----
let noClases = [];

function dowFromYMD(ymd){
  const d = new Date(String(ymd).slice(0,10) + 'T00:00:00');
  const w = d.getDay();         // 0=Dom..6=S√°b
  return w === 0 ? 7 : w;       // 1=Lun..7=Dom
}

async function cargarNoClases() {
  try {
    const res = await fetch('/no-clases');
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();

    // Normalizamos para comparaciones r√°pidas en agenda / combos
window.noClases = noClases = (Array.isArray(data) ? data : []).map(r => ({
  sede: String(r.sede || '').trim(),
  dow : Number(r.dow || 0),
  hora: normTime(r.hora) // 'HH:MM' -> 'HH:MM:SS'
}));


    // Si la agenda ya est√° dibujada, repintamos
    if (typeof pintarClases === 'function') pintarClases();
    if (typeof initHorasPorDia === 'function') initHorasPorDia();
  } catch (e) {
    console.error('Error /no-clases', e);
    window.noClases = noClases = [];
  }
}


/* ================== SITUACI√ìN DEL ALUMNO (futuras) ================== */
async function cargarSituacionAlumno(alumnoId) {
  const cont = document.getElementById('situacionActual');

  // Sin selecci√≥n: limpiar todo
  if (!alumnoId) {
    window.clasesAlumnoActual = [];
    if (cont) cont.innerHTML = '';
    const btn0 = document.getElementById('btnEliminarClases');
    if (btn0) {
      btn0.disabled = true;
      btn0.style.opacity = '0.5';
      btn0.style.cursor  = 'not-allowed';
    }
    if (typeof renderDatosAlumno === 'function') renderDatosAlumno(0);
    return;
  }

  // Mostrar ficha del alumno (n√∫mero, apellido, etc.)
  if (typeof renderDatosAlumno === 'function') renderDatosAlumno(alumnoId);

  // Rango: desde inicio de la semana hasta fin de a√±o
  const desde = ymd(semanaInicio);
  const fin   = ymd(new Date(semanaInicio.getFullYear(), 11, 31));

  try {
    const res = await fetch(`/clases?alumno_id=${alumnoId}&desde=${desde}&hasta=${fin}`);
    if (!res.ok) {
      console.error('GET /clases fallo', res.status, await res.text().catch(() => ''));
      window.clasesAlumnoActual = [];
    } else {
      const data = await res.json();
      window.clasesAlumnoActual = (Array.isArray(data) ? data : [])
        .map(c => ({
          ...c,
          fecha: normDate(c.fecha),      // 'YYYY-MM-DD'
          hora : normTime(c.hora),       // 'HH:MM:SS'
          sede : (c.sede || '').trim()
        }))
        .filter(c => c.fecha >= desde);
    }
  } catch (err) {
    console.error('Error cargando clases del alumno:', err);
    window.clasesAlumnoActual = [];
  }

  // Render de chips agrupados por patr√≥n (d√≠a/hora/sede)
  if (!cont) return;
  cont.innerHTML = '';

  if (!window.clasesAlumnoActual.length) {
    cont.textContent = 'Sin clases futuras.';
  } else {
    const DIAS_TXT_LOCAL =
      (Array.isArray(window.DIAS) ? window.DIAS : null) ||
      (Array.isArray(window.DIAS_TXT) ? window.DIAS_TXT : null) ||
      ['', 'Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado','Domingo'];

    // Helper dow si no existe uno global
    const _dowNumFromYMD = (typeof dowNumFromYMD === 'function')
      ? dowNumFromYMD
      : (ymdStr => {
          // ymdStr: 'YYYY-MM-DD' ‚Üí 1..7 (Lun..Dom)
          const [y,m,d] = ymdStr.split('-').map(n => parseInt(n,10));
          const js = new Date(y, (m-1), d);
          let w = js.getDay(); // 0..6 (Dom..S√°b)
          return w === 0 ? 7 : w;
        });

    const mapa = new Map(); // key: dow|hora|sede -> count
    for (const c of window.clasesAlumnoActual) {
      const key = `${_dowNumFromYMD(c.fecha)}|${c.hora}|${c.sede}`;
      mapa.set(key, (mapa.get(key) || 0) + 1);
    }

    for (const [key, cant] of mapa.entries()) {
      const [dow, hora, sede] = key.split('|');
      const chip = document.createElement('div');
      chip.className = 'chip';
      chip.textContent = `${DIAS_TXT_LOCAL[parseInt(dow,10)]} ${hora.slice(0,5)} ¬∑ ${sede} (${cant})`;
      cont.appendChild(chip);
    }
  }

  // Estado del bot√≥n "Eliminar todas"
  const btn = document.getElementById('btnEliminarClases');
  if (btn) {
    const tiene = window.clasesAlumnoActual.length > 0;
    btn.disabled = !tiene;
    btn.style.opacity = tiene ? '1' : '0.5';
    btn.style.cursor  = tiene ? 'pointer' : 'not-allowed';
  }
}


/* ===================== ELIMINAR CLASES DEL ALUMNO ==================== */
async function eliminarClasesAlumno() {
  const alumno_id = parseInt((window.selectAlumno?.value ?? 0), 10) || 0;
  if (!alumno_id) { alert('Primero eleg√≠ una/o.'); return; }

  const ids = (window.clasesAlumnoActual || []).map(c => c.id);
  if (!ids.length) { alert('No hay clases futuras para eliminar.'); return; }

  const ok = confirm(`¬øEliminar ${ids.length} clases asignadas desde esta semana en adelante?`);
  if (!ok) return;

  try {
    let del = await fetch('/clases', {
      method:'DELETE',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ ids })
    });

    // Fallback si tu backend expone bulk-delete como POST
    if (del.status === 404) {
      del = await fetch('/clases/bulk-delete', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ ids })
      });
    }

    if (!del.ok) {
      const t = await del.text();
      throw new Error(t || 'No se pudo borrar');
    }

    await cargarSemana();
    await cargarSituacionAlumno(alumno_id);
    alert('Clases eliminadas');
  } catch (e) {
    console.error(e);
    alert('Error al eliminar las clases');
  }
}


/* ========================= TEXTO DEL CHIP ============================
   - Si es PRUEBA (sin alumno) muestra el texto de la nota.
   - Si es alumno: "NN Nombre" donde NN puede venir ya con sufijo (02-G, 149-CR)
======================================================================= */
function chipText(cl) {
  const nombrePrueba = (cl.nota || '').trim();
  if ((cl.alumno_id == null || cl.alumno_id === 0) && nombrePrueba) return nombrePrueba;

  const nombre = (cl.nombre || '').trim();

  // Si numero_alumno trae sufijo (02-G / 225-CR), lo dejamos tal cual.
  // Si es solo n√∫mero, lo paddeamos a 2 d√≠gitos.
  let numTxt = '';
  if (cl.numero_alumno != null) {
    const raw = String(cl.numero_alumno).trim();
    numTxt = raw.includes('-') ? raw : String(raw).padStart(2, '0');
  }

  const base = `${numTxt ? (numTxt + ' ') : ''}${nombre}`.trim();
  return base || nombrePrueba || 'Prueba';
}
// aplicar clases visuales seg√∫n estado
function applyEstadoClassToTag(tag, estado){
  tag.classList.remove('estado-asistio','estado-sin-aviso','estado-con-aviso','estado-sobre-hora');
  if (!estado) return;
  if (estado==='asistio')     tag.classList.add('estado-asistio');
  if (estado==='sin_aviso')   tag.classList.add('estado-sin-aviso');
  if (estado==='con_aviso')   tag.classList.add('estado-con-aviso');
  if (estado==='sobre_hora')  tag.classList.add('estado-sobre-hora');
}

let quickMenu=null, quickMenuTarget=null;

function initQuickMenu(){
  if (quickMenu) return;
  quickMenu = document.createElement('div');
  quickMenu.id = 'quickMenu';
  quickMenu.className = 'quick-menu';
  quickMenu.innerHTML = `
    <div class="item asistio"    data-estado="asistio"><span class="dot"></span>Asisti√≥</div>
    <div class="item sin_aviso"  data-estado="sin_aviso"><span class="dot"></span>Ausente sin aviso</div>
    <div class="item con_aviso"  data-estado="con_aviso"><span class="dot"></span>Ausente con aviso</div>
    <div class="item sobre_hora" data-estado="sobre_hora"><span class="dot"></span>Ausente sobre la hora</div>
    <div class="sep"></div>
    <div class="item" data-estado="">Limpiar estado</div>
  `;
  document.body.appendChild(quickMenu);

  quickMenu.addEventListener('click', async (e)=>{
  const it = e.target.closest('.item'); if (!it) return;
  const estado = it.dataset.estado ?? '';

  if (quickMenuTarget){
    // 1) actualizar dataset
    quickMenuTarget.dataset.estado = estado;

    // 2) SIEMPRE limpiar/aplicar clases de estado
    applyEstadoClassToTag(quickMenuTarget, estado);

    // 3) si qued√≥ sin estado, volver al color por tipo (normal/prueba/recuperaci√≥n)
    if (!estado) applyTipoColorToTag(quickMenuTarget);

    // 4) cache y persistencia
    const id = parseInt(quickMenuTarget.dataset.id,10) || 0;
    const row = clasesSemana.find(c => c.id === id);
    if (row) row.estado = estado || null;

    if (id){
      try{
        const r = await fetch(`/clases/${id}`,{
          method:'PATCH',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ estado: estado || null })
        });
        if (!r.ok) console.error('PATCH estado fall√≥', await r.text());
      }catch(err){ console.error(err); }
    }
  }
  closeQuickMenu();
});


  // cerrar si clic fuera / scroll / resize / ESC
  document.addEventListener('click',(ev)=>{
    if (quickMenu && quickMenu.style.display==='block'){
      if (!quickMenu.contains(ev.target)) closeQuickMenu();
    }
  }, true);
  window.addEventListener('scroll', closeQuickMenu, true);
  window.addEventListener('resize', closeQuickMenu, true);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeQuickMenu(); });
}

// Cierra si clic fuera del men√∫ y del trigger
function onDocClose(e){
  if (!quickMenu) return;
  if (quickMenu.contains(e.target)) return;
  if (quickMenuTarget && quickMenuTarget.contains(e.target)) return;
  quickMenu.style.display = 'none';
}

function openQuickMenu(target){
  initQuickMenu();
  quickMenuTarget = target;

  // evitar cierre inmediato por el mismo click
  if (window._qmListening){ 
    document.removeEventListener('mousedown', onDocClose, true);
    window._qmListening = false;
  }

  // evitar que el click del chip burbujee
  // (pon√© este handler tambi√©n donde cre√°s cada chip si prefer√≠s)
  target.addEventListener('mousedown', ev => {
    ev.preventDefault();
    ev.stopPropagation();
  }, { once:true });

  quickMenu.style.display = 'block';
  quickMenu.classList.remove('drop-up');

  const r  = target.getBoundingClientRect();           // coords viewport
  const vw = document.documentElement.clientWidth;
  const vh = document.documentElement.clientHeight;

  const menuW = Math.min(quickMenu.offsetWidth || 240, 300);
  const menuH = quickMenu.offsetHeight || 220;

  // LEFT: clamp al viewport
  let left = r.left;
  if (left + menuW > vw - 8) left = vw - menuW - 8;
  if (left < 8) left = 8;
  quickMenu.style.left = left + 'px';

  // TOP: abre arriba si no entra abajo
  const spaceBelow = vh - r.bottom;
  const spaceAbove = r.top;
  const m = 6;

  let top;
  if (spaceBelow < menuH + m && spaceAbove > spaceBelow){
    quickMenu.classList.add('drop-up');
    top = Math.max(8, r.top - menuH - m);
  } else {
    quickMenu.classList.remove('drop-up');
    top = Math.min(vh - menuH - 8, r.bottom + m);
  }
  quickMenu.style.top = top + 'px';

  // activar listener global DESPU√âS de abrir
  setTimeout(() => {
    document.addEventListener('mousedown', onDocClose, true);
    window._qmListening = true;
  }, 0);
}

function closeQuickMenu(){
  if (quickMenu) quickMenu.style.display='none';
  quickMenuTarget = null;
}

/* Aplica color por tipo s√≥lo cuando NO hay estado */
function applyTipoColorToTag(tag){
  const tipo = (tag.dataset.tipo || '').toLowerCase();
  tag.classList.remove('is-primary','is-link','is-info','is-success','is-warning','is-danger','tag-prueba','tag-recuperacion');
  tag.style.removeProperty('background-color');
  tag.style.removeProperty('color');

  if (tipo === 'prueba'){
    tag.classList.add('tag-prueba');
    tag.style.setProperty('background-color', '#8e44ad', 'important');
    tag.style.setProperty('color', '#fff', 'important');
  } else if (tipo === 'recuperacion'){
    tag.classList.add('tag-recuperacion');
    tag.style.setProperty('background-color', '#c62828', 'important');
    tag.style.setProperty('color', '#fff', 'important');
  }
}

/* Click en un tag: abrir men√∫ r√°pido */
function onTagClick(e){
  e.stopPropagation();
  openQuickMenu(e.currentTarget);
}


/* ===== Pintar ===== */
function pintarClases(){
  // limpiar chips
  document.querySelectorAll('td.slot .left, td.slot .right').forEach(n => n.innerHTML = '');

  // feriados a Set
  const feriadosSet = new Set((feriados || []).map(f => String(f).slice(0,10)));

  // agrupar clases por (fecha|hora|sede)
  const mapa = new Map();
  for (const c of (clasesSemana || [])){
    const sede  = (c.sede || '').trim();
    const fecha = String(c.fecha).slice(0,10);
    const hora  = normTime(c.hora); // HH:MM:SS
    const key   = `${fecha}|${hora}|${sede}`;
    (mapa.get(key) || mapa.set(key, []).get(key)).push({ ...c, hora });
  }

  // sede activa por si la celda no trae data-sede
  const sedeActiva =
    (window.sedeActiva || window.sedeSel || window.sede || '').toString().trim() ||
    (document.querySelector('.sedes .is-selected, .sedes .selected')?.textContent || '').trim();

  // recorrer celdas
  document.querySelectorAll('td.slot').forEach(td => {
    const fechaTd = String(td.dataset.fecha || '').slice(0,10);
    const horaTd  = normTime(String(td.dataset.hora || ''));
    const sedeTd  = String(td.dataset.sede || sedeActiva || '').trim();
    const dowTd   = (typeof dowFromYMD === 'function') ? dowFromYMD(fechaTd) : null;

    // reset fondo
    td.classList.remove('feriado');

    // feriado (todo el d√≠a)
    if (feriadosSet.has(fechaTd)) {
      td.classList.add('feriado');
    } else {
     // BLOQUES SIN CLASE (coincidencia robusta por sede/d√≠a/hora)
const bloques = (Array.isArray(noClases) && noClases.length)
  ? noClases
  : (Array.isArray(window.noClases) ? window.noClases : []);

const bloqueado = bloques.some(nc => {
  const sameDow  = Number(nc.dow) === Number(dowTd);
  const sameHora = normTime(nc.hora) === horaTd;        // 'HH:MM:SS'
  const sameSede = !nc.sede || !sedeTd || normSede(nc.sede) === normSede(sedeTd);
  return sameDow && sameHora && sameSede;
});
if (bloqueado) td.classList.add('feriado');


    } // üëà cierre del else

    // chips de clases
    const key   = `${fechaTd}|${horaTd}|${sedeTd}`;
    const arr   = mapa.get(key) || [];
    const left  = td.querySelector('.left');
    const right = td.querySelector('.right');

    arr.forEach((cl, idx) => {
      const tag = document.createElement('div');
      tag.className = 'tag is-clickable';
      tag.textContent = chipText(cl);

      // datasets
      tag.dataset.id       = (cl.id != null) ? String(cl.id) : '';
      tag.dataset.estado   = cl.estado || '';
      tag.dataset.nombre   = ((cl.nombre || cl.nota || '') + '').trim();
      tag.dataset.numero   = (cl.numero_alumno != null) ? String(cl.numero_alumno).padStart(2,'0') : '';
      tag.dataset.alumnoId = (cl.alumno_id != null) ? String(cl.alumno_id) : '';
      tag.dataset.fecha    = cl.fecha || '';
      tag.dataset.hora     = cl.hora  || '';
      tag.dataset.sede     = cl.sede  || '';

      // motivo/tooltip
      let motivo = '';
      if (cl.observacion && String(cl.observacion).trim()) motivo = String(cl.observacion).trim();
      else if (cl.motivo && String(cl.motivo).trim())      motivo = String(cl.motivo).trim();
      else if (cl.nota && String(cl.nota).trim())          motivo = String(cl.nota).trim();
      tag.dataset.observacion = motivo;

      // estado y tipo
      applyEstadoClassToTag(tag, tag.dataset.estado);
      const tipo = cl.tipo ?? (
        cl.es_prueba ? 'prueba'
        : (cl.unica_vez || cl.es_recuperacion ? 'recuperacion'
        : (!cl.alumno_id && cl.nota ? 'prueba' : 'normal'))
      );
      tag.dataset.tipo = tipo;
      if (!tag.dataset.estado) applyTipoColorToTag(tag);

      // tooltip custom (sin title nativo)
      if ((String(tipo).toLowerCase()==='prueba' || !cl.alumno_id) && motivo){
        tag.removeAttribute('title');
        tag.classList.add('has-tooltip');
        tag.dataset.tooltip = `Observaci√≥n: ${motivo}`;
        tag.setAttribute('aria-label', `Observaci√≥n: ${motivo}`);
      }

      tag.addEventListener('click', onTagClick);
      tag.addEventListener('dblclick', onTagDblClick);
      (idx % 2 === 0 ? left : right).appendChild(tag);
    });
  }); // üëà cierre del forEach(td => { ‚Ä¶ })

  // Forzar lila m√°s visible en 'prueba' sin estado (fuera del loop)
  document.querySelectorAll(
    '.tag[data-tipo="prueba"]:not([data-estado]), .tag[data-tipo="prueba"][data-estado=""]'
  ).forEach(el => {
    el.classList.remove('tag-prueba');
    el.style.setProperty('background-color', '#E6D1FF', 'important');
    el.style.setProperty('border-color',     '#CDB8FF', 'important');
    el.style.setProperty('color',            '#3b2b72', 'important');
    el.style.setProperty('background-image', 'none', 'important');
  });
} // üëà cierre de la funci√≥n

let claseSelId = null;
let claseSelTag = null;

function onTagDblClick(e){
  e.stopPropagation();
  const tag = e.currentTarget;

  // guardar refs para guardar/eliminar
  claseSelTag = tag;
  claseSelId  = parseInt(tag.dataset.id, 10) || null;

  // T√≠tulo arriba del modal: n√∫mero + "Nombre (prueba)" si lo hubiera
  var nombre = tag.dataset.nombre || tag.textContent || '';
  var numero = tag.dataset.numero || '';
  document.getElementById('claseInfo').textContent =
    (numero ? (numero + ' ¬∑ ') : '') + nombre;

  // Estado (checks exclusivos)
  var estado = tag.dataset.estado || '';
  chkAsistio.checked   = (estado === 'asistio');
  chkSinAviso.checked  = (estado === 'sin_aviso');
  chkConAviso.checked  = (estado === 'con_aviso');
  chkSobreHora.checked = (estado === 'sobre_hora');

 // Observaci√≥n
var obs = (tag.dataset.observacion || '').trim();

// √öltimo recurso: buscar en cache por id
if (!obs) {
  var idSel = parseInt(tag.dataset.id, 10) || 0;
  if (idSel) {
    try {
      var cache = JSON.parse(localStorage.getItem('motivos_prueba') || '{}');
      if (cache[String(idSel)]) obs = String(cache[String(idSel)]);
    } catch(e){}
  }
}
document.getElementById('observacionClase').value = obs;


  // abrir modal
  overlayClase.style.display = 'flex';
}


async function guardarEstadoClase(){
  // √∫nico estado seleccionado (o ninguno para limpiar)
  var estado = '';
  if (chkAsistio.checked)        estado = 'asistio';
  else if (chkSinAviso.checked)  estado = 'sin_aviso';
  else if (chkConAviso.checked)  estado = 'con_aviso';
  else if (chkSobreHora.checked) estado = 'sobre_hora';

  // Observaci√≥n (nota de prueba o comentario)
  var obsEl = document.getElementById('observacionClase');
  var observacion = obsEl ? obsEl.value : '';

  // Buscar la clase en cache para saber el tipo
  var it = null;
  for (var i = 0; i < clasesSemana.length; i++) {
    if (Number(clasesSemana[i].id) === Number(claseSelId)) { it = clasesSemana[i]; break; }
  }
  var tipo = it ? (it.tipo || '') : '';

  // ==== UI inmediata
  if (claseSelTag){
    claseSelTag.dataset.estado = estado;
    if (tipo === 'prueba') {
      claseSelTag.dataset.observacion = observacion;
      // cache persistente del motivo por id
      try {
        var cache = JSON.parse(localStorage.getItem('motivos_prueba') || '{}');
        cache[String(claseSelId)] = observacion || '';
        localStorage.setItem('motivos_prueba', JSON.stringify(cache));
      } catch(e){}
    } else {
      claseSelTag.dataset.nota = observacion || '';
    }
    applyEstadoClassToTag(claseSelTag, estado);
  }

  // ==== Cache en memoria
  if (it){
    it.estado = estado || null;
    if (tipo === 'prueba') it.observacion = observacion || '';
    else it.nota = observacion || '';
  }

  try{
    if (claseSelId){
      // intenta PATCH /clases/:id con estado + observacion
      var r = await fetch('/clases/' + claseSelId, {
        method: 'PATCH',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          estado: estado || null,
          observacion: observacion   // 
        })
      });

      // fallback POST /clases/estado si el PATCH no existe
      if (!r.ok){
        r = await fetch('/clases/estado', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            id: claseSelId,
            estado: estado || null,
            observacion: observacion
          })
        });
        if (!r.ok) throw new Error('No se pudo guardar el estado/observaci√≥n');
      }
    }
    cerrarModalClase();
  } catch(err){
    console.error(err);
    alert('No se pudo guardar el estado/observaci√≥n');

    // rollback visual si fall√≥
    if (claseSelTag){
      var prevEstado = it ? (it.estado || '') : '';
      var prevObs    = '';
      if (it){
        prevObs = (tipo === 'prueba')
          ? (it.observacion || '')
          : (it.nota || '');
      }
      claseSelTag.dataset.estado = prevEstado;
      if (tipo === 'prueba') claseSelTag.dataset.observacion = prevObs;
      else claseSelTag.dataset.nota = prevObs;
      applyEstadoClassToTag(claseSelTag, prevEstado);
    }
  }
}

// (si no lo ten√≠as ya exportado)
window.guardarEstadoClase = guardarEstadoClase;



function onSlotDblClick(e){
  const td = e.currentTarget;
  const fecha = td.dataset.fecha;
  const hora  = normTime(td.dataset.hora);
  const sede  = (td.dataset.sede||'').trim();

  // abrir y preparar modal
  abrirModal();

  // setear sede y reconstruir combos de horas/d√≠as
  selectSede.value = sede;
  onSedeChange(); // llama a refrescarDiasYHoras internamente

  // preseleccionar "√∫nica vez" (pod√©s cambiar a 'prueba' si quer√©s)
  chkUnica.checked = true;
  chkPrueba.checked = false;
  toggleModo('unica');

  // precargar fecha/hora en ambas secciones (por si cambi√°s de modo)
  fechaUnica.value   = fecha;
  horaUnica.value    = hora;
  fechaPrueba.value  = fecha;
  horaPrueba.value   = hora;
}



/* ===== Modal helpers ===== */
function selectedDOWs(){return Array.from(document.querySelectorAll('#chipsDias .chip.selected')).map(ch=>parseInt(ch.dataset.dow,10))}
function applySedeToSelectedDays(){
  const sede=selectSede.value;if(!sede)return;
  selectedDOWs().forEach(d=>{
    const row=[...document.querySelectorAll('#perDia > div')].find(el=>parseInt(el.dataset.dow,10)===d);
    if(row){const selects=row.querySelectorAll('select'); if(selects[1]) selects[1].value=sede;}
  });
}
function applyHoraToSelectedDays(){
  const horaGen = document.getElementById('selectHoraGeneral').value;
  const seleccionados = selectedDOWs();
  if (!horaGen || seleccionados.length === 0) return; // <-- si no hay d√≠as, no hace nada

  seleccionados.forEach(d=>{
    const row = Array.from(document.querySelectorAll('#perDia > div'))
      .find(el => parseInt(el.dataset.dow,10) === d);
    if (!row) return;
    const selHora = row.querySelector('select'); // primer select (hora)
    if (selHora) selHora.value = horaGen;
  });
}
function onSedeChange(){refrescarDiasYHoras();applySedeToSelectedDays();applyHoraToSelectedDays()}

function refrescarDiasYHoras(){
  const sede = selectSede.value, cont = chipsDias, selGen = selectHoraGeneral, perDia = perDiaDiv;

  // reset
  cont.innerHTML = '';
  selGen.innerHTML = '<option value="">Seleccionar hora...</option>';
  perDia.innerHTML = '';

  if (!sede){
    horaUnica.innerHTML  = '<option value="">Seleccionar hora...</option>';
    horaPrueba.innerHTML = '<option value="">Seleccionar hora...</option>';
    return;                    // ‚úÖ cerramos el if ac√°
  }

  // chips de d√≠as
  const dias = diasHabilitados(sede);
  dias.forEach(d=>{
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.dataset.dow = d;
    chip.textContent = DIAS[d];
    chip.onclick = ()=>{
      chip.classList.toggle('selected');
      applySedeToSelectedDays();
      applyHoraToSelectedDays(); // solo aplica si hay d√≠as seleccionados
    };
    cont.appendChild(chip);
  });

  // opciones de hora general
  const horas = rangoHoras(sede);
  horas.forEach(h=>{
    const o = document.createElement('option');
    o.value = normTime(h);
    o.textContent = h;
    selGen.appendChild(o);
  });

  // filas por d√≠a (hora + sede editables)
  dias.forEach(d=>{
    const wrap  = document.createElement('div'); wrap.style.marginTop='6px'; wrap.dataset.dow = d;
    const label = document.createElement('label'); label.textContent = `${DIAS[d]}: `; label.style.marginRight='6px';

    const selHora = document.createElement('select');
    const defH = document.createElement('option'); defH.value=''; defH.textContent='Seleccionar hora...'; selHora.appendChild(defH);
    horas.forEach(h=>{ const o=document.createElement('option'); o.value=normTime(h); o.textContent=h; selHora.appendChild(o); });

    const selSede = document.createElement('select');
    ['Craig Reformer','Craig Circuito','Pedro Goyena'].forEach(s=>{ const o=document.createElement('option'); o.textContent=s; selSede.appendChild(o); });
    selSede.value = sede;

    wrap.appendChild(label);
    wrap.appendChild(selHora);
    wrap.appendChild(document.createTextNode(' '));
    wrap.appendChild(selSede);
    perDia.appendChild(wrap);
  });

  // √önica / Prueba
  horaUnica.innerHTML  = '<option value="">Seleccionar hora...</option>';
  horas.forEach(h=>{ const o=document.createElement('option'); o.value=normTime(h); o.textContent=h; horaUnica.appendChild(o); });
  horaPrueba.innerHTML = '<option value="">Seleccionar hora...</option>';
  horas.forEach(h=>{ const o=document.createElement('option'); o.value=normTime(h); o.textContent=h; horaPrueba.appendChild(o); });

  // Propagar sede a d√≠as seleccionados (si hay)
  applySedeToSelectedDays();

  // Propagar hora general SOLO si hay d√≠as seleccionados
  const hGen = selectHoraGeneral.value;
  if (hGen && selectedDOWs().length) applyHoraToSelectedDays();
}


// Cupo ilimitado: nunca bloquea
function cupoDisponible(fecha, hora, sede){
  return Number.POSITIVE_INFINITY;
}

// Genera todas las fechas (YYYY-MM-DD) desde la semana visible hasta fin de a√±o
// para el d√≠a de la semana indicado (1=Lun ... 7=Dom)
function fechasHastaFinDeAnio(dow){
  const fin = new Date(semanaInicio.getFullYear(), 11, 31);
  let first = addDays(semanaInicio, dow - 1);
  const hoy = new Date(); hoy.setHours(0,0,0,0);
  if (first < hoy) first = addDays(first, 7);

  const out = [];
  for (let d = first; d <= fin; d = addDays(d, 7)) {
    out.push(ymd(d));
  }
  return out;
}


/* ===== Guardar ===== */
function guardarClase(){
  const esRecuperacion = chkUnica.checked;   // "Clase de Recuperaci√≥n"
  const esPrueba       = chkPrueba.checked;

  // alumno_id solo si NO es prueba
  let alumno_id = null;
  if (!esPrueba){
    alumno_id = parseInt(selectAlumno.value, 10);
    if (!alumno_id){ 
      alert('Seleccion√° una alumna/o'); 
      return; 
    }
  }

  let clases = [];

  // === Clase de RECUPERACI√ìN (antes √∫nica vez) ===
  if (esRecuperacion){
    const sede  = (selectSede.value || '').trim(); 
    if (!sede){ alert('Seleccion√° una sede'); return; }

    const fecha = fechaUnica.value;
    const hora  = normTime(horaUnica.value);
    if (!fecha || !hora){ 
      alert('Complet√° fecha y hora'); 
      return; 
    }

    clases.push({ fecha, hora, sede, tipo: 'recuperacion' });
  }

  // === Clase de PRUEBA (sin alumno) ===
  else if (esPrueba){
    const sede   = (selectSede.value || '').trim(); 
    if (!sede){ alert('Seleccion√° una sede'); return; }

    const fecha  = fechaPrueba.value;
    const hora   = normTime(horaPrueba.value);
    var elNombre = document.getElementById('nombrePrueba');
var elNota   = document.getElementById('notaPrueba');
const nombre = (elNombre ? elNombre.value : '').trim();
const nota   = (elNota   ? elNota.value   : '').trim();

    if (!fecha || !hora){ alert('Complet√° fecha y hora'); return; }
    if (!nombre){ alert('Ingres√° el nombre de la persona'); return; }

    // nota = nombre visible del chip; observacion = motivo
    clases.push({ fecha, hora, sede, nota: nombre, observacion: nota, tipo: 'prueba' });
  }

  // === Clase RECURRENTE (normal) ===
  else {
    const sedeBase = (selectSede.value || '').trim();
    if (!sedeBase){ alert('Seleccion√° una sede'); return; }

    const seleccionados = selectedDOWs();
    if (seleccionados.length === 0){ alert('Seleccion√° al menos un d√≠a'); return; }

    // 1) patrones nuevos
    const nuevos = [];
    for (const d of seleccionados){
      const row = [...document.querySelectorAll('#perDia > div')].find(el => parseInt(el.dataset.dow,10) === d);
      const selects = row ? row.querySelectorAll('select') : null;
      const hora = normTime(selects && selects[0] ? selects[0].value : '');
      const sede = ((selects && selects[1]) ? selects[1].value : sedeBase).trim();
      if (!hora){ alert('Complet√° la hora para los d√≠as seleccionados'); return; }
      nuevos.push({ dow:d, hora, sede });
    }

    // 2) patrones actuales
    const actualesSet = new Set();
    for (const c of clasesAlumnoActual){
      actualesSet.add(groupKey(dowNumFromYMD(c.fecha), c.hora, c.sede));
    }

    // 3) a eliminar
    const nuevosSet = new Set(nuevos.map(p => groupKey(p.dow, p.hora, p.sede)));
    const patronesAEliminar = [...actualesSet].filter(k => !nuevosSet.has(k));
    const idsAEliminar = clasesAlumnoActual
      .filter(c => patronesAEliminar.includes(groupKey(dowNumFromYMD(c.fecha), c.hora, c.sede)))
      .map(c => c.id);

    // 4) a insertar
    const clasesNuevas = [];
    for (const p of nuevos){
      for (const f of fechasHastaFinDeAnio(p.dow)){
        clasesNuevas.push({ fecha:f, hora:p.hora, sede:p.sede });
      }
    }

    if (clasesNuevas.length===0 && idsAEliminar.length===0){
      alert('No hay cambios para aplicar.'); 
      return;
    }

    // 5) ejecutar
    (async ()=>{
      try{
        if (idsAEliminar.length){
          let del = await fetch('/clases', {
            method:'DELETE',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ ids: idsAEliminar })
          });
          if (del.status === 404){
            del = await fetch('/clases/bulk-delete', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ ids: idsAEliminar })
            });
          }
          if (!del.ok) throw new Error('No se pudieron borrar las clases anteriores');
        }

        if (clasesNuevas.length){
          const res = await fetch('/clases', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ alumno_id, clases: clasesNuevas })
          });
          if (!res.ok) throw new Error('No se pudieron crear las clases nuevas');
        }

        cerrarModal();
        await cargarSemana();
        await cargarSituacionAlumno(alumno_id || 0);
        alert('Cambios aplicados');
      }catch(e){
        console.error(e);
        alert(e.message || 'Error al guardar cambios');
      }
    })();

    return; // termina rama recurrente
  }

  // === Guardado para PRUEBA o RECUPERACI√ìN ===
  (async ()=>{
    try{
      const res = await fetch('/clases', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ alumno_id, clases })
      });
      if (!res.ok) throw new Error('No se pudo registrar la clase');

      // Intentar leer respuesta
      let data; try { data = await res.json(); } catch {}
      let creadas = [];
      if (Array.isArray(data)) {
        creadas = data;
      } else if (data && typeof data === 'object') {
        creadas = [data];
      }

      // Datos del alumno para pintar correctamente (recuperaci√≥n)
      const listaAlumnos = (window.alumnosGlobal || window.alumnos || []);
      const alum = listaAlumnos.find(a => Number(a.id) === Number(alumno_id));
      const displayNombre = alum ? `${alum.apellido || ''} ${alum.nombre || ''}`.trim() : '';
      const numeroAlumno  = alum && alum.numero_alumno != null ? alum.numero_alumno : null;


      // Si no vino nada √∫til del backend, recargamos semana
      if (creadas.length === 0 || creadas.every(c => c.id == null)) {
        cerrarModal();
        await cargarSemana();
        return;
      }

      // Insertar en cache local
      const tipoLocal  = clases[0]?.tipo || null; // üëà 'recuperacion' o 'prueba'
      const baseSede   = (selectSede.value || '').trim();
      const fechaLocal = clases[0].fecha;
      const horaLocal  = clases[0].hora;

// cache local de motivos por id (por si el backend no lo devuelve)
var inpNotaPrueba   = document.getElementById('notaPrueba');
var valMotivoPrueba = (inpNotaPrueba ? inpNotaPrueba.value : '').trim();
var cacheMotivos = {};
try { cacheMotivos = JSON.parse(localStorage.getItem('motivos_prueba') || '{}'); } catch(e) { cacheMotivos = {}; }



      for (const c of creadas){
      clasesSemana.push({
  id    : (c.id != null ? c.id : null),
  fecha : normDate(c.fecha || fechaLocal),
  hora  : normTime(c.hora  || horaLocal),
  sede  : (c.sede ? String(c.sede).trim() : baseSede),
  alumno_id,
  nombre: '',                  // prueba no lleva alumno
  numero_alumno: null,
  // Nombre visible del chip (Nombre (prueba))
  nota  : ( (c.nota != null ? c.nota : valNombrePrueba) || '' ).trim(),
  // Motivo/observaci√≥n para el modal
  observacion: ( (c.observacion || c.obs || c.motivo || valMotivoPrueba) || '' ).trim(),
  estado: c.estado || null,
  tipo  : c.tipo || 'prueba'
});



      }

      pintarClases();
      cerrarModal();
    }catch(e){
      console.error(e);
      alert(e.message || 'Error al guardar la clase');
    }
  })();
} // üëà cierre de guardarClase





// Eliminar una clase (la seleccionada en el modal)
window.eliminarClaseSeleccionada = async function (){
  if (!claseSelId){
    alert('No hay una clase seleccionada.');
    return;
  }

  const ok = confirm('¬øEliminar esta clase? Esta acci√≥n no se puede deshacer.');
  if (!ok) return;

  try{
    let r = await fetch(`/clases/${claseSelId}`, { method:'DELETE' });

    if (r.status === 404){
      r = await fetch('/clases', {
        method:'DELETE',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ ids: [claseSelId] })
      });
    }

    if (!r.ok){
      const t = await r.text();
      throw new Error(t || 'No se pudo eliminar la clase');
    }

    clasesSemana = clasesSemana.filter(c => c.id !== claseSelId);
    pintarClases();
    cerrarModalClase();
    alert('Clase eliminada.');
  } catch(err){
    console.error(err);
    alert('Error al eliminar la clase.');
  }
};

// === Modal (exponer en window para que funcionen los onclick del HTML) ===
window.abrirModal = function (){
  overlay.style.display = 'flex';
  buscadorAlumno.value = '';
  selectAlumno.innerHTML = '';
  chkUnica.checked = false;
  chkPrueba.checked = false;
  boxRecurrente.style.display = '';
  boxUnica.style.display = 'none';
  boxPrueba.style.display = 'none';
  selectSede.value = '';
  refrescarDiasYHoras();

  const idSel = parseInt(selectAlumno.value, 10) || 0;
  cargarSituacionAlumno(idSel);
  renderDatosAlumno(idSel);    // <--- NUEVO
};

window.cerrarModal = function (){
  overlay.style.display = 'none';
};

window.toggleModo = function (modo){
  if (modo === 'unica'  && chkUnica.checked)  chkPrueba.checked = false;
  if (modo === 'prueba' && chkPrueba.checked) chkUnica.checked = false;

  const unica  = chkUnica.checked;
  const prueba = chkPrueba.checked;
// ocultar/mostrar la columna izquierda (buscador) seg√∫n sea prueba
const colIzq = document.querySelector('.modal .row > div:first-child');
if (colIzq) colIzq.style.display = (prueba ? 'none' : '');


  boxRecurrente.style.display = (!unica && !prueba) ? '' : 'none';
  boxUnica.style.display      = unica  ? '' : 'none';
  boxPrueba.style.display     = prueba ? '' : 'none';

  refrescarDiasYHoras();
};

const btnEliminar = document.getElementById('btnEliminarClases');
if (btnEliminar){
  btnEliminar.addEventListener('click', eliminarClasesAlumno);
}

const np = document.getElementById('nombrePrueba');
if (np) np.value = '';

const btnEliminarClaseUnica = document.getElementById('btnEliminarClaseUnica');
if (btnEliminarClaseUnica){
  btnEliminarClaseUnica.addEventListener('click', eliminarClaseSeleccionada);
}


/* ===== Init ===== */
async function cargarSemana() {
  actualizarHeader();
  construirTablaBase();
  await cargarFeriados();   // üëà nuevo
  await cargarNoClases();
  await cargarClasesSemana();
  pintarClases();
}

window.addEventListener('load', function () {
  cargarAlumnos()
    .then(() => cargarSemana())
    .catch(console.error);
});


let feriados = [];

async function cargarFeriados() {
  try {
    const res = await fetch('/feriados');
    if (!res.ok) throw new Error(await res.text());
    feriados = await res.json();
    // normalizamos a YYYY-MM-DD
    feriados = feriados.map(f => new Date(f.fecha).toISOString().slice(0,10));
  } catch (err) {
    console.error('Error al cargar feriados', err);
    feriados = [];
  }
}


// Si /alumnos se recarga en alg√∫n momento, reconstruir √≠ndice
// (ya llam√°s cargarAlumnos() al iniciar la p√°gina) :contentReference[oaicite:2]{index=2}



  // refs r√°pidas (evita document.getElementById repetido)
  const overlay=document.getElementById('overlay');
  const selectAlumno=document.getElementById('selectAlumno');
  const buscadorAlumno=document.getElementById('buscadorAlumno');
  const chkUnica=document.getElementById('chkUnica');
  const chkPrueba=document.getElementById('chkPrueba');
  const boxRecurrente=document.getElementById('boxRecurrente');
  const boxUnica=document.getElementById('boxUnica');
  const boxPrueba=document.getElementById('boxPrueba');
  const selectSede=document.getElementById('selectSede');
  const selectHoraGeneral=document.getElementById('selectHoraGeneral');
  selectHoraGeneral.addEventListener('change', applyHoraToSelectedDays);
  const chipsDias=document.getElementById('chipsDias');
  const perDiaDiv=document.getElementById('perDia');
  const fechaUnica=document.getElementById('fechaUnica');
  const horaUnica=document.getElementById('horaUnica');
  const fechaPrueba=document.getElementById('fechaPrueba');
  const horaPrueba=document.getElementById('horaPrueba');
  const notaPrueba=document.getElementById('notaPrueba');
  const id = parseInt(selectAlumno.value, 10) || 0;
  cargarSituacionAlumno(id);
// Refs modal de clase
const chkAsistio  = document.getElementById('chkAsistio');
const chkSinAviso  = document.getElementById('chkSinAviso');
const chkConAviso  = document.getElementById('chkConAviso');
const chkSobreHora = document.getElementById('chkSobreHora');

[chkAsistio, chkSinAviso, chkConAviso, chkSobreHora].forEach((chk, _, arr) => {
  chk.addEventListener('change', (e)=>{
    if (!e.target.checked) return;
    arr.forEach(c => { if (c !== e.target) c.checked = false; });
  });
});


	
selectAlumno.addEventListener('change', () => {
  const id = parseInt(selectAlumno.value, 10) || 0;
  cargarSituacionAlumno(id);
  renderDatosAlumno(id);   // <--- NUEVO
});

function cerrarModalClase() {
  document.getElementById('overlayClase').style.display = 'none';
}

</script>
</body>
</html>
