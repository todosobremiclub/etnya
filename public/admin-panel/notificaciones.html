<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Notificaciones - Etnya</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body { margin:0; font-family:'Inter', sans-serif; background:#cce1d6; color:#444; }

    /* Sidebar */
    .sidebar{
      position:fixed; top:0; left:0; width:200px; height:100vh;
      background:#91586d; padding-top:60px; box-shadow:2px 0 5px rgba(0,0,0,.1); z-index:1000;
    }
    .sidebar a{
      display:block; padding:10px 16px; color:#fff; text-decoration:none; font-weight:bold;
      border-bottom:1px solid rgba(255,255,255,.1); font-size:13px;
    }
    .sidebar a:hover{ background:#6d3e4e; }
    .sidebar a.active{ background:#6d3e4e; }

    /* Header */
    .header-wrap{
      margin-left:200px;
      display:flex; align-items:center; justify-content:center;
      padding:20px 0; transform:translateX(-10px);
    }
    .header-wrap img{ height:60px; margin-right:16px; }
    .header-title{ margin:0; font-size:28px; color:#91586d; }

    /* Responsive sidebar */
    #menuToggle{
      display:none; position:fixed; top:10px; left:10px; z-index:1100;
      background:#91586d; color:#fff; border:none; border-radius:6px; padding:8px 12px; font-size:18px; cursor:pointer;
    }
    @media (max-width:768px){
      #menuToggle{ display:block; }
      .sidebar{ display:none; width:100%; height:auto; position:absolute; top:50px; left:0; }
      .sidebar.mostrar{ display:block; }
      .header-wrap{ margin-left:0; transform:none; }
      main{ margin-left:0; }
    }

    /* Layout general */
    main{ margin-left:200px; padding:20px; }
    .card{
      background:#fff; border-radius:12px; box-shadow:0 1px 6px rgba(0,0,0,.1);
      border:1px solid #eee; padding:16px;
    }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }

    label{ display:block; font-weight:600; margin:12px 0 6px; }
    input[type="text"], textarea{
      width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:14px; background:#fff;
    }
    textarea{ min-height:100px; resize:vertical; }

    .btn{
      border:none; border-radius:6px; padding:8px 14px; font-size:14px; cursor:pointer; font-weight:600;
      background:#91586d; color:#fff;
    }
    .btn.secondary{ background:#b48a99; }
    .btn:hover{ opacity:.9; }

    table{
      width:100%; background:#fff; border-collapse:collapse; border-radius:8px; overflow:hidden;
      box-shadow:0 1px 6px rgba(0,0,0,.08); font-size:14px;
    }
    th, td{ padding:10px; border-bottom:1px solid #eee; text-align:left; vertical-align:top; }
    th{ background:#b48a99; color:#fff; }

    .btn-eliminar {
      background-color: #b75a6d;
      border: none;
      color: white;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      transition: 0.2s;
    }
    .btn-eliminar:hover {
      background-color: #923b4e;
    }
  </style>
</head>
<body>

  <!-- Bot√≥n hamburguesa mobile -->
  <button id="menuToggle" onclick="toggleMenu()">‚ò∞</button>

  
<!-- Sidebar -->
<div class="sidebar">
  <a href="index.html">üìã Alumnas/os</a>
  <a href="pagos.html">üí≥ Pagos</a>
  <a href="gastos.html" class="menu-gastos">üßæ Gastos</a>
  <a href="agenda.html">üìÖ Agenda</a>
  <a href="profesores.html">üë®‚Äçüè´ Profesores</a>
  <a href="noticias.html">üì∞ Noticias</a>
  <a href="notificaciones.html">üì¢ Notificaciones</a>
  <a href="configuracion.html">‚öôÔ∏è Configuraci√≥n</a>
  <a href="reportes.html" class="menu-reportes">üìà Reportes</a>
  <button onclick="cerrarSesion()" style="width:100%; text-align:left; padding:10px 16px; background-color:transparent; border:none; color:white; font-weight:bold; font-size:13px; cursor:pointer; border-top:1px solid rgba(255,255,255,0.1);">
    üö™ Cerrar sesi√≥n
  </button>
</div>


  <!-- Header -->
  <div class="header-wrap">
    <img src="logo.jpeg" alt="Logo">
    <h1 class="header-title">Notificaciones</h1>
  </div>

  <!-- Contenido -->
  <main>
    <div class="grid">
      <!-- Formulario -->
      <section class="card">
        <h2>Enviar notificaci√≥n</h2>
        <label for="titulo">T√≠tulo</label>
        <input type="text" id="titulo" placeholder="T√≠tulo de la notificaci√≥n" required />
        
        <label for="mensaje">Mensaje</label>
        <textarea id="mensaje" placeholder="Escrib√≠ el mensaje..." required></textarea>

        <div class="actions" style="margin-top:10px">
          <button class="btn" id="btnEnviar">Enviar</button>
          <button class="btn secondary" id="btnLimpiar" type="button">Limpiar</button>
        </div>
        <div id="msgForm" class="muted" style="margin-top:8px"></div>
      </section>

      <!-- Historial -->
      <section class="card">
        <div style="display:flex; justify-content:space-between; align-items:center">
          <h2>Historial</h2>
          <button id="btnRefrescar" class="btn secondary" type="button">Refrescar</button>
        </div>
        <table id="tabla-notificaciones">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>T√≠tulo</th>
              <th>Mensaje</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
    </div>
  </main>

  <script>
    // Seguridad m√≠nima igual al resto
    (function(){
      if (localStorage.getItem('etnya_login') !== 'ok') { location = 'login.html'; return; }
    })();

    function cerrarSesion(){
      localStorage.removeItem('etnya_login');
      localStorage.removeItem('etnya_token');
      localStorage.removeItem('etnya_role');
      location = 'login.html';
    }
    function toggleMenu(){ document.querySelector('.sidebar').classList.toggle('mostrar'); }

    // Funci√≥n de fetch con token
    const nativeFetch = window.fetch.bind(window);
    function fetchConToken(url, opts = {}){
      const token = localStorage.getItem('etnya_token') || '';
      const headers = { ...(opts.headers||{}), Authorization:`Bearer ${token}` };
      return nativeFetch(url, { ...opts, headers });
    }

    const API_URL = "/notificaciones";

    // ===============================
    // üîπ Cargar notificaciones
    // ===============================
    async function cargarNotificaciones() {
      const res = await fetchConToken(API_URL);
      const data = await res.json();
      const tbody = document.querySelector('#tabla-notificaciones tbody');
      tbody.innerHTML = '';

      data.forEach(n => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(n.fecha).toLocaleString()}</td>
          <td>${n.titulo}</td>
          <td>${n.mensaje}</td>
          <td style="text-align:center;">
            <button class="btn-eliminar" onclick="eliminarNotificacion(${n.id})">üóëÔ∏è</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ===============================
    // üîπ Eliminar notificaci√≥n
    // ===============================
    async function eliminarNotificacion(id) {
      if (!confirm("¬øSeguro que quer√©s eliminar esta notificaci√≥n?")) return;

      try {
        const res = await fetchConToken(`${API_URL}/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.ok) {
          alert("‚úÖ Notificaci√≥n eliminada correctamente.");
          cargarNotificaciones();
        } else {
          alert("‚ö†Ô∏è " + (data.error || "No se pudo eliminar."));
        }
      } catch (error) {
        console.error("‚ùå Error al eliminar notificaci√≥n:", error);
        alert("Error al intentar eliminar la notificaci√≥n.");
      }
    }

    // ===============================
    // üîπ Enviar notificaci√≥n
    // ===============================
    document.getElementById("btnEnviar").addEventListener("click", async ()=>{
      const titulo = document.getElementById("titulo").value.trim();
      const mensaje = document.getElementById("mensaje").value.trim();
      if (!titulo || !mensaje){ alert("Complet√° todos los campos."); return; }

      const res = await fetchConToken(API_URL + "/enviar", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ titulo, mensaje })
      });
      const data = await res.json();
      if (res.ok){
        alert("‚úÖ Notificaci√≥n enviada correctamente.");
        document.getElementById("titulo").value='';
        document.getElementById("mensaje").value='';
        cargarNotificaciones();
      }else{
        alert("‚ùå Error: "+(data.error||"No se pudo enviar."));
      }
    });

    document.getElementById("btnLimpiar").addEventListener("click", ()=>{
      document.getElementById("titulo").value='';
      document.getElementById("mensaje").value='';
    });
    document.getElementById("btnRefrescar").addEventListener("click", cargarNotificaciones);
    document.addEventListener("DOMContentLoaded", cargarNotificaciones);
  </script>
</body>
</html>
