<!-- COMIENZO: Archivo completo gastos.html con listado agrupado -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gastos - Etnya</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
  body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background-color: #cce1d6;
    color: #444;
  }
  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 200px;
    height: 100vh;
    background-color: #91586d;
    padding-top: 60px;
    box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    z-index: 1000;
  }
  .sidebar a {
    display: block;
    padding: 10px 16px;
    color: white;
    text-decoration: none;
    font-weight: bold;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    font-size: 13px;
  }
  .sidebar a:hover {
    background-color: #6d3e4e;
  }
  #menuToggle {
    display: none;
    position: fixed;
    top: 10px;
    left: 10px;
    z-index: 1100;
    background-color: #91586d;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 18px;
    cursor: pointer;
  }
  main {
    margin-left: 200px;
    padding: 20px;
  }
  @media (max-width: 768px) {
    #menuToggle { display: block; }
    .sidebar { display: none; width: 100%; height: auto; position: absolute; top: 50px; left: 0; }
    .sidebar.mostrar { display: block; }
    main { margin-left: 0; padding: 20px; }
  }
  .formulario {
    max-width: 600px;
    margin: auto;
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.1);
    position: relative;
  }
  .formulario input, .formulario select {
    width: 100%;
    padding: 8px;
    margin: 10px 0;
    border: 1px solid #ccc;
    border-radius: 6px;
  }
  .formulario label { font-weight: bold; }
  .formulario .boton-guardar {
    background-color: #91586d;
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    margin-top: 10px;
  }
  .formulario .cerrar {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    font-size: 20px;
    color: #91586d;
    cursor: pointer;
  }
  table {
    width: 100%;
    max-width: 900px;
    margin: 30px auto;
    background: white;
    border-collapse: collapse;
    box-shadow: 0 1px 6px rgba(0,0,0,0.08);
    border-radius: 8px;
    overflow: hidden;
    font-size: 14px;
  }
  th, td {
    padding: 10px;
    border-bottom: 1px solid #eee;
    text-align: left;
  }
  th { background-color: #b48a99; color: white; }
  h2 { text-align: center; color: #91586d; }

  /* Encabezado Acciones centrado */
  thead th:last-child {
    text-align: center;
  }

  /* Botones de Acciones alineados y juntos */
  td.acciones {
    display: flex;
    gap: 6px;
    justify-content: center;
    align-items: center;
    white-space: nowrap;
  }
  td.acciones button {
    border: none;
    background: none;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: background 0.2s;
    font-size: 15px;
  }
  td.acciones button:hover {
    background-color: rgba(0, 0, 0, 0.05);
  }
  td.acciones button:focus {
    outline: none;
  }
  td.acciones .editar {
    color: #f39c12;
  }
  td.acciones .borrar {
    color: #c0392b;
  }
</style>

</head>
<body>
  <div style="margin-left: 200px;">
    <div style="display: flex; align-items: center; justify-content: center; padding: 20px 0; transform: translateX(-10px);">
      <img src="logo.jpeg" alt="Logo" style="height: 60px; margin-right: 16px;">
      <h2 style="margin: 0; font-size: 28px; color: #91586d;">Gastos Etnya</h2>
    </div>
  </div>
  <button id="menuToggle" onclick="toggleMenu()">‚ò∞</button>
  <div class="sidebar">
    <a href="index.html">üìã Alumnas/os</a>
    <a href="pagos.html">üí≥ Pagos</a>
    <a href="gastos.html" class="menu-gastos">üßæ Gastos</a>
    <a href="agenda.html">üìÖ Agenda</a>
    <a href="configuracion.html">‚öôÔ∏è Configuraci√≥n</a>
    <a href="reportes.html" class="menu-reportes">üìà Reportes</a>
    <button onclick="cerrarSesion()" style="width: 100%; text-align: left; padding: 10px 16px; background-color: transparent; border: none; color: white; font-weight: bold; font-size: 13px; cursor: pointer; border-top: 1px solid rgba(255,255,255,0.1);">
      üö™ Cerrar sesi√≥n
    </button>
  </div>
  <main>
    <div style="text-align: center; margin-bottom: 20px;">
      <button onclick="abrirModal()" style="padding: 10px 20px; background-color: #91586d; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer;">‚ûï Registrar Gasto</button>
    </div>
    <div class="formulario" id="formularioGasto" style="display: none;">
      <button class="cerrar" onclick="cerrarModal()">‚úñ</button>
      <label for="tipoGasto">Tipo de Gasto:</label>
      <select id="tipoGasto"></select>
      <label for="mes">Mes:</label>
      <input type="month" id="mes" required>
      <label for="cuenta">Cuenta:</label>   
      <select id="cuenta"></select>
      <label for="monto">Monto:</label>
      <input type="text" id="monto" placeholder="$ 0.000" oninput="formatearMonto(this)">
      <button class="boton-guardar" onclick="guardarPago()">Guardar</button>
    </div>

    <h2>Gastos Registrados</h2>
        <table>
      <thead>
        <tr>
          <th>Tipo de Gasto</th>
          <th>Cuenta</th>
          <th>Mes</th>
          <th>Monto</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tbodyGastos"></tbody>
    </table>
  </main>
  <script>

 // üîí Chequeo de login/rol
  window.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('etnya_login') !== 'ok') {
      location = 'login.html';
      return;
    }
    const rol = localStorage.getItem('etnya_role');
    // Gastos es solo para admin; si no lo es, redirigimos
    if (rol !== 'admin') {
      alert('No autorizado');
      location = 'index.html';
    }
    // Ocultar men√∫ Reportes/Gastos a operadores (por si se reutiliza HTML)
    if (rol !== 'admin') {
      document.querySelectorAll('.menu-reportes, .menu-gastos')
        .forEach(el => el.style.display = 'none');
    }
  });

  // ‚úÖ Helper para enviar el JWT en cada request
  function fetchConToken(url, opts = {}) {
    const token = localStorage.getItem('etnya_token') || '';
    const headers = { ...(opts.headers || {}), Authorization: `Bearer ${token}` };
    return fetchConToken(url, { ...opts, headers });
  }

let gastosById = {};
let editandoId = null;


  function abrirModal() {
  editandoId = null;
  document.getElementById('tipoGasto').value = '';
  document.getElementById('cuenta').value    = '';
  document.getElementById('mes').value       = '';
  document.getElementById('monto').value     = '';
  document.querySelector('.boton-guardar').textContent = 'Guardar';
  document.getElementById("formularioGasto").style.display = "block";
}


  function cerrarModal() {
  document.getElementById("formularioGasto").style.display = "none";
  document.querySelector('.boton-guardar').textContent = 'Guardar';
  editandoId = null;
}


  function cerrarSesion() {
    localStorage.removeItem('etnya_login');
    window.location.href = 'login.html';
  }

  function toggleMenu() {
    document.querySelector('.sidebar').classList.toggle('mostrar');
  }

  function formatearMonto(input) {
    let valor = input.value.replace(/\D/g, '');
    input.value = valor ? '$ ' + Number(valor).toLocaleString('es-AR') : '';
  }

  async function fetchTiposDeGasto() {
    const res = await fetchConToken('/gastos/tipos-gasto');
    const data = await res.json();
    const select = document.getElementById('tipoGasto');
    select.innerHTML = '<option value="">Seleccionar tipo de gasto</option>';
    data.forEach(g => {
      const option = document.createElement('option');
      option.value = g.nombre;
      option.textContent = g.nombre;
      select.appendChild(option);
    });
  }

 async function guardarPago() {
  const nombre = document.getElementById('tipoGasto').value;
  const mes    = document.getElementById('mes').value;
  const cuenta = document.getElementById('cuenta').value;
  const montoStr = document.getElementById('monto').value.replace(/[^\d]/g, '');
  const monto  = parseFloat(montoStr);

  if (!nombre || !mes || !cuenta || isNaN(monto)) {
    alert('Completa todos los campos correctamente');
    return;
  }

  const body   = { nombre, cuenta, monto, fecha: mes + '-01' };
  const url    = editandoId ? `/gastos/${editandoId}` : '/gastos';
  const method = editandoId ? 'PUT' : 'POST';

  const res = await fetchConToken(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });

  if (res.ok) {
    alert(editandoId ? 'Gasto actualizado' : 'Gasto guardado');
    editandoId = null;
    // reset texto bot√≥n y campos
    document.querySelector('.boton-guardar').textContent = 'Guardar';
    cerrarModal();
    cargarGastosRegistrados();
  } else {
    alert('Error al guardar');
  }
}



  async function cargarGastosRegistrados() {
    const res = await fetchConToken('/gastos/registrados');
    const gastos = await res.json();
    const tbody = document.getElementById("tbodyGastos");
    tbody.innerHTML = '';
gastosById = {};
gastos.forEach(g => gastosById[g.id] = g);


    const agrupados = {};

    gastos.forEach(g => {
      const clave = g.fecha.slice(0, 7); // YYYY-MM exacto
      if (!agrupados[clave]) agrupados[clave] = [];
      agrupados[clave].push(g);
    });

    let grupoIndex = 0;

    for (const mesClave in agrupados) {
      const grupoId = `grupo-${grupoIndex++}`;
      const gastosDelMes = agrupados[mesClave];
      const totalMes = gastosDelMes.reduce((sum, g) => sum + parseFloat(g.monto), 0);
      const mesFormateado = formatearMesTexto(mesClave);

      // Fila agrupadora (desplegable)
      const filaMes = document.createElement("tr");
      filaMes.innerHTML = `
        <td colspan="5" style="font-weight:bold; background:#f6e6ea; cursor:pointer;"
            onclick="toggleGrupo('${grupoId}')">
          üóìÔ∏è ${mesFormateado}
          <span style="float: right;">üí∞ Total: $${totalMes.toLocaleString('es-AR')}</span>
        </td>`;
      tbody.appendChild(filaMes);

      // Filas individuales ocultas por defecto
      gastosDelMes.forEach(g => {
        const tr = document.createElement("tr");
        tr.classList.add(grupoId);
        tr.style.display = "none";
        const mesReal = formatearMesTexto(g.fecha.slice(0, 7));
        tr.innerHTML = `
  <td>${g.nombre}</td>
  <td>${g.cuenta ?? 'Sin cuenta'}</td>
  <td>${mesReal}</td>
  <td>$${parseFloat(g.monto).toLocaleString('es-AR')}</td>
  <td class="acciones">
    <button class="editar" onclick="abrirEditarGasto(${g.id})">‚úèÔ∏è</button>
    <button class="borrar" onclick="eliminarGasto(${g.id})">üóëÔ∏è</button>
  </td>`;

        tbody.appendChild(tr);
      });
    }
  } // ‚Üê cierre correcto de cargarGastosRegistrados()

  function toggleGrupo(grupoId) {
    const filas = document.querySelectorAll(`.${grupoId}`);
    filas.forEach(f => {
      f.style.display = (f.style.display === 'none') ? '' : 'none';
    });
  }

  async function eliminarGasto(id) {
    if (!confirm('¬øEliminar este gasto?')) return;
    const res = await fetchConToken(`/gastos/${id}`, { method: 'DELETE' });
    if (res.ok) cargarGastosRegistrados();
    else alert('Error al eliminar');
  }

  function formatearMesTexto(fechaStr) {
    const [anio, mes] = fechaStr.split("-");
    const nombresMeses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                          "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    return `${nombresMeses[parseInt(mes) - 1]} ${anio}`;
  }

async function fetchCuentas() {
  const res = await fetchConToken('/cuentas');
  const data = await res.json();
  const select = document.getElementById('cuenta');
  select.innerHTML = '<option value="">Seleccionar cuenta</option>';
  data.forEach(c => {
    const option = document.createElement('option');
    option.value = c.nombre;
    option.textContent = c.nombre;
    select.appendChild(option);
  });
}

function abrirEditarGasto(id) {
  const g = gastosById[id];
  if (!g) return;

  editandoId = id;
  // abrir modal
  document.getElementById("formularioGasto").style.display = "block";

  // setear campos
  document.getElementById('tipoGasto').value = g.nombre || '';
  document.getElementById('cuenta').value    = g.cuenta || '';
  document.getElementById('mes').value       = (g.fecha || '').slice(0,7); // YYYY-MM
  document.getElementById('monto').value     = g.monto ? '$ ' + Number(g.monto).toLocaleString('es-AR') : '';

  // cambiar texto del bot√≥n a ‚ÄúActualizar‚Äù
  document.querySelector('.boton-guardar').textContent = 'Actualizar';
}



  window.onload = () => {
    if (localStorage.getItem('etnya_login') !== 'ok') {
      window.location.href = 'login.html';
      return;
    }
    fetchTiposDeGasto();
    fetchCuentas();
    cargarGastosRegistrados();
  };


</script>

</body>
</html>
