<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reportes</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: #cce1d6;
      color: #333;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 200px;
      height: 100vh;
      background-color: #91586d;
      padding-top: 60px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }

    .sidebar a {
      display: block;
      padding: 10px 16px;
      color: white;
      text-decoration: none;
      font-weight: bold;
    }

    .sidebar a:hover {
      background-color: rgba(255,255,255,0.1);
    }

    .contenido {
      margin-left: 210px;
      padding: 20px;
    }

    h2 {
      margin-top: 40px;
      color: #555;
    }

    .bloque-reporte {
      background: white;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 30px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin-top: 10px;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid #ccc;
      text-align: left;
    }

    th {
      background-color: #eee;
    }

@media (max-width: 768px) {
  .sidebar {
    width: 100%;
    height: auto;
    position: relative;
    display: flex;
    flex-wrap: wrap;
    padding-top: 0;
  }

  .sidebar a, .sidebar button {
    flex: 1 0 50%;
    text-align: center;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  .contenido {
    margin-left: 0;
    padding: 16px;
  }

  .bloque-reporte {
    padding: 12px;
    margin-bottom: 20px;
  }

  table {
    display: block;
    width: 100%;
    overflow-x: auto;
    white-space: nowrap;
  }

  th, td {
    font-size: 13px;
  }
}

.hamburguesa {
  display: none;
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 2000;
  font-size: 26px;
  background: transparent;
  color: white;
  border: none;
  cursor: pointer;
}

@media (max-width: 768px) {
  .hamburguesa {
    display: block;
  }

  .sidebar {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background-color: #91586d;
    z-index: 1500;
    flex-direction: column;
  }

  .sidebar.mostrar {
    display: flex;
  }

  .contenido {
    margin-left: 0;
    padding: 70px 16px 16px;
  }
}


  </style>
</head>
<body>

<div style="margin-left: 200px;">
  <div style="
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px 0;
    transform: translateX(-10px);
  ">
    <img src="logo.jpeg" alt="Logo" style="height: 60px; margin-right: 16px;">
    <h2 style="margin: 0; font-size: 28px; color: #91586d;">Reportes Etnya</h2>
  </div>
</div>


<button id="toggleMenu" class="hamburguesa">‚ò∞</button>

  
 <!-- Sidebar -->
  <div class="sidebar">
    <a href="index.html">üìã Alumnas/os</a>
    <a href="pagos.html">üí≥ Pagos</a>
    <a href="gastos.html">üßæ Gastos</a>
    <a href="agenda.html">üìÖ Agenda</a>
    <a href="configuracion.html">‚öôÔ∏è Configuraci√≥n</a>
    <a href="reportes.html">üìà Reportes</a>
    <button onclick="cerrarSesion()" style="width: 100%; text-align: left; padding: 10px 16px; background-color: transparent; border: none; color: white; font-weight: bold; font-size: 13px; cursor: pointer; border-top: 1px solid rgba(255,255,255,0.1);">
      üö™ Cerrar sesi√≥n
    </button>
  </div>



  <div class="contenido">
    

    <div class="bloque-reporte">
  <h2 style="display: flex; justify-content: space-between; align-items: center;">
    <span>1. Monto por cuenta</span>
    <span id="acumulado-anual" style="font-size: 16px; color: #555;"></span>
  </h2>

  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
    <button onclick="cambiarMes(-1)">‚óÄ</button>
    <div id="mes-anio-cuenta" style="font-weight: bold;"></div>
    <button onclick="cambiarMes(1)">‚ñ∂</button>
  </div>

  <div id="reporte-cuenta"></div>
</div>




    <div class="bloque-reporte">
      <h2>2. Monto por mes pagado</h2>
      <div id="reporte-mes-pagado"></div>
    </div>

    <div class="bloque-reporte">
      <h2>3. Monto por fecha de pago</h2>
      <div id="reporte-fecha-pago"></div>
    </div>

   
    <div class="bloque-reporte">
      <h2>4. Alumnos por sede</h2>
      <div id="reporte-alumnos-sede"></div>
    </div>

    <div class="bloque-reporte">
      <h2>5. Alumnos por modalidad</h2>
      <div id="reporte-alumnos-modalidad"></div>
    </div>
  
	
<div class="bloque-reporte">
  <h2>6. Ingresos por mes/a√±o</h2>
  <div id="reporte-ingresos"></div>
  <div id="detalle-ingresos" style="margin-top: 20px;"></div>
</div>
</div>
  <script>

if (localStorage.getItem('etnya_login') !== 'ok') {
    window.location.href = 'login.html';
  }

  function cerrarSesion() {
    localStorage.removeItem('etnya_login');
    window.location.href = 'login.html';
  }


    // Generador de tabla b√°sica
  function renderTabla(idContenedor, columnas, datos) {
  const contenedor = document.getElementById(idContenedor);
  contenedor.innerHTML = '';

  if (!datos.length) {
    contenedor.innerHTML = '<p>No hay datos disponibles.</p>';
    return;
  }

  const tabla = document.createElement('table');
  const thead = document.createElement('thead');
  const tbody = document.createElement('tbody');

  const filaEncabezado = document.createElement('tr');
  columnas.forEach(col => {
    const th = document.createElement('th');
    th.textContent = col;
    filaEncabezado.appendChild(th);
  });
  thead.appendChild(filaEncabezado);

  const camposMonetarios = ['total', 'monto supervisora', 'monto supervisora 2'];

  datos.forEach(row => {
    const tr = document.createElement('tr');
    columnas.forEach(col => {
      const td = document.createElement('td');
      let clave = col.toLowerCase();
      let valor = row[clave] ?? row[col] ?? '-';

      if (camposMonetarios.includes(clave)) {
        const numero = parseFloat(valor);
        if (!isNaN(numero)) {
          valor = `$ ${Math.round(numero).toLocaleString('es-AR')}`;
        }
      }

      td.textContent = valor;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  tabla.appendChild(thead);
  tabla.appendChild(tbody);
  contenedor.appendChild(tabla);
}



    async function cargarReporteCuenta(mes = null, anio = null) {
  try {
    let url = '/reportes/por-cuenta';
    if (mes && anio) {
      url = `/reportes/por-cuenta-filtrado?mes=${mes}&anio=${anio}`;
    }
    const res = await fetch(url);
    const data = await res.json();
    renderTabla('reporte-cuenta', ['Cuenta', 'Total'], data);
  } catch (error) {
    console.error('Error al cargar reporte de cuenta:', error);
  }
}

async function cargarTotalAnual() {
  try {
    const res = await fetch(`/reportes/total-anual-por-cuenta?anio=${anioActual}`);
    const data = await res.json();
    const total = parseFloat(data?.total ?? 0);
    const texto = `$ ${Math.round(total).toLocaleString('es-AR')}`;
    document.getElementById('acumulado-anual').textContent = `Total anual: ${texto}`;
  } catch (error) {
    console.error('Error al cargar total anual:', error);
  }
}



async function cargarReporteMesPagado() {
  try {
    const res = await fetch('/reportes/por-mes-pagado');
    const data = await res.json();
    renderTabla('reporte-mes-pagado', ['Mes', 'Total'], data);
  } catch (error) {
    console.error('Error al cargar reporte por mes pagado:', error);
  }
}

async function cargarReporteFechaPago() {
  try {
    const res = await fetch('/reportes/por-fecha-pago');
    const data = await res.json();
    renderTabla('reporte-fecha-pago', ['Mes', 'Total'], data);
  } catch (error) {
    console.error('Error al cargar reporte por fecha de pago:', error);
  }
}

async function cargarReporteAlumnosSede() {
  try {
    const res = await fetch('/reportes/alumnos-por-sede');
    const data = await res.json();
    renderTabla('reporte-alumnos-sede', ['Sede', 'Cantidad'], data);
  } catch (error) {
    console.error('Error al cargar reporte de alumnos por sede:', error);
  }
}

async function cargarReporteAlumnosModalidad() {
  try {
    const res = await fetch('/reportes/alumnos-por-modalidad');
    const data = await res.json();

    const contenedor = document.getElementById('reporte-alumnos-modalidad');
    contenedor.innerHTML = '';

    const tabla = document.createElement('table');
    const thead = tabla.createTHead();
    thead.innerHTML = '<tr><th>Modalidad</th><th>Cantidad</th></tr>';
    const tbody = document.createElement('tbody');

    data.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="cursor:pointer; color:#91586d; text-decoration:underline;"
            onclick="verDetalleModalidad('${row.modalidad}')">${row.modalidad}</td>
        <td>${row.cantidad}</td>
      `;
      tbody.appendChild(tr);
    });

    tabla.appendChild(tbody);
    contenedor.appendChild(tabla);
  } catch (error) {
    console.error('Error al cargar reporte de alumnos por modalidad:', error);
  }
}

let mesActual = new Date().getMonth() + 1; // enero = 1
let anioActual = new Date().getFullYear();

const meses = [
  '', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
  'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
];

function actualizarTituloMesAnio() {
  const titulo = document.getElementById('mes-anio-cuenta');
  titulo.textContent = `${meses[mesActual]} ${anioActual}`;
}

function cambiarMes(delta) {
  mesActual += delta;
  if (mesActual < 1) {
    mesActual = 12;
    anioActual -= 1;
  } else if (mesActual > 12) {
    mesActual = 1;
    anioActual += 1;
  }
  actualizarTituloMesAnio();
  cargarReporteCuenta(mesActual, anioActual);
  cargarTotalAnual(); // üëà agregado
}


let mesMostrado = null;

function formatearMesYYYYMM(yyyyMM) {
  const [anio, mes] = yyyyMM.split('-');
  const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
  return `${meses[parseInt(mes) - 1]} ${anio}`;
}

async function cargarReporteIngresos() {
  try {
    const res = await fetch('/reportes/ingresos-por-mes');
    const data = await res.json();
    const contenedor = document.getElementById('reporte-ingresos');
    contenedor.innerHTML = '';

    if (!data.length) {
      contenedor.innerHTML = '<p>No hay datos disponibles.</p>';
      return;
    }

    const agrupadoPorAnio = {};
    data.forEach(row => {
      const [anio, mesNum] = row.mes.split('-');
      const mesNombre = formatearMesYYYYMM(row.mes).split(' ')[0];

      if (!agrupadoPorAnio[anio]) agrupadoPorAnio[anio] = [];
      agrupadoPorAnio[anio].push({
        mes: mesNombre,
        mesCompleto: row.mes,
        cantidad: row.cantidad
      });
    });

    for (const anio of Object.keys(agrupadoPorAnio).sort((a, b) => b - a)) {
      const bloque = document.createElement('div');
      bloque.style.marginBottom = '16px';

      const titulo = document.createElement('div');
titulo.innerHTML = `<span class="flecha-anio">‚ñ∂</span> ${anio}`;
titulo.style.color = '#91586d';
titulo.style.cursor = 'pointer';
titulo.style.fontSize = '15px';
titulo.style.fontWeight = '600';
titulo.style.margin = '6px 0';

titulo.onmouseover = () => titulo.style.textDecoration = 'underline';
titulo.onmouseout = () => titulo.style.textDecoration = 'none';


      const tabla = document.createElement('table');
      tabla.innerHTML = '<thead><tr><th>Mes</th><th>Cantidad</th></tr></thead>';
      const tbody = document.createElement('tbody');

      agrupadoPorAnio[anio].forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="cursor:pointer; color:#91586d; text-decoration:underline;"
              onclick="verDetalleIngresos('${row.mesCompleto}')">
            ${row.mes}
          </td>
          <td>${row.cantidad}</td>
        `;
        tbody.appendChild(tr);
      });

      tabla.appendChild(tbody);
      tabla.style.display = 'none';

      titulo.addEventListener('click', () => {
        const visible = tabla.style.display === 'table';
        tabla.style.display = visible ? 'none' : 'table';
        titulo.querySelector('.flecha-anio').textContent = visible ? '‚ñ∂' : 'üîΩ';
      });

      bloque.appendChild(titulo);
      bloque.appendChild(tabla);
      contenedor.appendChild(bloque);
    }
  } catch (err) {
    console.error('Error al cargar reporte de ingresos:', err);
  }
}

    

async function verDetalleIngresos(mes) {
  mesMostrado = mes;
  document.getElementById('modalDetalleIngresos').style.display = 'flex';
  document.getElementById('tituloDetalleIngreso').textContent = `Ingresos en ${formatearMesYYYYMM(mes)}`;

  try {
    const res = await fetch(`/reportes/detalle-ingresos?mes=${mes}`);
    const data = await res.json();

    renderTabla('contenidoDetalleIngreso', ['N√∫mero', 'Nombre', 'Apellido', 'Fecha ingreso'], data);
  } catch (err) {
    console.error('Error al cargar detalle de ingresos:', err);
    document.getElementById('contenidoDetalleIngreso').innerHTML = '<p>Error al cargar datos.</p>';
  }
}

function cerrarDetalleIngresos() {
  mesMostrado = null;
  document.getElementById('modalDetalleIngresos').style.display = 'none';
}

async function verDetalleModalidad(modalidad) {
  document.getElementById('modalDetalleIngresos').style.display = 'flex';
  document.getElementById('tituloDetalleIngreso').textContent = `Alumnos en: ${modalidad}`;

  try {
    const res = await fetch(`/reportes/detalle-modalidad?modalidad=${encodeURIComponent(modalidad)}`);
    const data = await res.json();

    renderTabla('contenidoDetalleIngreso', ['N√∫mero', 'Nombre', 'Apellido'], data);
  } catch (err) {
    console.error('Error al cargar detalle de modalidad:', err);
    document.getElementById('contenidoDetalleIngreso').innerHTML = '<p>Error al cargar datos.</p>';
  }
}



   window.onload = () => {
  actualizarTituloMesAnio();
  cargarReporteCuenta(mesActual, anioActual);
  cargarTotalAnual(); // üëà agregado
  cargarReporteMesPagado();
  cargarReporteFechaPago();
  cargarReporteAlumnosSede();
  cargarReporteAlumnosModalidad();
  cargarReporteIngresos();

};



document.getElementById("toggleMenu").addEventListener("click", () => {
  document.querySelector(".sidebar").classList.toggle("mostrar");
});



  </script>

<div id="modalDetalleIngresos" style="
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background-color: rgba(0,0,0,0.5);
  z-index: 9999;
  justify-content: center;
  align-items: center;
">
  <div style="
    background: white;
    padding: 24px;
    border-radius: 10px;
    width: 90%;
    max-width: 700px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
  ">
    <button onclick="cerrarDetalleIngresos()" style="
      position: absolute;
      top: 10px; right: 10px;
      border: none; background: none;
      font-size: 20px; cursor: pointer;
    ">‚úñ</button>

    <h3 id="tituloDetalleIngreso" style="color: #91586d; margin-top: 0;"></h3>
    <div id="contenidoDetalleIngreso"></div>
  </div>
</div>

</body>
</html>
