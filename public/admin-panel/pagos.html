<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pagos - Etnya</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <!-- Select2 -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: #cce1d6;
      color: #6d6d6d;
    }

    main {
      margin-left: 200px;
      padding: 20px;
    }

    h1, h2 {
      text-align: center;
      color: #91586d;
    }

    .formulario {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.1);
    }

    .formulario input, .formulario select {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .formulario label {
      font-weight: bold;
    }

    .formulario button {
      background-color: #91586d;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
    }

    .formulario button:hover {
      background-color: #6d3e4e;
    }

    table {
      width: 100%;
      max-width: 900px;
      margin: 30px auto;
      background: white;
      border-collapse: collapse;
      box-shadow: 0 1px 6px rgba(0,0,0,0.08);
      border-radius: 8px;
      overflow: hidden;
      font-size: 14px;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }

    th {
      background-color: #b48a99;
      color: white;
    }

    /* Sidebar lateral */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 200px;
      height: 100vh;
      background-color: #91586d;
      padding-top: 60px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      z-index: 1000;
    }

    .sidebar a {
      display: block;
      padding: 10px 16px;
      color: white;
      text-decoration: none;
      font-weight: bold;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 13px;
    }

    .sidebar a:hover {
      background-color: #6d3e4e;
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
      }

      main {
        margin-left: 200px;
        padding: 20px;
        position: relative;
        z-index: 1;
      }
    }
  </style>
</head>
<body>

<div class="sidebar">
  <a href="index.html">üìã Alumnos</a>
  <a href="pagos.html">üí≥ Pagos</a>
  <a href="agenda.html">üìÖ Agenda</a>
  <a href="configuracion.html">‚öôÔ∏è Configuraci√≥n</a>
</div>


  <main>
    <h1>Registrar Pago</h1>
   <div class="formulario">
  <label for="alumno-select">Buscar y seleccionar alumno:</label>
  <select id="alumno-select" style="width: 100%"></select>

  <label for="mesPago">Mes a pagar:</label>
  <input type="month" id="mesPago">

  <label for="modalidad">Modalidad:</label>
  <input type="text" id="modalidad" disabled>

  <label for="monto">Monto:</label>
  <input type="number" id="monto" disabled>

  <label><input type="checkbox" id="parcial"> Pago parcial</label>

  <label for="montoParcial">Monto manual:</label>
  <input type="number" id="montoParcial" disabled style="display: none;">

  <button onclick="guardarPago()">Guardar Pago</button>
</div>


    <h2>Pagos Registrados</h2>
    <table>
      <thead>
        <tr>
          <th>N¬∞ Alumno</th>
          <th>Nombre</th>
          <th>Modalidad</th>
          <th>Mes Pagado</th>
          <th>Monto</th>
          <th>Fecha de Pago</th>
        </tr>
      </thead>
      <tbody id="tbodyPagos"></tbody>
    </table>
  </main>

  <script>

if (localStorage.getItem('etnya_login') !== 'ok') {
    window.location.href = 'login.html';

function normalizarTexto(texto) {
  return texto.toLowerCase().trim().replace(/\s+/g, ' ');
}

  const alumnos = [];
  let tiposClase = [];



  
  // Inicializar Select2 despu√©s de que DOM est√© listo
$(document).ready(() => {
  $('#alumno-select').select2({
    placeholder: "Seleccionar alumno",
    width: '100%'
  });
});
 

 

  document.getElementById("parcial").addEventListener("change", (e) => {
  const montoParcial = document.getElementById("montoParcial");
  montoParcial.disabled = !e.target.checked;
  montoParcial.style.display = e.target.checked ? 'block' : 'none';
});


 async function guardarPago() {
  const alumnoId = $('#alumno-select').val();
  const mes = document.getElementById("mesPago").value;
  let monto = '';

if (document.getElementById("parcial").checked) {
  monto = document.getElementById("montoParcial").value;
  if (!monto || isNaN(monto) || parseFloat(monto) <= 0) {
    alert("Ingres√° un monto parcial v√°lido.");
    return;
  }
} else {
  monto = document.getElementById("monto").value;
}


  if (!alumnoId || !mes || !monto) {
    alert("Faltan datos obligatorios.");
    return;
  }

  const res = await fetch('/pagos', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      alumno_id: alumnoId,
      mes_pagado: mes,
      monto: parseFloat(monto)
    })
  });

  if (res.ok) {
    alert("Pago registrado con √©xito.");
    await cargarPagos();
  } else {
    alert("Error al registrar el pago.");
  }
}


 async function cargarPagos() {
  const res = await fetch('/pagos');
  const pagos = await res.json();
  const tbody = document.getElementById("tbodyPagos");
  tbody.innerHTML = '';

  const pagosAgrupados = {};

  pagos.forEach(p => {
    const alumno = alumnos.find(a => a.id === p.alumno_id);
    if (!alumno) return;

    const key = `${alumno.numero_alumno} - ${alumno.apellido}, ${alumno.nombre}`;
    if (!pagosAgrupados[key]) pagosAgrupados[key] = [];
    pagosAgrupados[key].push({ ...p, alumno });
  });

  let grupoIndex = 0;

  for (const nombreAlumno in pagosAgrupados) {
    const grupoId = `grupo-${grupoIndex++}`;

    // Encabezado clickeable
    const filaTitulo = document.createElement("tr");
    filaTitulo.style.cursor = "pointer";
    filaTitulo.style.backgroundColor = "#f3d6dd";
    filaTitulo.style.fontWeight = "bold";
    filaTitulo.innerHTML = `<td colspan="6" onclick="toggleGrupo('${grupoId}')">${nombreAlumno}</td>`;
    tbody.appendChild(filaTitulo);

   // Filas ocultables
pagosAgrupados[nombreAlumno].forEach(p => {
  const tr = document.createElement("tr");
  tr.classList.add(grupoId);
  tr.style.display = 'none';

  // Convertir aaa-mm a mm/aaaa
  const [a√±o, mes] = p.mes_pagado.split('-');
  const mesFormateado = `${mes}/${a√±o}`;

  // Buscar la modalidad y el precio correspondiente
  const tipo = tiposClase.find(t =>
    t.modalidad.toLowerCase() === p.alumno.tipo_clase.toLowerCase()
  );

  tr.innerHTML = `
    <td>${p.alumno.numero_alumno}</td>
    <td>${p.alumno.nombre} ${p.alumno.apellido}</td>
    <td>${tipo?.modalidad || p.alumno.tipo_clase || '-'}</td>
    <td>$${parseFloat(p.monto).toFixed(2)}</td>
    <td>${mesFormateado}</td>
    <td>${new Date(p.fecha_pago).toLocaleDateString('es-AR')}</td>
  `;
  tbody.appendChild(tr);
});


  }
}



 window.onload = async () => {
  const resAlumnos = await fetch('/alumnos');
  const dataAlumnos = await resAlumnos.json();
  alumnos.push(...dataAlumnos);

  const resTipos = await fetch('/tipos-clase');
  tiposClase = await resTipos.json();

  // üîß ESTA L√çNEA ES CLAVE
  const alumnoSelect = document.getElementById("alumno-select");

  // Cargar opciones en el select
  alumnoSelect.innerHTML = '';
  alumnos.forEach(a => {
    const option = document.createElement("option");
    option.value = a.id;
    option.textContent = `${a.numero_alumno} - ${a.apellido}, ${a.nombre}`;
    alumnoSelect.appendChild(option);
  });

  // Listener para mostrar modalidad y monto
 alumnoSelect.addEventListener("change", () => {
  const id = alumnoSelect.value;
  const alumno = alumnos.find(a => a.id == id);
  if (!alumno) return;

  
const tipo = tiposClase.find(t =>
  normalizarTexto(t.modalidad) === normalizarTexto(alumno.tipo_clase)
);


  document.getElementById("modalidad").value = alumno.tipo_clase || '';
  document.getElementById("monto").value = tipo?.precio || '';
});



  // Activar Select2 y cargar pagos
  $('#alumno-select').trigger('change.select2');
  await cargarPagos();
};

function toggleGrupo(grupoId) {
    const filas = document.querySelectorAll(`.${grupoId}`);
    filas.forEach(f => {
      f.style.display = (f.style.display === 'none') ? '' : 'none';
    });
  }

</script>

</body>
</html>
